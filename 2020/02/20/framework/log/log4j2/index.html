<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <meta name="renderer" content="webkit">
  <meta http-equiv="X-UA-Compatible" content="IE=edge" >
  <link rel="dns-prefetch" href="https://NepenthesZGW.github.io">
  <title>Log4j2日志框架 | 忘忧症的博客</title>
  <meta name="generator" content="hexo-theme-yilia-plus">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  
  <meta name="description" content="log4j2Apache log4j 2 是对log4j的升级版，参考了logback的一些优秀的设计，并且修复了一些问题 ​    异常处理：logback中，appender中的异常不会被应用感知到，但是在log4j中，提供了一些异常处理机制 ​    性能提升：log4j2相较于log4j和logback 都具有明显的性能提升 ​    自动重载配置，参考了logback的设计，当然会提供自">
<meta property="og:type" content="article">
<meta property="og:title" content="Log4j2日志框架">
<meta property="og:url" content="https://nepentheszgw.github.io/2020/02/20/framework/log/log4j2/index.html">
<meta property="og:site_name" content="忘忧症的博客">
<meta property="og:description" content="log4j2Apache log4j 2 是对log4j的升级版，参考了logback的一些优秀的设计，并且修复了一些问题 ​    异常处理：logback中，appender中的异常不会被应用感知到，但是在log4j中，提供了一些异常处理机制 ​    性能提升：log4j2相较于log4j和logback 都具有明显的性能提升 ​    自动重载配置，参考了logback的设计，当然会提供自">
<meta property="og:locale" content="zh">
<meta property="article:published_time" content="2020-02-20T02:28:52.000Z">
<meta property="article:modified_time" content="2020-08-02T13:18:59.697Z">
<meta property="article:author" content="忘忧症">
<meta name="twitter:card" content="summary">
  
    <link rel="alternative" href="/atom.xml" title="忘忧症的博客" type="application/atom+xml">
  
  
    <link rel="icon" href="/img/favicon.ico">
  
  
    <link rel="apple-touch-icon" href="/apple-touch-icon-180x180.png">
  
  <link rel="stylesheet" type="text/css" href="/./main.a5fda8.css">
  <style type="text/css">
    
    #container.show {
      background: linear-gradient(200deg,#a0cfe4,#e8c37e);
    }
  </style>
  

  

  
    
 	  <script src="/lib/clickLove.js"></script>
  
  


  

</head>

<body>
  <div id="container" q-class="show:isCtnShow">
    <canvas id="anm-canvas" class="anm-canvas"></canvas>
    <div class="left-col" q-class="show:isShow">
      


<div class="overlay" style="background: #4d4d4d;"></div>
<div class="intrude-less">
	<header id="header" class="inner">
		<a href="/" class="profilepic">
			<img src="/img/head.jpg" class="js-avatar">
		</a>
		<hgroup>
			<h1 class="header-author"><a href="/">忘忧症</a></h1>
		</hgroup>
		

		<nav class="header-menu">
			<ul>
			
				<li><a href="/" target="_blank">主页</a></li>
			
				<li><a href="/" target="_blank">技术笔记</a></li>
			
				<li><a href="/tags/%E9%9A%8F%E7%AC%94/" target="_blank">随笔</a></li>
			
			</ul>
		</nav>
		<nav class="header-smart-menu">
			
				
					<a q-on="click: openSlider(e, 'innerArchive')" href="javascript:void(0)">所有文章</a>
				
			
				
					<a q-on="click: openSlider(e, 'friends')" href="javascript:void(0)">友链</a>
				
			
				
					<a q-on="click: openSlider(e, 'aboutme')" href="javascript:void(0)">关于我</a>
				
			
		</nav>
		<nav class="header-nav">
			<div class="social">
				
					<a class="github" href="https://github.com/NepenthesZGW" title="GitHub" target="_blank"><i class="icon-github"></i></a>
				
					<a class="gitee" href="#" title="码云" target="_blank"><i class="icon-gitee"></i></a>
				
					<a class="jianshu" href="#" title="简书" target="_blank"><i class="icon-jianshu"></i></a>
				
					<a class="cnblog" href="#" title="博客园" target="_blank"><i class="icon-cnblog"></i></a>
				
			</div>
		
			
			
			
			
			<div>
				<iframe frameborder="no" border="0" marginwidth="0" marginheight="0" width="240" height="86" src="//music.163.com/outchain/player?type=2&id=427142481&auto=1&height=66"></iframe>
			</div>
			
				
				<p style="font-size: 12px;">这似乎是首纯音乐，请尽情的欣赏它吧！<p>
			
		
		</nav>
	</header>		
</div>

    </div>
    <div class="mid-col" q-class="show:isShow,hide:isShow|isFalse">
      
      
      <a class="forkMe" style="position:absolute;z-index:999;top:0;right:0.5em;" 
        href="https://github.com/NepenthesZGW/NepenthesZGW.github.io" target="_blank">
        <img src="/img/forkme.png"
          class="attachment-full size-full" alt="Fork me on GitHub" data-recalc-dims="1"></a>
      
      
<nav id="mobile-nav">
  	<div class="overlay js-overlay" style="background: #4d4d4d"></div>
	<div class="btnctn js-mobile-btnctn">
  		<div class="slider-trigger list" q-on="click: openSlider(e)"><i class="icon icon-sort"></i></div>
	</div>
	<div class="intrude-less">
		<header id="header" class="inner">
			<div class="profilepic">
				<a href="/">
					<img src="/img/head.jpg" class="js-avatar">
				</a>
			</div>
			<hgroup>
			  <h1 class="header-author js-header-author">忘忧症</h1>
			</hgroup>
			
			
			
				
			
				
			
				
			
			
			
			<nav class="header-nav">
				<div class="social">
					
						<a class="github" target="_blank" href="https://github.com/NepenthesZGW" title="GitHub"><i class="icon-github"></i></a>
			        
						<a class="gitee" target="_blank" href="#" title="码云"><i class="icon-gitee"></i></a>
			        
						<a class="jianshu" target="_blank" href="#" title="简书"><i class="icon-jianshu"></i></a>
			        
						<a class="cnblog" target="_blank" href="#" title="博客园"><i class="icon-cnblog"></i></a>
			        
				</div>
			</nav>

			<nav class="header-menu js-header-menu">
				<ul style="width: 70%">
				
				
					<li style="width: 33.333333333333336%"><a href="/">主页</a></li>
		        
					<li style="width: 33.333333333333336%"><a href="/">技术笔记</a></li>
		        
					<li style="width: 33.333333333333336%"><a href="/tags/%E9%9A%8F%E7%AC%94/">随笔</a></li>
		        
				</ul>
			</nav>
		</header>				
	</div>
	<div class="mobile-mask" style="display:none" q-show="isShow"></div>
</nav>

      <div id="wrapper" class="body-wrap">
        <div class="menu-l">
          <div class="canvas-wrap">
            <canvas data-colors="#eaeaea" data-sectionHeight="100" data-contentId="js-content" id="myCanvas1"
              class="anm-canvas"></canvas>
          </div>
          <div id="js-content" class="content-ll">
            <article id="post-framework/log/log4j2" class="article article-type-post " itemscope itemprop="blogPost">
  <div class="article-inner">
    
      <header class="article-header">
  
  
    <h1 class="article-title" itemprop="name">
      Log4j2日志框架
    </h1>
  


  
  
        
        <span id="busuanzi_container_page_pv" style='display:none' class="archive-article-date">
              <i class="icon-smile icon"></i> 阅读数：<span id="busuanzi_value_page_pv"></span>次
        </span>

<a href="/2020/02/20/framework/log/log4j2/" class="archive-article-date">
        <time datetime="2020-02-20T02:28:52.000Z" itemprop="datePublished"><i class="icon-calendar icon"></i>2020-02-20</time>
</a>

  
  
    
<div style="margin-top:10px;">
  <span class="post-time">
    <span class="post-meta-item-icon">
      <!-- fonts.scss -->
      <!-- 百度字体平台:http://fontstore.baidu.com/static/editor/index.html -->
      <i class="icon-statistics"></i>
      <span class="post-meta-item-text"> 字数统计:</span>
      <span class="post-count">19.6k字</span>
    </span>
  </span>

  <span class="post-time">
    &nbsp; | &nbsp;
    <span class="post-meta-item-icon">
      <i class="icon-book icon"></i>
      <span class="post-meta-item-text"> 阅读时长≈</span>
      <span class="post-count">100分</span>
    </span>
  </span>
</div>


  
  </header>
  
  <div class="article-entry" itemprop="articleBody">
    
    <h1 id="log4j2"><a href="#log4j2" class="headerlink" title="log4j2"></a>log4j2</h1><p>Apache log4j 2 是对log4j的升级版，参考了logback的一些优秀的设计，并且修复了一些问题</p>
<p>​    异常处理：logback中，appender中的异常不会被应用感知到，但是在log4j中，提供了一些异常处理机制</p>
<p>​    性能提升：log4j2相较于log4j和logback 都具有明显的性能提升</p>
<p>​    自动重载配置，参考了logback的设计，当然会提供自动刷新参数配置，可以动态修改配置而不需要重启应用</p>
<p>​    无垃圾机制，log4j2 在大部分情况下，都可以使用其设计的一套无垃圾机制，避免频繁的日志收集导致jvm的 gc</p>
<a id="more"></a>

<p>pom.xml</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">&lt;!-- log4j2的门面 --&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">       <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.logging.log4j<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">       <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>log4j-api<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">       <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.13.3<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">   <span class="comment">&lt;!-- log4j2的实现 --&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">       <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.logging.log4j<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">       <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>log4j-core<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">       <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.13.3<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>





<h2 id="名词"><a href="#名词" class="headerlink" title="名词"></a>名词</h2><h3 id="Logger"><a href="#Logger" class="headerlink" title="Logger"></a>Logger</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"> org.apache.logging.log4j</span><br><span class="line">     log4j2他也是一个日志门面，所以也抽象出一个logger接口</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">这是log4j包中的中心接口。除了配置之外，大多数日志记录操作都是通过这个接口完成的。</span></span><br><span class="line"><span class="comment">获取类的记录器的规范方法是通过&#123;@link LogManager\#getLogger（）&#125;。通常，每个类都以其完全限定的类名（通过&#123;@link LogManager#getLogger（）&#125;方法获得时的默认记录器名称）获得自己的记录器。因此，最简单的使用方法如下：</span></span><br><span class="line"><span class="comment">* &lt;pre&gt;&lt;code&gt;</span></span><br><span class="line"><span class="comment"> * public class MyClass &#123;</span></span><br><span class="line"><span class="comment"> //这里其实做了 栈操作，更具运行时的压栈信息找到 当前调用.getLogger()的类</span></span><br><span class="line"><span class="comment"> *     private static final Logger LOGGER = LogManager.getLogger();</span></span><br><span class="line"><span class="comment"> *     // ...</span></span><br><span class="line"><span class="comment"> * &#125;</span></span><br><span class="line"><span class="comment"> * &lt;/code&gt;&lt;/pre&gt;</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">为了便于过滤、搜索、排序等，通常最好为每个类创建记录器，而不是共享记录器。相反，&#123;@link Marker&#125;应该用于共享的、可过滤的标识。</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">对于服务提供者实现，建议扩展AbstractLogger类，而不是直接实现这个接口。</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">从2.4开始，方法被添加到&#123;@code Logger&#125;接口以支持lambda表达式。新方法允许客户端代码延迟地记录消息，而无需显式检查请求的日志级别是否已启用。例如，以前有人会写：</span></span><br><span class="line"><span class="comment"> * &lt;pre&gt;&lt;code&gt;</span></span><br><span class="line"><span class="comment"> * // pre-Java 8 style optimization: explicitly check the log level</span></span><br><span class="line"><span class="comment"> * // to make sure the expensiveOperation() method is only called if necessary</span></span><br><span class="line"><span class="comment"> * if (logger.isTraceEnabled()) &#123;</span></span><br><span class="line"><span class="comment"> *     logger.trace(&amp;quot;Some long-running operation returned &#123;&#125;&amp;quot;, expensiveOperation());</span></span><br><span class="line"><span class="comment"> * &#125;</span></span><br><span class="line"><span class="comment"> * &lt;/code&gt;&lt;/pre&gt;</span></span><br><span class="line"><span class="comment"> 使用lambda表达式可以获得相同的效果：</span></span><br><span class="line"><span class="comment"> </span></span><br><span class="line"><span class="comment">  * &lt;pre&gt;</span></span><br><span class="line"><span class="comment"> * // Java-8 style optimization: no need to explicitly check the log level:</span></span><br><span class="line"><span class="comment"> * // the lambda expression is not evaluated if the TRACE level is not enabled</span></span><br><span class="line"><span class="comment"> * logger.trace(&amp;quot;Some long-running operation returned &#123;&#125;&amp;quot;, () -&amp;gt; expensiveOperation());</span></span><br><span class="line"><span class="comment"> * &lt;/pre&gt;</span></span><br><span class="line"><span class="comment"> </span></span><br><span class="line"><span class="comment"> 注意，虽然提供了&#123;@link messagesupplier&#125;，但是使用&#123;@link supplier&#123;@code Supplier&lt;Message&gt;&#125;&#125;的工作原理是一样的。MessageSupplier在2.6中已被弃用，而在2.8.1中未弃用。这些api的匿名类用法应该更倾向于使用Supplier。</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"> </span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line">     </span><br><span class="line">ExtendedLogger:使用有助于实现或扩展&#123;<span class="meta">@code</span> Logger&#125;的方法扩展&#123;<span class="meta">@code</span> Logger&#125;接口。用户不必使用此接口。</span><br></pre></td></tr></table></figure>

<h4 id="AbstractLogger"><a href="#AbstractLogger" class="headerlink" title="AbstractLogger"></a>AbstractLogger</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">implements ExtendedLogger, LocationAwareLogger, Serializable</span><br><span class="line">LocationAwareLogger:接受调用方的位置的 一个 logger</span><br><span class="line"></span><br><span class="line"><span class="comment">//记录器的基本实现。强烈建议任何记录器实现都扩展这个类。</span></span><br><span class="line"></span><br><span class="line">    </span><br><span class="line"><span class="comment">// 实现注意：这个类中的许多方法都针对性能进行了调整。小心修改！</span></span><br><span class="line">    <span class="comment">// 具体来说，保持热字节码的方法是：</span></span><br><span class="line">    <span class="comment">//这在java7和java8 Hotspot虚拟机 的MaxInlineSize阈值范围内，使这些方法成为立即内联的候选方法，而不是等到它们被指定为“足够热”时才使用。</span></span><br><span class="line">  </span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Marker for flow tracing.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> Marker FLOW_MARKER = MarkerManager.getMarker(<span class="string">"FLOW"</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Marker for method entry tracing.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> Marker ENTRY_MARKER = MarkerManager.getMarker(<span class="string">"ENTER"</span>).setParents(FLOW_MARKER);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Marker for method exit tracing.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> Marker EXIT_MARKER = MarkerManager.getMarker(<span class="string">"EXIT"</span>).setParents(FLOW_MARKER);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Marker for exception tracing.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> Marker EXCEPTION_MARKER = MarkerManager.getMarker(<span class="string">"EXCEPTION"</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Marker for throwing exceptions.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> Marker THROWING_MARKER = MarkerManager.getMarker(<span class="string">"THROWING"</span>).setParents(EXCEPTION_MARKER);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Marker for catching exceptions.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> Marker CATCHING_MARKER = MarkerManager.getMarker(<span class="string">"CATCHING"</span>).setParents(EXCEPTION_MARKER);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * The default MessageFactory class.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> Class&lt;? extends MessageFactory&gt; DEFAULT_MESSAGE_FACTORY_CLASS =</span><br><span class="line">            createClassForProperty(<span class="string">"log4j2.messageFactory"</span>, ReusableMessageFactory<span class="class">.<span class="keyword">class</span>,</span></span><br><span class="line"><span class="class">                    <span class="title">ParameterizedMessageFactory</span>.<span class="title">class</span>)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * The default FlowMessageFactory class.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> Class&lt;? extends FlowMessageFactory&gt; DEFAULT_FLOW_MESSAGE_FACTORY_CLASS =</span><br><span class="line">            createFlowClassForProperty(<span class="string">"log4j2.flowMessageFactory"</span>, DefaultFlowMessageFactory<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">long</span> serialVersionUID = <span class="number">2L</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String FQCN = AbstractLogger<span class="class">.<span class="keyword">class</span>.<span class="title">getName</span>()</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String THROWING = <span class="string">"Throwing"</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String CATCHING = <span class="string">"Catching"</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">final</span> String name;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> MessageFactory2 messageFactory;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> FlowMessageFactory flowMessageFactory;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> ThreadLocal&lt;<span class="keyword">int</span>[]&gt; recursionDepthHolder = <span class="keyword">new</span> ThreadLocal&lt;&gt;(); <span class="comment">// LOG4J2-1518, LOG4J2-2031</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">final</span> <span class="keyword">transient</span> ThreadLocal&lt;DefaultLogBuilder&gt; logBuilder;</span><br></pre></td></tr></table></figure>

<h5 id="StatusLogger"><a href="#StatusLogger" class="headerlink" title="StatusLogger"></a>StatusLogger</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">记录日志系统 内部 中发生的事件。默认情况下，只有错误消息被记录到&#123;@link System#err&#125;。通常，Log4j状态记录器是通过Log4j配置文件中的根 &#123;@code&lt;Configuration status=“LEVEL”/&gt;&#125;节点配置的。但是，这可以通过一个名为"&#123;@value SimpleLoggerContext#SYSTEM_PREFIX&#125;StatusLogger.level"的系统属性重写，并且可以与任何Log4j提供程序一起使用。</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure>

<h5 id="Logger-1"><a href="#Logger-1" class="headerlink" title="Logger"></a>Logger</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"> org.apache.logging.log4j.core;</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">&#123;@link org.apache.logging.log4j.Logger&#125;接口的核心实现。除了提供所有记录器方法的实现之外，这个类还为log4j1.x兼容性以及对与此记录器相关联的&#123;@link org.apache.logging.log4j.core.Filter Filters&#125;和&#123;@link org.apache.logging.log4j.core.Appender Appenders&#125;的访问提供了一些方便的方法。注意，对这些底层对象的访问主要用于单元测试或桥接遗留log4j1.x代码。这个类的未来版本可能包括，也可能不包括被认为不是公共API一部分的各种方法。</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"><span class="doctag">TODO:</span>可以将所有isEnabled方法推送到筛选器接口中。不确定是否可以检查消息模式和参数。显著地影响了伐木机的性能。消息模式和参数是必需的，以便可以在全局筛选器中使用。</span></span><br><span class="line"><span class="comment">TODO All the isEnabled methods could be pushed into a filter interface. Not sure of the utility of having isEnabled be able to examine the message pattern and parameters. (RG) Moving the isEnabled methods out of Logger noticeably impacts performance. The message pattern and parameters are required so that they can be used in global filters.</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">long</span> serialVersionUID = <span class="number">1L</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Config should be consistent across threads.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">volatile</span> PrivateConfig privateConfig;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// <span class="doctag">FIXME:</span> ditto to the above</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> LoggerContext context;</span><br></pre></td></tr></table></figure>

<h6 id="PrivateConfig"><a href="#PrivateConfig" class="headerlink" title="PrivateConfig"></a>PrivateConfig</h6><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br></pre></td><td class="code"><pre><span class="line">每一个logger都内置一个私有配置的对象</span><br><span class="line"></span><br><span class="line"><span class="keyword">protected</span> <span class="class"><span class="keyword">class</span> <span class="title">PrivateConfig</span> </span>&#123;</span><br><span class="line">        <span class="comment">// config fields are public to make them visible to Logger subclasses</span></span><br><span class="line">        <span class="comment">/** LoggerConfig to delegate the actual logging to. */</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">final</span> LoggerConfig loggerConfig; <span class="comment">// SUPPRESS CHECKSTYLE</span></span><br><span class="line">        <span class="comment">/** The current Configuration associated with the LoggerConfig. */</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">final</span> Configuration config; <span class="comment">// SUPPRESS CHECKSTYLE</span></span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">final</span> Level loggerConfigLevel;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">int</span> intLevel;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">final</span> Logger logger;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">boolean</span> requiresLocation;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">PrivateConfig</span><span class="params">(<span class="keyword">final</span> Configuration config, <span class="keyword">final</span> Logger logger)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">this</span>.config = config;</span><br><span class="line">            <span class="keyword">this</span>.loggerConfig = config.getLoggerConfig(getName());</span><br><span class="line">            <span class="keyword">this</span>.loggerConfigLevel = <span class="keyword">this</span>.loggerConfig.getLevel();</span><br><span class="line">            <span class="keyword">this</span>.intLevel = <span class="keyword">this</span>.loggerConfigLevel.intLevel();</span><br><span class="line">            <span class="keyword">this</span>.logger = logger;</span><br><span class="line">            <span class="keyword">this</span>.requiresLocation = <span class="keyword">this</span>.loggerConfig.requiresLocation();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">PrivateConfig</span><span class="params">(<span class="keyword">final</span> PrivateConfig pc, <span class="keyword">final</span> Level level)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">this</span>.config = pc.config;</span><br><span class="line">            <span class="keyword">this</span>.loggerConfig = pc.loggerConfig;</span><br><span class="line">            <span class="keyword">this</span>.loggerConfigLevel = level;</span><br><span class="line">            <span class="keyword">this</span>.intLevel = <span class="keyword">this</span>.loggerConfigLevel.intLevel();</span><br><span class="line">            <span class="keyword">this</span>.logger = pc.logger;</span><br><span class="line">            <span class="keyword">this</span>.requiresLocation = <span class="keyword">this</span>.loggerConfig.requiresLocation();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">PrivateConfig</span><span class="params">(<span class="keyword">final</span> PrivateConfig pc, <span class="keyword">final</span> LoggerConfig lc)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">this</span>.config = pc.config;</span><br><span class="line">            <span class="keyword">this</span>.loggerConfig = lc;</span><br><span class="line">            <span class="keyword">this</span>.loggerConfigLevel = lc.getLevel();</span><br><span class="line">            <span class="keyword">this</span>.intLevel = <span class="keyword">this</span>.loggerConfigLevel.intLevel();</span><br><span class="line">            <span class="keyword">this</span>.logger = pc.logger;</span><br><span class="line">            <span class="keyword">this</span>.requiresLocation = <span class="keyword">this</span>.loggerConfig.requiresLocation();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// LOG4J2-151: changed visibility to public</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">logEvent</span><span class="params">(<span class="keyword">final</span> LogEvent event)</span> </span>&#123;</span><br><span class="line">            loggerConfig.log(event);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">boolean</span> <span class="title">filter</span><span class="params">(<span class="keyword">final</span> Level level, <span class="keyword">final</span> Marker marker, <span class="keyword">final</span> String msg)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">final</span> Filter filter = config.getFilter();</span><br><span class="line">            <span class="keyword">if</span> (filter != <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">final</span> Filter.Result r = filter.filter(logger, level, marker, msg);</span><br><span class="line">                <span class="keyword">if</span> (r != Filter.Result.NEUTRAL) &#123;</span><br><span class="line">                    <span class="keyword">return</span> r == Filter.Result.ACCEPT;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> level != <span class="keyword">null</span> &amp;&amp; intLevel &gt;= level.intLevel();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">boolean</span> <span class="title">filter</span><span class="params">(<span class="keyword">final</span> Level level, <span class="keyword">final</span> Marker marker, <span class="keyword">final</span> String msg, <span class="keyword">final</span> Throwable t)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">final</span> Filter filter = config.getFilter();</span><br><span class="line">            <span class="keyword">if</span> (filter != <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">final</span> Filter.Result r = filter.filter(logger, level, marker, (Object) msg, t);</span><br><span class="line">                <span class="keyword">if</span> (r != Filter.Result.NEUTRAL) &#123;</span><br><span class="line">                    <span class="keyword">return</span> r == Filter.Result.ACCEPT;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> level != <span class="keyword">null</span> &amp;&amp; intLevel &gt;= level.intLevel();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">boolean</span> <span class="title">filter</span><span class="params">(<span class="keyword">final</span> Level level, <span class="keyword">final</span> Marker marker, <span class="keyword">final</span> String msg, <span class="keyword">final</span> Object... p1)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">final</span> Filter filter = config.getFilter();</span><br><span class="line">            <span class="keyword">if</span> (filter != <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">final</span> Filter.Result r = filter.filter(logger, level, marker, msg, p1);</span><br><span class="line">                <span class="keyword">if</span> (r != Filter.Result.NEUTRAL) &#123;</span><br><span class="line">                    <span class="keyword">return</span> r == Filter.Result.ACCEPT;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> level != <span class="keyword">null</span> &amp;&amp; intLevel &gt;= level.intLevel();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">boolean</span> <span class="title">filter</span><span class="params">(<span class="keyword">final</span> Level level, <span class="keyword">final</span> Marker marker, <span class="keyword">final</span> String msg, <span class="keyword">final</span> Object p0)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">final</span> Filter filter = config.getFilter();</span><br><span class="line">            <span class="keyword">if</span> (filter != <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">final</span> Filter.Result r = filter.filter(logger, level, marker, msg, p0);</span><br><span class="line">                <span class="keyword">if</span> (r != Filter.Result.NEUTRAL) &#123;</span><br><span class="line">                    <span class="keyword">return</span> r == Filter.Result.ACCEPT;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> level != <span class="keyword">null</span> &amp;&amp; intLevel &gt;= level.intLevel();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">boolean</span> <span class="title">filter</span><span class="params">(<span class="keyword">final</span> Level level, <span class="keyword">final</span> Marker marker, <span class="keyword">final</span> String msg, <span class="keyword">final</span> Object p0,</span></span></span><br><span class="line"><span class="function"><span class="params">                <span class="keyword">final</span> Object p1)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">final</span> Filter filter = config.getFilter();</span><br><span class="line">            <span class="keyword">if</span> (filter != <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">final</span> Filter.Result r = filter.filter(logger, level, marker, msg, p0, p1);</span><br><span class="line">                <span class="keyword">if</span> (r != Filter.Result.NEUTRAL) &#123;</span><br><span class="line">                    <span class="keyword">return</span> r == Filter.Result.ACCEPT;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> level != <span class="keyword">null</span> &amp;&amp; intLevel &gt;= level.intLevel();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">boolean</span> <span class="title">filter</span><span class="params">(<span class="keyword">final</span> Level level, <span class="keyword">final</span> Marker marker, <span class="keyword">final</span> String msg, <span class="keyword">final</span> Object p0,</span></span></span><br><span class="line"><span class="function"><span class="params">                <span class="keyword">final</span> Object p1, <span class="keyword">final</span> Object p2)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">final</span> Filter filter = config.getFilter();</span><br><span class="line">            <span class="keyword">if</span> (filter != <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">final</span> Filter.Result r = filter.filter(logger, level, marker, msg, p0, p1, p2);</span><br><span class="line">                <span class="keyword">if</span> (r != Filter.Result.NEUTRAL) &#123;</span><br><span class="line">                    <span class="keyword">return</span> r == Filter.Result.ACCEPT;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> level != <span class="keyword">null</span> &amp;&amp; intLevel &gt;= level.intLevel();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">boolean</span> <span class="title">filter</span><span class="params">(<span class="keyword">final</span> Level level, <span class="keyword">final</span> Marker marker, <span class="keyword">final</span> String msg, <span class="keyword">final</span> Object p0,</span></span></span><br><span class="line"><span class="function"><span class="params">                <span class="keyword">final</span> Object p1, <span class="keyword">final</span> Object p2, <span class="keyword">final</span> Object p3)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">final</span> Filter filter = config.getFilter();</span><br><span class="line">            <span class="keyword">if</span> (filter != <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">final</span> Filter.Result r = filter.filter(logger, level, marker, msg, p0, p1, p2, p3);</span><br><span class="line">                <span class="keyword">if</span> (r != Filter.Result.NEUTRAL) &#123;</span><br><span class="line">                    <span class="keyword">return</span> r == Filter.Result.ACCEPT;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> level != <span class="keyword">null</span> &amp;&amp; intLevel &gt;= level.intLevel();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">boolean</span> <span class="title">filter</span><span class="params">(<span class="keyword">final</span> Level level, <span class="keyword">final</span> Marker marker, <span class="keyword">final</span> String msg, <span class="keyword">final</span> Object p0,</span></span></span><br><span class="line"><span class="function"><span class="params">                <span class="keyword">final</span> Object p1, <span class="keyword">final</span> Object p2, <span class="keyword">final</span> Object p3,</span></span></span><br><span class="line"><span class="function"><span class="params">                <span class="keyword">final</span> Object p4)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">final</span> Filter filter = config.getFilter();</span><br><span class="line">            <span class="keyword">if</span> (filter != <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">final</span> Filter.Result r = filter.filter(logger, level, marker, msg, p0, p1, p2, p3, p4);</span><br><span class="line">                <span class="keyword">if</span> (r != Filter.Result.NEUTRAL) &#123;</span><br><span class="line">                    <span class="keyword">return</span> r == Filter.Result.ACCEPT;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> level != <span class="keyword">null</span> &amp;&amp; intLevel &gt;= level.intLevel();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">boolean</span> <span class="title">filter</span><span class="params">(<span class="keyword">final</span> Level level, <span class="keyword">final</span> Marker marker, <span class="keyword">final</span> String msg, <span class="keyword">final</span> Object p0,</span></span></span><br><span class="line"><span class="function"><span class="params">                <span class="keyword">final</span> Object p1, <span class="keyword">final</span> Object p2, <span class="keyword">final</span> Object p3,</span></span></span><br><span class="line"><span class="function"><span class="params">                <span class="keyword">final</span> Object p4, <span class="keyword">final</span> Object p5)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">final</span> Filter filter = config.getFilter();</span><br><span class="line">            <span class="keyword">if</span> (filter != <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">final</span> Filter.Result r = filter.filter(logger, level, marker, msg, p0, p1, p2, p3, p4, p5);</span><br><span class="line">                <span class="keyword">if</span> (r != Filter.Result.NEUTRAL) &#123;</span><br><span class="line">                    <span class="keyword">return</span> r == Filter.Result.ACCEPT;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> level != <span class="keyword">null</span> &amp;&amp; intLevel &gt;= level.intLevel();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">boolean</span> <span class="title">filter</span><span class="params">(<span class="keyword">final</span> Level level, <span class="keyword">final</span> Marker marker, <span class="keyword">final</span> String msg, <span class="keyword">final</span> Object p0,</span></span></span><br><span class="line"><span class="function"><span class="params">                <span class="keyword">final</span> Object p1, <span class="keyword">final</span> Object p2, <span class="keyword">final</span> Object p3,</span></span></span><br><span class="line"><span class="function"><span class="params">                <span class="keyword">final</span> Object p4, <span class="keyword">final</span> Object p5, <span class="keyword">final</span> Object p6)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">final</span> Filter filter = config.getFilter();</span><br><span class="line">            <span class="keyword">if</span> (filter != <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">final</span> Filter.Result r = filter.filter(logger, level, marker, msg, p0, p1, p2, p3, p4, p5, p6);</span><br><span class="line">                <span class="keyword">if</span> (r != Filter.Result.NEUTRAL) &#123;</span><br><span class="line">                    <span class="keyword">return</span> r == Filter.Result.ACCEPT;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> level != <span class="keyword">null</span> &amp;&amp; intLevel &gt;= level.intLevel();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">boolean</span> <span class="title">filter</span><span class="params">(<span class="keyword">final</span> Level level, <span class="keyword">final</span> Marker marker, <span class="keyword">final</span> String msg, <span class="keyword">final</span> Object p0,</span></span></span><br><span class="line"><span class="function"><span class="params">                <span class="keyword">final</span> Object p1, <span class="keyword">final</span> Object p2, <span class="keyword">final</span> Object p3,</span></span></span><br><span class="line"><span class="function"><span class="params">                <span class="keyword">final</span> Object p4, <span class="keyword">final</span> Object p5, <span class="keyword">final</span> Object p6,</span></span></span><br><span class="line"><span class="function"><span class="params">                <span class="keyword">final</span> Object p7)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">final</span> Filter filter = config.getFilter();</span><br><span class="line">            <span class="keyword">if</span> (filter != <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">final</span> Filter.Result r = filter.filter(logger, level, marker, msg, p0, p1, p2, p3, p4, p5, p6, p7);</span><br><span class="line">                <span class="keyword">if</span> (r != Filter.Result.NEUTRAL) &#123;</span><br><span class="line">                    <span class="keyword">return</span> r == Filter.Result.ACCEPT;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> level != <span class="keyword">null</span> &amp;&amp; intLevel &gt;= level.intLevel();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">boolean</span> <span class="title">filter</span><span class="params">(<span class="keyword">final</span> Level level, <span class="keyword">final</span> Marker marker, <span class="keyword">final</span> String msg, <span class="keyword">final</span> Object p0,</span></span></span><br><span class="line"><span class="function"><span class="params">                <span class="keyword">final</span> Object p1, <span class="keyword">final</span> Object p2, <span class="keyword">final</span> Object p3,</span></span></span><br><span class="line"><span class="function"><span class="params">                <span class="keyword">final</span> Object p4, <span class="keyword">final</span> Object p5, <span class="keyword">final</span> Object p6,</span></span></span><br><span class="line"><span class="function"><span class="params">                <span class="keyword">final</span> Object p7, <span class="keyword">final</span> Object p8)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">final</span> Filter filter = config.getFilter();</span><br><span class="line">            <span class="keyword">if</span> (filter != <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">final</span> Filter.Result r = filter.filter(logger, level, marker, msg, p0, p1, p2, p3, p4, p5, p6, p7, p8);</span><br><span class="line">                <span class="keyword">if</span> (r != Filter.Result.NEUTRAL) &#123;</span><br><span class="line">                    <span class="keyword">return</span> r == Filter.Result.ACCEPT;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> level != <span class="keyword">null</span> &amp;&amp; intLevel &gt;= level.intLevel();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">boolean</span> <span class="title">filter</span><span class="params">(<span class="keyword">final</span> Level level, <span class="keyword">final</span> Marker marker, <span class="keyword">final</span> String msg, <span class="keyword">final</span> Object p0,</span></span></span><br><span class="line"><span class="function"><span class="params">                <span class="keyword">final</span> Object p1, <span class="keyword">final</span> Object p2, <span class="keyword">final</span> Object p3,</span></span></span><br><span class="line"><span class="function"><span class="params">                <span class="keyword">final</span> Object p4, <span class="keyword">final</span> Object p5, <span class="keyword">final</span> Object p6,</span></span></span><br><span class="line"><span class="function"><span class="params">                <span class="keyword">final</span> Object p7, <span class="keyword">final</span> Object p8, <span class="keyword">final</span> Object p9)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">final</span> Filter filter = config.getFilter();</span><br><span class="line">            <span class="keyword">if</span> (filter != <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">final</span> Filter.Result r = filter.filter(logger, level, marker, msg, p0, p1, p2, p3, p4, p5, p6, p7, p8,</span><br><span class="line">                        p9);</span><br><span class="line">                <span class="keyword">if</span> (r != Filter.Result.NEUTRAL) &#123;</span><br><span class="line">                    <span class="keyword">return</span> r == Filter.Result.ACCEPT;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> level != <span class="keyword">null</span> &amp;&amp; intLevel &gt;= level.intLevel();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">boolean</span> <span class="title">filter</span><span class="params">(<span class="keyword">final</span> Level level, <span class="keyword">final</span> Marker marker, <span class="keyword">final</span> CharSequence msg, <span class="keyword">final</span> Throwable t)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">final</span> Filter filter = config.getFilter();</span><br><span class="line">            <span class="keyword">if</span> (filter != <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">final</span> Filter.Result r = filter.filter(logger, level, marker, msg, t);</span><br><span class="line">                <span class="keyword">if</span> (r != Filter.Result.NEUTRAL) &#123;</span><br><span class="line">                    <span class="keyword">return</span> r == Filter.Result.ACCEPT;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> level != <span class="keyword">null</span> &amp;&amp; intLevel &gt;= level.intLevel();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">boolean</span> <span class="title">filter</span><span class="params">(<span class="keyword">final</span> Level level, <span class="keyword">final</span> Marker marker, <span class="keyword">final</span> Object msg, <span class="keyword">final</span> Throwable t)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">final</span> Filter filter = config.getFilter();</span><br><span class="line">            <span class="keyword">if</span> (filter != <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">final</span> Filter.Result r = filter.filter(logger, level, marker, msg, t);</span><br><span class="line">                <span class="keyword">if</span> (r != Filter.Result.NEUTRAL) &#123;</span><br><span class="line">                    <span class="keyword">return</span> r == Filter.Result.ACCEPT;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> level != <span class="keyword">null</span> &amp;&amp; intLevel &gt;= level.intLevel();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">boolean</span> <span class="title">filter</span><span class="params">(<span class="keyword">final</span> Level level, <span class="keyword">final</span> Marker marker, <span class="keyword">final</span> Message msg, <span class="keyword">final</span> Throwable t)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">final</span> Filter filter = config.getFilter();</span><br><span class="line">            <span class="keyword">if</span> (filter != <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">final</span> Filter.Result r = filter.filter(logger, level, marker, msg, t);</span><br><span class="line">                <span class="keyword">if</span> (r != Filter.Result.NEUTRAL) &#123;</span><br><span class="line">                    <span class="keyword">return</span> r == Filter.Result.ACCEPT;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> level != <span class="keyword">null</span> &amp;&amp; intLevel &gt;= level.intLevel();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> String <span class="title">toString</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="keyword">final</span> StringBuilder builder = <span class="keyword">new</span> StringBuilder();</span><br><span class="line">            builder.append(<span class="string">"PrivateConfig [loggerConfig="</span>);</span><br><span class="line">            builder.append(loggerConfig);</span><br><span class="line">            builder.append(<span class="string">", config="</span>);</span><br><span class="line">            builder.append(config);</span><br><span class="line">            builder.append(<span class="string">", loggerConfigLevel="</span>);</span><br><span class="line">            builder.append(loggerConfigLevel);</span><br><span class="line">            builder.append(<span class="string">", intLevel="</span>);</span><br><span class="line">            builder.append(intLevel);</span><br><span class="line">            builder.append(<span class="string">", logger="</span>);</span><br><span class="line">            builder.append(logger);</span><br><span class="line">            builder.append(<span class="string">"]"</span>);</span><br><span class="line">            <span class="keyword">return</span> builder.toString();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<h3 id="LoggerConfig"><a href="#LoggerConfig" class="headerlink" title="LoggerConfig"></a>LoggerConfig</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">过配置创建的Logger对象。</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String ROOT = <span class="string">"root"</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> LogEventFactory LOG_EVENT_FACTORY = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> List&lt;AppenderRef&gt; appenderRefs = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> AppenderControlArraySet appenders = <span class="keyword">new</span> AppenderControlArraySet();</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> String name;</span><br><span class="line">    <span class="keyword">private</span> LogEventFactory logEventFactory;</span><br><span class="line">    <span class="keyword">private</span> Level level;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">boolean</span> additive = <span class="keyword">true</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">boolean</span> includeLocation = <span class="keyword">true</span>;</span><br><span class="line">    <span class="keyword">private</span> LoggerConfig parent;</span><br><span class="line">    <span class="keyword">private</span> Map&lt;Property, Boolean&gt; propertiesMap;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> List&lt;Property&gt; properties;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">boolean</span> propertiesRequireLookup;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Configuration config;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> ReliabilityStrategy reliabilityStrategy;</span><br></pre></td></tr></table></figure>

<h5 id="‘ReliabilityStrategy"><a href="#‘ReliabilityStrategy" class="headerlink" title="‘ReliabilityStrategy"></a>‘ReliabilityStrategy</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">这个接口的实例对象知道如何确保将日志事件传递到适当的附加器，即使在系统处于活动状态时修改配置期间或之后也是如此。</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure>





<h3 id="LoggerContext"><a href="#LoggerContext" class="headerlink" title="LoggerContext"></a>LoggerContext</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">日志实现的定位点。用于定位日志实现</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line">SimpleLoggerContext：他就是用来获取一个简单logger的 上下文</span><br></pre></td></tr></table></figure>

<h5 id="LoggerContext-1"><a href="#LoggerContext-1" class="headerlink" title="LoggerContext"></a>LoggerContext</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">org.apache.logging.log4j.core;</span><br><span class="line">extends AbstractLifeCycle</span><br><span class="line">        implements org.apache.logging.log4j.spi.LoggerContext, AutoCloseable, Terminable, ConfigurationListener,</span><br><span class="line">        LoggerContextShutdownEnabled </span><br><span class="line">            </span><br><span class="line"></span><br><span class="line">            </span><br><span class="line"> Terminable: 由提供关闭方法的LoggerContext实现的接口。  </span><br><span class="line">   ConfigurationListener:  用于在配置更改时通知组件的接口。</span><br><span class="line">       LoggerContextShutdownEnabled: 实现此功能的loggerContext是能够注册LoggerContextShutdownAware类。  </span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">LoggerContext是日志记录系统的锚（支持，用于获取logger的）。它维护应用程序请求的所有记录器的列表以及对配置的引用。configration&#123;将包含已配置的记录器、附加器、过滤器等&#125;，并将在重新配置发生时自动更新。</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line"> <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String PROPERTY_CONFIG = <span class="string">"config"</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Configuration NULL_CONFIGURATION = <span class="keyword">new</span> NullConfiguration();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> LoggerRegistry&lt;Logger&gt; loggerRegistry = <span class="keyword">new</span> LoggerRegistry&lt;&gt;();</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> CopyOnWriteArrayList&lt;PropertyChangeListener&gt; propertyChangeListeners = <span class="keyword">new</span> CopyOnWriteArrayList&lt;&gt;();</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">volatile</span> List&lt;LoggerContextShutdownAware&gt; listeners = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * The Configuration is volatile to guarantee that initialization of the Configuration has completed before the</span></span><br><span class="line"><span class="comment">     * reference is updated.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">volatile</span> Configuration configuration = <span class="keyword">new</span> DefaultConfiguration();</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String EXTERNAL_CONTEXT_KEY = <span class="string">"__EXTERNAL_CONTEXT_KEY__"</span>;</span><br><span class="line">    <span class="keyword">private</span> ConcurrentMap&lt;String, Object&gt; externalMap = <span class="keyword">new</span> ConcurrentHashMap&lt;&gt;();</span><br><span class="line">    <span class="keyword">private</span> String contextName;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">volatile</span> URI configLocation;</span><br><span class="line">    <span class="keyword">private</span> Cancellable shutdownCallback;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Lock configLock = <span class="keyword">new</span> ReentrantLock();</span><br></pre></td></tr></table></figure>

<h6 id="AsyncLoggerContext"><a href="#AsyncLoggerContext" class="headerlink" title="AsyncLoggerContext"></a>AsyncLoggerContext</h6><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">&#123;@code LoggerContext&#125;，用于创建&#123;@code AsyncLogger&#125;对象。</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> AsyncLoggerDisruptor loggerDisruptor;</span><br></pre></td></tr></table></figure>



<h5 id="LoggerRegistry"><a href="#LoggerRegistry" class="headerlink" title="LoggerRegistry"></a>LoggerRegistry</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//&#123;@code LoggerContext&#125;实现使用的便利类。</span></span><br><span class="line"></span><br><span class="line">   <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String DEFAULT_FACTORY_KEY = AbstractLogger.DEFAULT_MESSAGE_FACTORY_CLASS.getName();</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> MapFactory&lt;T&gt; factory;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Map&lt;String, Map&lt;String, T&gt;&gt; map;</span><br><span class="line">就是容器用于存储 logger对象和 真正获取logger对象</span><br></pre></td></tr></table></figure>







<h3 id="MarkerManager"><a href="#MarkerManager" class="headerlink" title="MarkerManager"></a>MarkerManager</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//应用程序使用标记管理器创建标记。此管理器创建的所有标记都是不可变的。</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Marker <span class="title">getMarker</span><span class="params">(<span class="keyword">final</span> String name)</span> </span>&#123;</span><br><span class="line">        Marker result = MARKERS.get(name);</span><br><span class="line">        <span class="keyword">if</span> (result == <span class="keyword">null</span>) &#123;</span><br><span class="line">            MARKERS.putIfAbsent(name, <span class="keyword">new</span> Log4jMarker(name));</span><br><span class="line">            result = MARKERS.get(name);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Log4jMarker：考虑到这个类是私有的，它是公共的，以满足Jackson对XML和JSON IO的要求。实际的Marker实现。</span><br><span class="line">内部注意：如果&#123;<span class="meta">@code</span> org.apache.logging.log4j.core.jackson.MarkerMixIn&#125;类被移到这个包中，我们可以将这个类包设为私有的，而不是公共的，当然会保留在它当前的模块中。</span><br></pre></td></tr></table></figure>



<h4 id="Marker"><a href="#Marker" class="headerlink" title="Marker"></a>Marker</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"> org.apache.logging.log4j;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">Marker是用于向日志消息添加易于筛选的信息的对象。</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">Markers可以是分层的-每个标记都可以有一个父级。这样就可以将大的类别细分为更具体的类别。例如，一个名为“Error”的标记和名为“SystemError”和“ApplicationError”的子级。</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line">Interface <span class="keyword">for</span> constructing log events before logging them. Instances of LogBuilders should only be created by calling one of the Logger methods that <span class="keyword">return</span> a LogBuilder.</span><br></pre></td></tr></table></figure>





<h3 id="MessageFactory"><a href="#MessageFactory" class="headerlink" title="MessageFactory"></a>MessageFactory</h3><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">创建消息。实现可以提供不同的消息格式语法。</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line">MessageFactory2：创建消息。实现可以提供不同的消息格式语法。</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">AbstractMessageFactory：为带有默认实现的&#123;@link MessageFactory2&#125;实现提供抽象超类（扩展名为&#123;@link MessageFactory&#125;）。这个类是不变的。实施者注意事项：当子类能够最有效地构建&#123;@link MessageFactory2&#125;实例时，它们可以实现&#123;@linkmessagefactory2&#125;方法。如果子类不实现&#123;@link MessageFactory2&#125;方法，则这些调用将通过该类中的&#123;@link#newMessage（String，Object…）&#125;进行路由。</span><br></pre></td></tr></table></figure>





<h4 id="Message"><a href="#Message" class="headerlink" title="Message"></a>Message</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">一个接口，用于各种可以记录的消息实现。消息可以充当对象的包装器，这样用户就可以在必要时控制将对象转换为字符串，而不需要复杂的格式化程序，并且可以根据运行时可用的信息（如系统的区域设置）来操作消息。</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">自定义消息实现应考虑实现&#123;@link StringBuilderFormattable&#125;接口，以实现更高效的处理。如果消息实现StringBuildPerformAttable，则无垃圾 Layouts 将调用&#123;@link StringBuildPerformAttable#formatTo（StringBuilder）formatTo（StringBuilder）&#125;，而不是&#123;@link Message#getFormattedMessage（）&#125;。</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">注意：不应将消息对象视为线程安全的，也不应假定它们即使在同一线程上也可以安全地重用。日志记录系统可以向消息对象提供信息，消息可能会排队等待异步传递。因此，在消息作为记录器方法的参数传递之后，应用程序应该避免对消息对象的任何修改。</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure>



<h3 id="LifeCycle"><a href="#LifeCycle" class="headerlink" title="LifeCycle"></a>LifeCycle</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">所有合适的Java框架都实现某种对象生命周期。在Log4j中，处理对象生命周期上下文的主接口是这个。默认情况下，对象首先以&#123;@link State#INITIALIZED&#125;状态启动，以指示类已加载。从这里开始，调用&#123;@link#start（）&#125;方法会将此状态更改为&#123;@link state#STARTING&#125;。成功启动后，此状态将更改为&#123;@link state#started&#125;。当调用&#123;@link#stop（）&#125;时，它将进入&#123;@link State#STOPPING&#125;状态。成功停止后，它将进入&#123;@link State#stopped&#125;状态。在大多数情况下，实现类应该将它们的&#123;@link state&#125;存储在&#123;@code volatile&#125;字段中，或者存储在&#123;@link java.util.concurrent.atomic.AtomicReference&#125;中，这取决于同步和并发需求。</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line">LifeCycle2: 扩展生命周期界面。此接口应与<span class="number">3.0</span>中的超级接口合并。</span><br></pre></td></tr></table></figure>



<h4 id="Filterable"><a href="#Filterable" class="headerlink" title="Filterable"></a>Filterable</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">extends LifeCycle </span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">接口由允许进行筛选的类实现。</span></span><br><span class="line"><span class="comment">扩展&#123;@link LifeCycle&#125;，因为过滤器有生命周期。</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure>



<h5 id="Configuration"><a href="#Configuration" class="headerlink" title="Configuration"></a>Configuration</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">extends Filterable</span><br><span class="line"><span class="comment">//必须实现以创建配置的接口。</span></span><br><span class="line"><span class="comment">//建议自定义实现来扩展&#123;@linkabstractconfiguration&#125;。</span></span><br><span class="line"></span><br><span class="line">AbstractConfiguration  extends AbstractFilterable implements Configuration:基本配置。许多配置实现都会扩展这个类。</span><br><span class="line">    AbstractFilterable   extends AbstractLifeCycle implements Filterable:通过允许类包含筛选器来增强类。 </span><br><span class="line">    	AbstractLifeCycle implements LifeCycle2</span><br></pre></td></tr></table></figure>

<h6 id="AbstractConfiguration"><a href="#AbstractConfiguration" class="headerlink" title="AbstractConfiguration"></a>AbstractConfiguration</h6><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">基本配置。许多配置实现都会扩展这个类。</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line">包含已配置的记录器、附加器、过滤器</span><br><span class="line"> <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> BUF_SIZE = <span class="number">16384</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * The root node of the configuration.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">protected</span> Node rootNode;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Listeners for configuration changes.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">final</span> List&lt;ConfigurationListener&gt; listeners = <span class="keyword">new</span> CopyOnWriteArrayList&lt;&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Packages found in configuration "packages" attribute.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">final</span> List&lt;String&gt; pluginPackages = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * The plugin manager.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">protected</span> PluginManager pluginManager;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Shutdown hook is enabled by default.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">boolean</span> isShutdownHookEnabled = <span class="keyword">true</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Shutdown timeout in milliseconds.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">long</span> shutdownTimeoutMillis = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * The Script manager.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">protected</span> ScriptManager scriptManager;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * The Advertiser which exposes appender configurations to external systems.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> Advertiser advertiser = <span class="keyword">new</span> DefaultAdvertiser();</span><br><span class="line">    <span class="keyword">private</span> Node advertiserNode = <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">private</span> Object advertisement;</span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line">    <span class="keyword">private</span> ConcurrentMap&lt;String, Appender&gt; appenders = <span class="keyword">new</span> ConcurrentHashMap&lt;&gt;();</span><br><span class="line">    <span class="keyword">private</span> ConcurrentMap&lt;String, LoggerConfig&gt; loggerConfigs = <span class="keyword">new</span> ConcurrentHashMap&lt;&gt;();</span><br><span class="line">    <span class="keyword">private</span> List&lt;CustomLevelConfig&gt; customLevels = Collections.emptyList();</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> ConcurrentMap&lt;String, String&gt; propertyMap = <span class="keyword">new</span> ConcurrentHashMap&lt;&gt;();</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> StrLookup tempLookup = <span class="keyword">new</span> Interpolator(propertyMap);</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> StrSubstitutor subst = <span class="keyword">new</span> StrSubstitutor(tempLookup);</span><br><span class="line">    <span class="keyword">private</span> LoggerConfig root = <span class="keyword">new</span> LoggerConfig();</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> ConcurrentMap&lt;String, Object&gt; componentMap = <span class="keyword">new</span> ConcurrentHashMap&lt;&gt;();</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> ConfigurationSource configurationSource;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> ConfigurationScheduler configurationScheduler = <span class="keyword">new</span> ConfigurationScheduler();</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> WatchManager watchManager = <span class="keyword">new</span> WatchManager(configurationScheduler);</span><br><span class="line">    <span class="keyword">private</span> AsyncLoggerConfigDisruptor asyncLoggerConfigDisruptor;</span><br><span class="line">    <span class="keyword">private</span> NanoClock nanoClock = <span class="keyword">new</span> DummyNanoClock();</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> WeakReference&lt;LoggerContext&gt; loggerContext;</span><br></pre></td></tr></table></figure>



<h3 id="PluginManager"><a href="#PluginManager" class="headerlink" title="PluginManager"></a>PluginManager</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">加载并管理所有插件。</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"> private static final CopyOnWriteArrayList&lt;String&gt; PACKAGES = new CopyOnWriteArrayList&lt;&gt;();</span></span><br><span class="line"><span class="comment">    private static final String LOG4J_PACKAGES = "org.apache.logging.log4j.core";</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">    private static final Logger LOGGER = StatusLogger.getLogger();</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">    private Map&lt;String, PluginType&lt;?&gt;&gt; plugins = new HashMap&lt;&gt;();</span></span><br><span class="line"><span class="comment">    private final String category;</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure>

<h4 id="PluginType"><a href="#PluginType" class="headerlink" title="PluginType"></a>PluginType</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">插件描述符。这是一个memento对象，用于插件注释与其注释类配对。</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> PluginEntry pluginEntry;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Class&lt;T&gt; pluginClass;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> String elementName;</span><br></pre></td></tr></table></figure>

<h5 id="PluginEntry"><a href="#PluginEntry" class="headerlink" title="PluginEntry"></a>PluginEntry</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//用于将插件项存储到缓存文件的Memento对象。</span></span><br><span class="line"> <span class="keyword">private</span> String key;</span><br><span class="line">    <span class="keyword">private</span> String className;</span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">boolean</span> printable;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">boolean</span> defer;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">transient</span> String category;</span><br></pre></td></tr></table></figure>



<h3 id="AutoCloseable"><a href="#AutoCloseable" class="headerlink" title="AutoCloseable"></a>AutoCloseable</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">java.lang</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">一个在关闭之前可以保存资源（如文件或套接字句柄）的对象。当退出&#123;@code try&#125;-with-resources块时，&#123;@code AutoCloseable&#125;对象的&#123;@link\#close（）&#125;方法将自动调用，该资源块已在资源规范头中声明了该对象。否则会导致资源耗尽。</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">基类实现AutoCloseable是可能的，事实上也是常见的，即使它的所有子类或实例都包含可发布的资源。 </span></span><br><span class="line"><span class="comment">对于必须完全通用地操作的代码，或者当已知&#123;@code AutoCloseable&#125;实例需要资源释放时，建议使用&#123;@code try&#125;-with-resource 构造。但是，当使用&#123;@link之类的工具时java.util.stream.Stream&#125;同时支持基于I/O和非I/O的表单，&#123;@code try&#125;-with resources块在使用非基于I/O的表单时通常是不必要的。</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">然而，当使用同时支持基于I/O和非I/O形式的&#123;@link java.util.stream.Stream&#125;之类的工具时，&#123;@code try&#125;-with-resources块在使用非基于I/O的形式时通常是不必要的。</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line">    </span><br><span class="line">  关闭此资源，释放底层资源。  </span><br><span class="line">  Closes <span class="keyword">this</span> resource, relinquishing any underlying resources. 此方法在&#123;<span class="meta">@codetry</span>&#125;-with-resources语句管理的对象上自动调用。虽然此接口方法声明为抛出&#123;<span class="meta">@code</span> Exception&#125;，但强烈建议实现者声明&#123;<span class="meta">@code</span> close&#125;方法的具体实现来引发更具体的异常，或者在close操作不能失败时根本不抛出异常。</span><br><span class="line">   关闭操作可能失败的情况需要实施者仔细关注。强烈建议在抛出异常之前，放弃底层资源并在内部将资源标记为关闭。 </span><br><span class="line">   &#123;<span class="meta">@code</span> close&#125;方法不太可能被多次调用，因此这可以确保及时释放资源。此外，它还减少了当资源包装或被其他资源包装时可能出现的问题。</span><br><span class="line">  强烈建议此接口的实现者不要使用&#123;@code close&#125;方法抛出&#123;@link InterruptedException&#125;。此异常与线程的中断状态交互，如果&#123;@code InterruptedException&#125;是&#123;@linkplain Throwable#addSuppressed suppressed&#125;，则很可能发生运行时错误行为。</span><br><span class="line">    更一般地说，如果抑制异常会导致问题，则AutoCloseable.close方法不应抛出它。</span><br><span class="line">    </span><br><span class="line">注意，与&#123;@link java.io.Closeable&#125;的&#123;@link java.io.Closeable#close close&#125;  方法不同，这个&#123;@code close&#125;方法不是的幂等的。换句话说，多次调用这个&#123;@codeclose&#125;方法可能会产生一些可见的副作用，这与&#123;@code Closeable.close&#125;不同，&#123;@code Closeable.close&#125;被要求多次调用时没有任何效果。</span><br><span class="line">但是，强烈建议此接口的实现者使其&#123;<span class="meta">@code</span> close&#125;方法幂等。</span><br><span class="line">        <span class="function"><span class="keyword">void</span> <span class="title">close</span><span class="params">()</span> <span class="keyword">throws</span> Exception</span>;s</span><br></pre></td></tr></table></figure>





<h3 id="Provider"><a href="#Provider" class="headerlink" title="Provider"></a>Provider</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">log4j2提供程序的模型类。此类中的属性对应于&#123;@code META-INF/log4j-provider.properties&#125;文件中使用的属性。注意，这个类是由Log4j自动创建的，不应该由提供者使用。</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line">其实就是使用了服务自动发现</span><br><span class="line">    </span><br><span class="line">    ServiceLoader.load 这个东西 你指定一个类对象，他就会去 META-INFO/service/ 下面 找 类对象名字的文件，这个文件指定类对象的实现类</span><br><span class="line"></span><br><span class="line">    </span><br><span class="line">    这里这个Provider的具体实现就是这么来的，这个对象指定了 log4j2工厂的类型，所以工厂的获取在这里</span><br></pre></td></tr></table></figure>

<h3 id="LoggerContextFactory"><a href="#LoggerContextFactory" class="headerlink" title="LoggerContextFactory"></a>LoggerContextFactory</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">由此子类实例创建&#123;@link LoggerContext&#125;对象的工厂实现。</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure>

<h5 id="Log4jContextFactory"><a href="#Log4jContextFactory" class="headerlink" title="Log4jContextFactory"></a>Log4jContextFactory</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">implements LoggerContextFactory, ShutdownCallbackRegistry</span><br><span class="line"></span><br><span class="line">ShutdownCallbackRegistry：用于可运行关闭时回调实例的注册表。由于对JVM生命周期中Log4j的关闭时间有不同的要求，提供这个接口是为了定制如何注册关闭的一个钩子回调。实现可以选择性地实现&#123;<span class="meta">@link</span> org.apache.logging.log4j.core.LifeCycle&#125;。</span><br><span class="line">    </span><br><span class="line">  <span class="comment">/*</span></span><br><span class="line"><span class="comment">  </span></span><br><span class="line"><span class="comment">  工厂定位ContextSelector，然后加载LoggerContext。</span></span><br><span class="line"><span class="comment">  */</span></span><br></pre></td></tr></table></figure>



<h5 id="ContextSelector"><a href="#ContextSelector" class="headerlink" title="ContextSelector"></a>ContextSelector</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">用于定位LoggerContext的接口。</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> ContextSelector <span class="title">createContextSelector</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">           <span class="comment">//    public static final String LOG4J_CONTEXT_SELECTOR = "Log4jContextSelector";指定了就是用这个指定的loggerContext选择器</span></span><br><span class="line">            <span class="keyword">final</span> ContextSelector selector = Loader.newCheckedInstanceOfProperty(Constants.LOG4J_CONTEXT_SELECTOR,</span><br><span class="line">                ContextSelector<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">            <span class="keyword">if</span> (selector != <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">return</span> selector;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (<span class="keyword">final</span> Exception e) &#123;</span><br><span class="line">            LOGGER.error(<span class="string">"Unable to create custom ContextSelector. Falling back to default."</span>, e);</span><br><span class="line">        &#125;</span><br><span class="line">    <span class="comment">//没有指定就是默认的ClassLoaderContextSelector</span></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> ClassLoaderContextSelector();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"> <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> ShutdownCallbackRegistry <span class="title">createShutdownCallbackRegistry</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// String SHUTDOWN_CALLBACK_REGISTRY = "log4j.shutdownCallbackRegistry";</span></span><br><span class="line">指定了就创建指定的</span><br><span class="line">            <span class="keyword">final</span> ShutdownCallbackRegistry registry = Loader.newCheckedInstanceOfProperty(</span><br><span class="line">                ShutdownCallbackRegistry.SHUTDOWN_CALLBACK_REGISTRY, ShutdownCallbackRegistry<span class="class">.<span class="keyword">class</span></span></span><br><span class="line"><span class="class">            )</span>;</span><br><span class="line">            <span class="keyword">if</span> (registry != <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">return</span> registry;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (<span class="keyword">final</span> Exception e) &#123;</span><br><span class="line">            LOGGER.error(<span class="string">"Unable to create custom ShutdownCallbackRegistry. Falling back to default."</span>, e);</span><br><span class="line">        &#125;</span><br><span class="line">     </span><br><span class="line">     <span class="comment">//创建默认的DefaultShutdownCallbackRegistry</span></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> DefaultShutdownCallbackRegistry();</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<h3 id="StrSubstitutor"><a href="#StrSubstitutor" class="headerlink" title="StrSubstitutor"></a>StrSubstitutor</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">用值替换字符串中的变量。</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">这个类接受一段文本并替换其中的所有变量。</span></span><br><span class="line"><span class="comment"> * 变量的默认定义是&lt;code&gt;$&#123;variableName&#125;&lt;/code&gt;。</span></span><br><span class="line"><span class="comment"> *前缀和后缀可以通过构造函数和set方法更改。</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">变量值通常从映射中解析，但也可以从系统属性或通过提供自定义变量解析程序来解析。</span></span><br><span class="line"><span class="comment">最简单的例子是使用这个类来替换Java系统属性。例如：</span></span><br><span class="line"><span class="comment">* &lt;pre&gt;</span></span><br><span class="line"><span class="comment"> * StrSubstitutor.replaceSystemProperties(</span></span><br><span class="line"><span class="comment"> *      "You are running with java.version = $&#123;java.version&#125; and os.name = $&#123;os.name&#125;.");</span></span><br><span class="line"><span class="comment"> * &lt;/pre&gt;</span></span><br><span class="line"><span class="comment"> 这个类的典型用法遵循以下模式：首先创建一个实例并用包含可用变量值的映射初始化。如果变量的前缀和/或后缀不是默认的，则可以执行适当的设置。之后，可以调用&lt;code&gt;replace（）&lt;/code&gt;方法，传入源文本进行插值。在返回的文本中，所有变量引用（只要它们的值已知）都将被解析。</span></span><br><span class="line"><span class="comment"> * 下面的示例演示了这一点：</span></span><br><span class="line"><span class="comment"> </span></span><br><span class="line"><span class="comment"> * &lt;pre&gt;</span></span><br><span class="line"><span class="comment"> * Map valuesMap = HashMap();</span></span><br><span class="line"><span class="comment"> * valuesMap.put(&amp;quot;animal&amp;quot;, &amp;quot;quick brown fox&amp;quot;);</span></span><br><span class="line"><span class="comment"> * valuesMap.put(&amp;quot;target&amp;quot;, &amp;quot;lazy dog&amp;quot;);</span></span><br><span class="line"><span class="comment"> * String templateString = &amp;quot;The $&#123;animal&#125; jumped over the $&#123;target&#125;.&amp;quot;;</span></span><br><span class="line"><span class="comment"> * StrSubstitutor sub = new StrSubstitutor(valuesMap);</span></span><br><span class="line"><span class="comment"> * String resolvedString = sub.replace(templateString);</span></span><br><span class="line"><span class="comment"> * &lt;/pre&gt;</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">此外，此类还允许为未解析变量设置默认值。</span></span><br><span class="line"><span class="comment">变量的默认值可以追加到变量名后的变量默认值分隔符之后。</span></span><br><span class="line"><span class="comment">变量default value delimiter的默认值是“：-”，就像bash和其他*nix shell中一样，因为可以说，这些shell是默认$&#123;&#125;分隔符集的起源地。可以通过调用&#123;@link#setValueDelimiterMatcher（StrMatcher）&#125;、&#123;@link#setValueDelimiter（char）&#125;或&#123;@link\#setValueDelimiter（String）&#125;手动设置变量default value delimiter。</span></span><br><span class="line"><span class="comment"> * 下面显示了一个具有变量默认值设置的示例：</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">* &lt;pre&gt;</span></span><br><span class="line"><span class="comment"> * Map valuesMap = HashMap();</span></span><br><span class="line"><span class="comment"> * valuesMap.put(&amp;quot;animal&amp;quot;, &amp;quot;quick brown fox&amp;quot;);</span></span><br><span class="line"><span class="comment"> * valuesMap.put(&amp;quot;target&amp;quot;, &amp;quot;lazy dog&amp;quot;);</span></span><br><span class="line"><span class="comment"> * String templateString = &amp;quot;The $&#123;animal&#125; jumped over the $&#123;target&#125;. $&#123;undefined.number:-1234567890&#125;.&amp;quot;;</span></span><br><span class="line"><span class="comment"> * StrSubstitutor sub = new StrSubstitutor(valuesMap);</span></span><br><span class="line"><span class="comment"> * String resolvedString = sub.replace(templateString);</span></span><br><span class="line"><span class="comment"> * &lt;/pre&gt;</span></span><br><span class="line"><span class="comment"> </span></span><br><span class="line"><span class="comment"> 除了这种使用模式，还有一些静态的方便方法，它们涵盖了最常见的用例。这些方法无需手动创建实例即可使用。但是，如果要执行多个替换操作，则创建和重用此类的实例将更加高效。</span></span><br><span class="line"><span class="comment"> 变量替换以递归方式工作。因此，如果变量值包含变量，则该变量也将被替换。检测到循环替换，并将导致引发异常。</span></span><br><span class="line"><span class="comment"> </span></span><br><span class="line"><span class="comment">有时插值的结果必须包含可变前缀。以以下源文本为例：</span></span><br><span class="line"><span class="comment">The variable $&#123;$&#123;name&#125;&#125; must be used.</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">在这里，只有文本中引用的变量名才应该被替换为文本（假设&lt;code&gt;name&lt;/code&gt;变量的值是&lt;code&gt;x&lt;/code&gt;）：</span></span><br><span class="line"><span class="comment"> * &lt;pre&gt;</span></span><br><span class="line"><span class="comment"> *   The variable $&#123;x&#125; must be used.</span></span><br><span class="line"><span class="comment"> * &lt;/pre&gt;</span></span><br><span class="line"><span class="comment"> </span></span><br><span class="line"><span class="comment"> 要达到这种效果，有两种可能：为不与要生成的结果文本冲突的变量设置不同的前缀和后缀。另一种可能是使用转义符，默认为“$”。如果此字符放在变量引用之前，此引用将被忽略且不会被替换。例如：</span></span><br><span class="line"><span class="comment"> </span></span><br><span class="line"><span class="comment"> * &lt;pre&gt;</span></span><br><span class="line"><span class="comment"> *   The variable $$&#123;$&#123;name&#125;&#125; must be used.</span></span><br><span class="line"><span class="comment"> * &lt;/pre&gt;</span></span><br><span class="line"><span class="comment"> 例如，在一些复杂的场景中，您甚至可能希望在变量名称中执行替换</span></span><br><span class="line"><span class="comment">  * &lt;pre&gt;</span></span><br><span class="line"><span class="comment"> * $&#123;jre-$&#123;java.specification.version&#125;&#125;</span></span><br><span class="line"><span class="comment"> * &lt;/pre&gt;</span></span><br><span class="line"><span class="comment"> &lt;code&gt;StrSubstitutor&lt;/code&gt;在变量名中支持这种递归替换，但必须通过将&#123;@link#setEnableSubstitutionConstances（boolean）enableSubstitutionConstances&#125;属性设置为&lt;b&gt;true&lt;/b&gt;来显式启用它。</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure>

<h5 id="StrLookup"><a href="#StrLookup" class="headerlink" title="StrLookup"></a>StrLookup</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//查找字符串值的字符串键。</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">此类表示字符串到字符串映射的最简单形式。它比map有一个优点，它可以根据需要根据密钥创建结果。</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">这个类带有各种工厂方法。如果这些还不够，您可以子类化并实现自己的匹配器。</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">例如，可以实现一个使用该键作为主键的查找，并根据需要从数据库中查找值</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">查找字符串值的字符串键。</span></span><br><span class="line"><span class="comment">内部实现可以使用任何机制来返回值。最简单的实现是使用映射。然而，实际上任何实施都是可能的。</span></span><br><span class="line"><span class="comment">例如，可以实现一个将键用作主键的查找，并根据需要从数据库中查找值；或者，可以创建一个基于数字的实现，将键视为整数，增加值并将结果作为字符串返回-将1转换为2，15到16等。</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">不管基础数据是什么，此方法总是通过必要的转换来返回字符串。例如：</span></span><br><span class="line"><span class="comment"> * &lt;pre&gt;</span></span><br><span class="line"><span class="comment">     * Map&lt;String, Object&gt; map = new HashMap&lt;String, Object&gt;();</span></span><br><span class="line"><span class="comment">     * map.put("number", new Integer(2));</span></span><br><span class="line"><span class="comment">     * assertEquals("2", StrLookup.mapLookup(map).lookup("number"));</span></span><br><span class="line"><span class="comment">     * &lt;/pre&gt;</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="comment">//key要查找的键，可以为null</span></span><br><span class="line">  <span class="function">String <span class="title">lookup</span><span class="params">(String key)</span></span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">查找可能使用当前LogEvent的字符串值的字符串键。</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line">  <span class="function">String <span class="title">lookup</span><span class="params">(LogEvent event, String key)</span></span>;</span><br></pre></td></tr></table></figure>





<h3 id="MBeanServer"><a href="#MBeanServer" class="headerlink" title="MBeanServer"></a>MBeanServer</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">继承 MBeanServerConnection:此接口表示与MBean服务器（无论是本地服务器还是远程服务器）的通信方式。&#123;<span class="meta">@link</span> MBeanServer&#125;接口（表示本地MBean服务器）扩展了此接口。</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">这是代理端MBean操作的接口。它包含创建、注册和删除mbean所需的方法，以及已注册mbean的访问方法。这是JMX基础设施的核心组件。</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">用户代码通常不实现此接口。相反，实现这个接口的对象是通过&#123;@link中的一个方法获得的javax.management.MBeanServerFactory&#125;class。</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">添加到MBean服务器的每个MBean都变得可管理：其属性和操作可以通过连接到该MBean服务器的连接器/适配器远程访问。Java对象不能在MBean服务器中注册，除非它是符合JMX的MBean。</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">When an MBean is registered or unregistered in the MBean server a &#123;@link javax.management.MBeanServerNotification MBeanServerNotification&#125; Notification is emitted. To register an object as listener to MBeanServerNotifications you should call the MBean server method &#123;@link #addNotificationListener addNotificationListener&#125; with &lt;CODE&gt;ObjectName&lt;/CODE&gt; the &lt;CODE&gt;ObjectName&lt;/CODE&gt; of the &#123;@link javax.management.MBeanServerDelegate MBeanServerDelegate&#125;.  This &lt;CODE&gt;ObjectName&lt;/CODE&gt; is: &lt;BR&gt; &lt;CODE&gt;JMImplementation:type=MBeanServerDelegate&lt;/CODE&gt;</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure>



<h1 id="源码流程"><a href="#源码流程" class="headerlink" title="源码流程"></a>源码流程</h1><h3 id="工厂获取"><a href="#工厂获取" class="headerlink" title="工厂获取"></a>工厂获取</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">LogManager静态代码块执行</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">扫描classpath以找到所有日志实现。目前，只有一个将被使用，但这可以扩展到允许使用多个实现。</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">static</span> &#123;</span><br><span class="line">        <span class="comment">//强制指定日志实现的快捷绑定。</span></span><br><span class="line">    <span class="comment">//log4j2.component.properties（使用容器存起来），log4j2.system.properties（往系统属性里面存），classpath下面找这个文件并把他们读取变成 两个Properties存起来，但是后者不会覆盖系统资源的默认值 </span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">//除此之外 ServiceLoader.load(PropertySource.class, classLoader)) 干了活</span></span><br><span class="line">    <span class="comment">// private static final String PREFIX = "META-INF/services/";</span></span><br><span class="line">    <span class="comment">// 例子：意思就是去META-INF/services/路径下找org.apache.logging.log4j.util.PropertySource</span></span><br><span class="line">    <span class="comment">//这个文件，然后实例化</span></span><br><span class="line">        <span class="keyword">final</span> PropertiesUtil managerProps = PropertiesUtil.getProperties();</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//,从已经加载好配置文件的缓存中获取key为log4j2.loggerContextFactory的value值</span></span><br><span class="line">        <span class="keyword">final</span> String factoryClassName = managerProps.getStringProperty(FACTORY_PROPERTY_NAME);</span><br><span class="line">    </span><br><span class="line">        <span class="keyword">if</span> (factoryClassName != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                factory = LoaderUtil.newCheckedInstanceOf(factoryClassName, LoggerContextFactory<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">            &#125; <span class="keyword">catch</span> (<span class="keyword">final</span> ClassNotFoundException cnfe) &#123;</span><br><span class="line">                LOGGER.error(<span class="string">"Unable to locate configured LoggerContextFactory &#123;&#125;"</span>, factoryClassName);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (<span class="keyword">final</span> Exception ex) &#123;</span><br><span class="line">                LOGGER.error(<span class="string">"Unable to create configured LoggerContextFactory &#123;&#125;"</span>, factoryClassName, ex);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (factory == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">final</span> SortedMap&lt;Integer, LoggerContextFactory&gt; factories = <span class="keyword">new</span> TreeMap&lt;&gt;();</span><br><span class="line">            <span class="comment">// note that the following initial call to ProviderUtil may block until a Provider has been installed when</span></span><br><span class="line">            <span class="comment">// running in an OSGi environment</span></span><br><span class="line">            </span><br><span class="line">            <span class="comment">//去META-INF/services/路径下找org.apache.logging.log4j.spi.Provider</span></span><br><span class="line">    <span class="comment">//这个文件，然后根据里面的具体子类实现路径进行实例化</span></span><br><span class="line">            <span class="comment">//实例化好了之后META-INF/log4j-provider.properties文件找提供provider的实例</span></span><br><span class="line">            <span class="comment">//</span></span><br><span class="line">            <span class="keyword">if</span> (ProviderUtil.hasProviders()) &#123;</span><br><span class="line">                </span><br><span class="line">                <span class="keyword">for</span> (<span class="keyword">final</span> Provider provider : ProviderUtil.getProviders()) &#123;</span><br><span class="line">                    <span class="keyword">final</span> Class&lt;? extends LoggerContextFactory&gt; factoryClass = provider.loadLoggerContextFactory();</span><br><span class="line">                    <span class="keyword">if</span> (factoryClass != <span class="keyword">null</span>) &#123;</span><br><span class="line">                        <span class="keyword">try</span> &#123;</span><br><span class="line">                            factories.put(provider.getPriority(), factoryClass.newInstance());</span><br><span class="line">                        &#125; <span class="keyword">catch</span> (<span class="keyword">final</span> Exception e) &#123;</span><br><span class="line">                            LOGGER.error(<span class="string">"Unable to create class &#123;&#125; specified in provider URL &#123;&#125;"</span>, factoryClass.getName(), provider</span><br><span class="line">                                    .getUrl(), e);</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (factories.isEmpty()) &#123;</span><br><span class="line">                    LOGGER.error(<span class="string">"Log4j2 could not find a logging implementation. "</span></span><br><span class="line">                            + <span class="string">"Please add log4j-core to the classpath. Using SimpleLogger to log to the console..."</span>);</span><br><span class="line">                    factory = <span class="keyword">new</span> SimpleLoggerContextFactory();</span><br><span class="line">                &#125; <span class="keyword">else</span> <span class="keyword">if</span> (factories.size() == <span class="number">1</span>) &#123;</span><br><span class="line">                    factory = factories.get(factories.lastKey());</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="keyword">final</span> StringBuilder sb = <span class="keyword">new</span> StringBuilder(<span class="string">"Multiple logging implementations found: \n"</span>);</span><br><span class="line">                    <span class="keyword">for</span> (<span class="keyword">final</span> Map.Entry&lt;Integer, LoggerContextFactory&gt; entry : factories.entrySet()) &#123;</span><br><span class="line">                        sb.append(<span class="string">"Factory: "</span>).append(entry.getValue().getClass().getName());</span><br><span class="line">                        sb.append(<span class="string">", Weighting: "</span>).append(entry.getKey()).append(<span class="string">'\n'</span>);</span><br><span class="line">                    &#125;</span><br><span class="line">                    factory = factories.get(factories.lastKey());</span><br><span class="line">                    sb.append(<span class="string">"Using factory: "</span>).append(factory.getClass().getName());</span><br><span class="line">                    LOGGER.warn(sb.toString());</span><br><span class="line"></span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                LOGGER.error(<span class="string">"Log4j2 could not find a logging implementation. "</span></span><br><span class="line">                        + <span class="string">"Please add log4j-core to the classpath. Using SimpleLogger to log to the console..."</span>);</span><br><span class="line">                factory = <span class="keyword">new</span> SimpleLoggerContextFactory();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>



<h5 id="工厂的初始化"><a href="#工厂的初始化" class="headerlink" title="工厂的初始化"></a>工厂的初始化</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">  selector= <span class="keyword">new</span> ClassLoaderContextSelector();</span><br><span class="line">    shutdownCallbackRegistry= <span class="keyword">new</span> DefaultShutdownCallbackRegistry();</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">Log4jContextFactory</span><span class="params">(<span class="keyword">final</span> ContextSelector selector,</span></span></span><br><span class="line"><span class="function"><span class="params">                               <span class="keyword">final</span> ShutdownCallbackRegistry shutdownCallbackRegistry)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.selector = Objects.requireNonNull(selector, <span class="string">"No ContextSelector provided"</span>);</span><br><span class="line">        <span class="keyword">this</span>.shutdownCallbackRegistry = Objects.requireNonNull(shutdownCallbackRegistry, <span class="string">"No ShutdownCallbackRegistry provided"</span>);</span><br><span class="line">        LOGGER.debug(<span class="string">"Using ShutdownCallbackRegistry &#123;&#125;"</span>, shutdownCallbackRegistry.getClass());</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//这里其实就是创建了一个Thread对象，然后去管理这个thread对象</span></span><br><span class="line">        initializeShutdownCallbackRegistry();</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>工厂的获取是利用Provider的服务自动发现 来找到 工厂具体类型</p>
<h3 id="LoggerContext的获取"><a href="#LoggerContext的获取" class="headerlink" title="LoggerContext的获取"></a>LoggerContext的获取</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">log4j2的工厂是Log4jContextFactory</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> LoggerContext <span class="title">getContext</span><span class="params">(<span class="keyword">final</span> <span class="keyword">boolean</span> currentContext)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// <span class="doctag">TODO:</span> would it be a terrible idea to try and find the caller ClassLoader here?</span></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> factory.getContext(FQCN, <span class="keyword">null</span>, <span class="keyword">null</span>, currentContext, <span class="keyword">null</span>, <span class="keyword">null</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (<span class="keyword">final</span> IllegalStateException ex) &#123;</span><br><span class="line">            LOGGER.warn(ex.getMessage() + <span class="string">" Using SimpleLogger"</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> SimpleLoggerContextFactory().getContext(FQCN, <span class="keyword">null</span>, <span class="keyword">null</span>, currentContext, <span class="keyword">null</span>, <span class="keyword">null</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> LoggerContext <span class="title">getContext</span><span class="params">(<span class="keyword">final</span> String fqcn, <span class="keyword">final</span> ClassLoader loader, <span class="keyword">final</span> Object externalContext,</span></span></span><br><span class="line"><span class="function"><span class="params">                                    <span class="keyword">final</span> <span class="keyword">boolean</span> currentContext, <span class="keyword">final</span> URI configLocation, <span class="keyword">final</span> String name)</span> </span>&#123;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//通过选择器获取LoggerContext</span></span><br><span class="line">        <span class="keyword">final</span> LoggerContext ctx = selector.getContext(fqcn, loader, currentContext, configLocation);</span><br><span class="line">        <span class="keyword">if</span> (externalContext != <span class="keyword">null</span> &amp;&amp; ctx.getExternalContext() == <span class="keyword">null</span>) &#123;</span><br><span class="line">            ctx.setExternalContext(externalContext);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (name != <span class="keyword">null</span>) &#123;</span><br><span class="line">        	ctx.setName(name);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (ctx.getState() == LifeCycle.State.INITIALIZED) &#123;</span><br><span class="line">            <span class="keyword">if</span> (configLocation != <span class="keyword">null</span> || name != <span class="keyword">null</span>) &#123;</span><br><span class="line">                ContextAnchor.THREAD_CONTEXT.set(ctx);</span><br><span class="line">                <span class="keyword">final</span> Configuration config = ConfigurationFactory.getInstance().getConfiguration(ctx, name, configLocation);</span><br><span class="line">                LOGGER.debug(<span class="string">"Starting LoggerContext[name=&#123;&#125;] from configuration at &#123;&#125;"</span>, ctx.getName(), configLocation);</span><br><span class="line">                ctx.start(config);</span><br><span class="line">                ContextAnchor.THREAD_CONTEXT.remove();</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                ctx.start();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> ctx;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"> <span class="function"><span class="keyword">public</span> LoggerContext <span class="title">getContext</span><span class="params">(<span class="keyword">final</span> String fqcn, <span class="keyword">final</span> ClassLoader loader, <span class="keyword">final</span> <span class="keyword">boolean</span> currentContext,</span></span></span><br><span class="line"><span class="function"><span class="params">            <span class="keyword">final</span> URI configLocation)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (currentContext) &#123;</span><br><span class="line">            <span class="comment">//一般为fasle</span></span><br><span class="line">            <span class="comment">//当前线程的LoggerContext的锚点。，从线程本地获取LoggerContext，如果没有</span></span><br><span class="line">            <span class="keyword">final</span> LoggerContext ctx = ContextAnchor.THREAD_CONTEXT.get();</span><br><span class="line">            <span class="keyword">if</span> (ctx != <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">return</span> ctx;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> getDefault();</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (loader != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> locateContext(loader, configLocation);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">final</span> Class&lt;?&gt; clazz = StackLocatorUtil.getCallerClass(fqcn);</span><br><span class="line">            <span class="keyword">if</span> (clazz != <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="comment">//clazz不为空，根据位置获取LoggerContext</span></span><br><span class="line">                <span class="keyword">return</span> locateContext(clazz.getClassLoader(), configLocation);</span><br><span class="line">            &#125;</span><br><span class="line">        </span><br><span class="line">            <span class="keyword">final</span> LoggerContext lc = ContextAnchor.THREAD_CONTEXT.get();</span><br><span class="line">            <span class="keyword">if</span> (lc != <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">return</span> lc;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> getDefault();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"> <span class="function"><span class="keyword">private</span> LoggerContext <span class="title">locateContext</span><span class="params">(<span class="keyword">final</span> ClassLoader loaderOrNull, <span class="keyword">final</span> URI configLocation)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// LOG4J2-477: class loader may be null</span></span><br><span class="line">        <span class="keyword">final</span> ClassLoader loader = loaderOrNull != <span class="keyword">null</span> ? loaderOrNull : ClassLoader.getSystemClassLoader();</span><br><span class="line">     <span class="comment">//获取LoggerContext的名字，以后好做映射</span></span><br><span class="line">        <span class="keyword">final</span> String name = toContextMapKey(loader);</span><br><span class="line">     </span><br><span class="line">        AtomicReference&lt;WeakReference&lt;LoggerContext&gt;&gt; ref = CONTEXT_MAP.get(name);</span><br><span class="line">        <span class="keyword">if</span> (ref == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (configLocation == <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="comment">//获取父的 类加载器</span></span><br><span class="line">                ClassLoader parent = loader.getParent();</span><br><span class="line">                <span class="keyword">while</span> (parent != <span class="keyword">null</span>) &#123;</span><br><span class="line">					<span class="comment">//名字重新获取</span></span><br><span class="line">                    ref = CONTEXT_MAP.get(toContextMapKey(parent));</span><br><span class="line">                    <span class="keyword">if</span> (ref != <span class="keyword">null</span>) &#123;</span><br><span class="line">                        <span class="keyword">final</span> WeakReference&lt;LoggerContext&gt; r = ref.get();</span><br><span class="line">                        <span class="keyword">final</span> LoggerContext ctx = r.get();</span><br><span class="line">                        <span class="keyword">if</span> (ctx != <span class="keyword">null</span>) &#123;</span><br><span class="line">                            <span class="keyword">return</span> ctx;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="comment">//迭代到根加载器</span></span><br><span class="line">                    parent = parent.getParent();</span><br><span class="line">                    <span class="comment">/*  In Tomcat 6 the parent of the JSP classloader is the webapp classloader which would be configured by the WebAppContextListener. The WebAppClassLoader is also the ThreadContextClassLoader.</span></span><br><span class="line"><span class="comment">                    在tomcat6中，JSP类加载器的父类是webapp类加载器，它将由WebAppContextListener配置。WebAppClassLoader也是ThreadContextClassLoader。</span></span><br><span class="line"><span class="comment">                    </span></span><br><span class="line"><span class="comment">                    In JBoss 5 the parent of the JSP ClassLoader is the WebAppClassLoader which is also the ThreadContextClassLoader. However, the parent of the WebAppClassLoader is the ClassLoader that is configured by the WebAppContextListener.</span></span><br><span class="line"><span class="comment">					在jboss5中，JSP类加载器的父类是WebAppClassLoader，它也是ThreadContextClassLoader。但是，WebAppClassLoader的父级是WebAppContextListener配置的类加载器。</span></span><br><span class="line"><span class="comment">					</span></span><br><span class="line"><span class="comment">                    ClassLoader threadLoader = null;</span></span><br><span class="line"><span class="comment">                    try &#123;</span></span><br><span class="line"><span class="comment">                        threadLoader = Thread.currentThread().getContextClassLoader();</span></span><br><span class="line"><span class="comment">                    &#125; catch (Exception ex) &#123;</span></span><br><span class="line"><span class="comment">                        // Ignore SecurityException</span></span><br><span class="line"><span class="comment">                    &#125;</span></span><br><span class="line"><span class="comment">                    if (threadLoader != null &amp;&amp; threadLoader == parent) &#123;</span></span><br><span class="line"><span class="comment">                        break;</span></span><br><span class="line"><span class="comment">                    &#125; else &#123;</span></span><br><span class="line"><span class="comment">                        parent = parent.getParent();</span></span><br><span class="line"><span class="comment">                    &#125; */</span></span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">//如果父ClassLoader命名的加载器拿不到，那么使用此ClassLoader命名创建一个 LoggerContext</span></span><br><span class="line">            LoggerContext ctx = createContext(name, configLocation);</span><br><span class="line">            <span class="comment">//存入缓存</span></span><br><span class="line">            LoggerContext newContext = CONTEXT_MAP.computeIfAbsent(name,</span><br><span class="line">                    k -&gt; <span class="keyword">new</span> AtomicReference&lt;&gt;(<span class="keyword">new</span> WeakReference&lt;&gt;(ctx))).get().get();</span><br><span class="line">            <span class="keyword">if</span> (newContext == ctx) &#123;</span><br><span class="line">                <span class="comment">//添加关闭监听</span></span><br><span class="line">                ctx.addShutdownListener(<span class="keyword">this</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> newContext;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">final</span> WeakReference&lt;LoggerContext&gt; weakRef = ref.get();</span><br><span class="line">        LoggerContext ctx = weakRef.get();</span><br><span class="line">        <span class="keyword">if</span> (ctx != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (ctx.getConfigLocation() == <span class="keyword">null</span> &amp;&amp; configLocation != <span class="keyword">null</span>) &#123;</span><br><span class="line">                LOGGER.debug(<span class="string">"Setting configuration to &#123;&#125;"</span>, configLocation);</span><br><span class="line">                ctx.setConfigLocation(configLocation);</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (ctx.getConfigLocation() != <span class="keyword">null</span> &amp;&amp; configLocation != <span class="keyword">null</span></span><br><span class="line">                    &amp;&amp; !ctx.getConfigLocation().equals(configLocation)) &#123;</span><br><span class="line">                LOGGER.warn(<span class="string">"locateContext called with URI &#123;&#125;. Existing LoggerContext has URI &#123;&#125;"</span>, configLocation,</span><br><span class="line">                        ctx.getConfigLocation());</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> ctx;</span><br><span class="line">        &#125;</span><br><span class="line">        ctx = createContext(name, configLocation);</span><br><span class="line">        ref.compareAndSet(weakRef, <span class="keyword">new</span> WeakReference&lt;&gt;(ctx));</span><br><span class="line">        <span class="keyword">return</span> ctx;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">LoggerContext</span><span class="params">(<span class="keyword">final</span> String name, <span class="keyword">final</span> Object externalContext, <span class="keyword">final</span> URI configLocn)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.contextName = name;</span><br><span class="line">        <span class="keyword">if</span> (externalContext == <span class="keyword">null</span>) &#123;</span><br><span class="line">            externalMap.remove(EXTERNAL_CONTEXT_KEY);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            externalMap.put(EXTERNAL_CONTEXT_KEY, externalContext);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">this</span>.configLocation = configLocn;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">最后启动</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">start</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        LOGGER.debug(<span class="string">"Starting LoggerContext[name=&#123;&#125;, &#123;&#125;]..."</span>, getName(), <span class="keyword">this</span>);</span><br><span class="line">        <span class="keyword">if</span> (PropertiesUtil.getProperties().getBooleanProperty(<span class="string">"log4j.LoggerContext.stacktrace.on.start"</span>, <span class="keyword">false</span>)) &#123;</span><br><span class="line">            LOGGER.debug(<span class="string">"Stack trace to locate invoker"</span>,</span><br><span class="line">                    <span class="keyword">new</span> Exception(<span class="string">"Not a real error, showing stack trace to locate invoker"</span>));</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (configLock.tryLock()) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="keyword">if</span> (<span class="keyword">this</span>.isInitialized() || <span class="keyword">this</span>.isStopped()) &#123;</span><br><span class="line">                    <span class="keyword">this</span>.setStarting();</span><br><span class="line">                    <span class="comment">//重新配置上下文。Log4j在重新配置期间不会删除记录器。Log4j将创建新的LoggerConfig对象，Log4j将把记录器指向新的LoggerConfigs。Log4j将释放旧的LoggerConfig，以及旧的appender和过滤器。</span></span><br><span class="line">                    reconfigure();</span><br><span class="line">                    <span class="keyword">if</span> (<span class="keyword">this</span>.configuration.isShutdownHookEnabled()) &#123;</span><br><span class="line">                        setUpShutdownHook();</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">this</span>.setStarted();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                configLock.unlock();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        LOGGER.debug(<span class="string">"LoggerContext[name=&#123;&#125;, &#123;&#125;] started OK."</span>, getName(), <span class="keyword">this</span>);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>





<h3 id="Logger获取"><a href="#Logger获取" class="headerlink" title="Logger获取"></a>Logger获取</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> Logger <span class="title">getLogger</span><span class="params">(<span class="keyword">final</span> String name, <span class="keyword">final</span> MessageFactory messageFactory)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// Note: This is the only method where we add entries to the 'loggerRegistry' ivar.</span></span><br><span class="line">        Logger logger = loggerRegistry.getLogger(name, messageFactory);</span><br><span class="line">        <span class="keyword">if</span> (logger != <span class="keyword">null</span>) &#123;</span><br><span class="line">            AbstractLogger.checkMessageFactory(logger, messageFactory);</span><br><span class="line">            <span class="keyword">return</span> logger;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    </span><br><span class="line">        logger = newInstance(<span class="keyword">this</span>, name, messageFactory);</span><br><span class="line">    </span><br><span class="line">        loggerRegistry.putIfAbsent(name, messageFactory, logger);</span><br><span class="line">    <span class="comment">//这里可以更具消息工厂名字的不同来选择一个具体的logger</span></span><br><span class="line">        <span class="keyword">return</span> loggerRegistry.getLogger(name, messageFactory);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">注意咯，这里子类可以覆盖 如果需要更换那就需要更换 选择器contextSelector</span><br><span class="line">   <span class="function"><span class="keyword">protected</span> Logger <span class="title">newInstance</span><span class="params">(<span class="keyword">final</span> LoggerContext ctx, <span class="keyword">final</span> String name, <span class="keyword">final</span> MessageFactory messageFactory)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> Logger(ctx, name, messageFactory);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>





<h3 id="执行："><a href="#执行：" class="headerlink" title="执行："></a>执行：</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">调用到 AbstractLogger 的</span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">error</span><span class="params">(<span class="keyword">final</span> String message)</span> </span>&#123;</span><br><span class="line">        logIfEnabled(FQCN, Level.ERROR, <span class="keyword">null</span>, message, (Throwable) <span class="keyword">null</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"> <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">logIfEnabled</span><span class="params">(<span class="keyword">final</span> String fqcn, <span class="keyword">final</span> Level level, <span class="keyword">final</span> Marker marker, <span class="keyword">final</span> String message,</span></span></span><br><span class="line"><span class="function"><span class="params">            <span class="keyword">final</span> Throwable t)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (isEnabled(level, marker, message, t)) &#123;</span><br><span class="line">            logMessage(fqcn, level, marker, message, t);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">logMessage</span><span class="params">(<span class="keyword">final</span> String fqcn, <span class="keyword">final</span> Level level, <span class="keyword">final</span> Marker marker, <span class="keyword">final</span> String message,</span></span></span><br><span class="line"><span class="function"><span class="params">            <span class="keyword">final</span> Throwable t)</span> </span>&#123;</span><br><span class="line">        logMessageSafely(fqcn, level, marker, messageFactory.newMessage(message), t);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@PerformanceSensitive</span></span><br><span class="line">    <span class="comment">// <span class="doctag">NOTE:</span> This is a hot method. Current implementation compiles to 30 bytes of byte code.</span></span><br><span class="line">    <span class="comment">// This is within the 35 byte MaxInlineSize threshold. Modify with care!</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">logMessageSafely</span><span class="params">(<span class="keyword">final</span> String fqcn, <span class="keyword">final</span> Level level, <span class="keyword">final</span> Marker marker, <span class="keyword">final</span> Message msg,</span></span></span><br><span class="line"><span class="function"><span class="params">            <span class="keyword">final</span> Throwable throwable)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            logMessageTrackRecursion(fqcn, level, marker, msg, throwable);</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            <span class="comment">// LOG4J2-1583 prevent scrambled logs when logging calls are nested (logging in toString())</span></span><br><span class="line">            <span class="comment">//如果消息是 可以可回收重用的，那么就回收</span></span><br><span class="line">            ReusableMessageFactory.release(msg);</span><br><span class="line">            </span><br><span class="line">            <span class="comment">//消息重用机制就是 当前线程中保存一个 threadlocal对象做为key，消息作为value</span></span><br><span class="line">            <span class="comment">//因为一个线程每次只能处理一条消息</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@PerformanceSensitive</span></span><br><span class="line">    <span class="comment">// <span class="doctag">NOTE:</span> This is a hot method. Current implementation compiles to 33 bytes of byte code.</span></span><br><span class="line">    <span class="comment">// This is within the 35 byte MaxInlineSize threshold. Modify with care!</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">logMessageTrackRecursion</span><span class="params">(<span class="keyword">final</span> String fqcn,</span></span></span><br><span class="line"><span class="function"><span class="params">                                          <span class="keyword">final</span> Level level,</span></span></span><br><span class="line"><span class="function"><span class="params">                                          <span class="keyword">final</span> Marker marker,</span></span></span><br><span class="line"><span class="function"><span class="params">                                          <span class="keyword">final</span> Message msg,</span></span></span><br><span class="line"><span class="function"><span class="params">                                          <span class="keyword">final</span> Throwable throwable)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            增加一次栈深度</span><br><span class="line">            incrementRecursionDepth(); <span class="comment">// LOG4J2-1518, LOG4J2-2031</span></span><br><span class="line">            tryLogMessage(fqcn, getLocation(fqcn), level, marker, msg, throwable);</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            减少一次栈深度</span><br><span class="line">            decrementRecursionDepth();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">tryLogMessage</span><span class="params">(<span class="keyword">final</span> String fqcn,</span></span></span><br><span class="line"><span class="function"><span class="params">                               <span class="keyword">final</span> StackTraceElement location,</span></span></span><br><span class="line"><span class="function"><span class="params">                               <span class="keyword">final</span> Level level,</span></span></span><br><span class="line"><span class="function"><span class="params">                               <span class="keyword">final</span> Marker marker,</span></span></span><br><span class="line"><span class="function"><span class="params">                               <span class="keyword">final</span> Message msg,</span></span></span><br><span class="line"><span class="function"><span class="params">                               <span class="keyword">final</span> Throwable throwable)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            记录日志</span><br><span class="line">            log(level, marker, fqcn, location, msg, throwable);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (<span class="keyword">final</span> Exception e) &#123;</span><br><span class="line">            <span class="comment">// LOG4J2-1990 Log4j2 suppresses all exceptions that occur once application called the logger</span></span><br><span class="line">            <span class="comment">//处理异常</span></span><br><span class="line">            handleLogMessageException(e, fqcn, msg);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  <span class="comment">//具体logger的isEnabled调用，当然也可以使用包一层的方式 在内部调用具体的isenabled，为了适配</span></span><br><span class="line"><span class="comment">//所以一个logger对应一个filter</span></span><br><span class="line"> <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">isEnabled</span><span class="params">(<span class="keyword">final</span> Level level, <span class="keyword">final</span> Marker marker, <span class="keyword">final</span> String message, <span class="keyword">final</span> Throwable t)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> privateConfig.filter(level, marker, message, t);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">boolean</span> <span class="title">filter</span><span class="params">(<span class="keyword">final</span> Level level, <span class="keyword">final</span> Marker marker, <span class="keyword">final</span> String msg, <span class="keyword">final</span> Throwable t)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">final</span> Filter filter = config.getFilter();</span><br><span class="line">            <span class="keyword">if</span> (filter != <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">final</span> Filter.Result r = filter.filter(logger, level, marker, (Object) msg, t);</span><br><span class="line">                <span class="keyword">if</span> (r != Filter.Result.NEUTRAL) &#123;</span><br><span class="line">                    <span class="keyword">return</span> r == Filter.Result.ACCEPT;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> level != <span class="keyword">null</span> &amp;&amp; intLevel &gt;= level.intLevel();</span><br><span class="line">        &#125;</span><br></pre></td></tr></table></figure>





<h5 id="真正log4j2的日志处理"><a href="#真正log4j2的日志处理" class="headerlink" title="真正log4j2的日志处理"></a>真正log4j2的日志处理</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br></pre></td><td class="code"><pre><span class="line">  </span><br><span class="line">同步的</span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">log</span><span class="params">(<span class="keyword">final</span> Level level, <span class="keyword">final</span> Marker marker, <span class="keyword">final</span> String fqcn, <span class="keyword">final</span> StackTraceElement location,</span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="keyword">final</span> Message message, <span class="keyword">final</span> Throwable throwable)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">final</span> ReliabilityStrategy strategy = privateConfig.loggerConfig.getReliabilityStrategy();</span><br><span class="line">        <span class="keyword">if</span> (strategy <span class="keyword">instanceof</span> LocationAwareReliabilityStrategy) &#123;</span><br><span class="line">           <span class="comment">// strategy一般默认为DefaultReliabilityStrategy（继承LocationAwareReliabilityStrategy）</span></span><br><span class="line">            ((LocationAwareReliabilityStrategy) strategy).log(<span class="keyword">this</span>, getName(), fqcn, location, marker, level,</span><br><span class="line">                message, throwable);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            strategy.log(<span class="keyword">this</span>, getName(), fqcn, marker, level, message, throwable);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">log</span><span class="params">(<span class="keyword">final</span> Supplier&lt;LoggerConfig&gt; reconfigured, <span class="keyword">final</span> String loggerName, <span class="keyword">final</span> String fqcn,</span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="keyword">final</span> StackTraceElement location, <span class="keyword">final</span> Marker marker, <span class="keyword">final</span> Level level, <span class="keyword">final</span> Message data,</span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="keyword">final</span> Throwable t)</span> </span>&#123;</span><br><span class="line">        loggerConfig.log(loggerName, fqcn, location, marker, level, data, t);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@PerformanceSensitive</span>(<span class="string">"allocation"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">log</span><span class="params">(<span class="keyword">final</span> String loggerName, <span class="keyword">final</span> String fqcn, <span class="keyword">final</span> StackTraceElement location, <span class="keyword">final</span> Marker marker,</span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="keyword">final</span> Level level, <span class="keyword">final</span> Message data, <span class="keyword">final</span> Throwable t)</span> </span>&#123;</span><br><span class="line">        List&lt;Property&gt; props = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">if</span> (!propertiesRequireLookup) &#123;</span><br><span class="line">            props = properties;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (properties != <span class="keyword">null</span>) &#123;</span><br><span class="line">                props = <span class="keyword">new</span> ArrayList&lt;&gt;(properties.size());</span><br><span class="line">                <span class="keyword">final</span> LogEvent event = Log4jLogEvent.newBuilder()</span><br><span class="line">                    .setMessage(data)</span><br><span class="line">                    .setMarker(marker)</span><br><span class="line">                    .setLevel(level)</span><br><span class="line">                    .setLoggerName(loggerName)</span><br><span class="line">                    .setLoggerFqcn(fqcn)</span><br><span class="line">                    .setThrown(t)</span><br><span class="line">                    .build();</span><br><span class="line">                <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; properties.size(); i++) &#123;</span><br><span class="line">                    <span class="keyword">final</span> Property prop = properties.get(i);</span><br><span class="line">                    <span class="keyword">final</span> String value = prop.isValueNeedsLookup() <span class="comment">// since LOG4J2-1575</span></span><br><span class="line">                        ? config.getStrSubstitutor().replace(event, prop.getValue()) <span class="comment">//</span></span><br><span class="line">                        : prop.getValue();</span><br><span class="line">                    props.add(Property.createProperty(prop.getName(), value));</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//使用事件工厂创建一个日志事件，默认使用可重用事件工厂，原理与消息工厂一样</span></span><br><span class="line">        <span class="keyword">final</span> LogEvent logEvent = logEventFactory <span class="keyword">instanceof</span> LocationAwareLogEventFactory ?</span><br><span class="line">            ((LocationAwareLogEventFactory) logEventFactory).createEvent(loggerName, marker, fqcn, location, level,</span><br><span class="line">                data, props, t) : logEventFactory.createEvent(loggerName, marker, fqcn, level, data, props, t);</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            log(logEvent, LoggerConfigPredicate.ALL);</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            <span class="comment">// LOG4J2-1583 prevent scrambled logs when logging calls are nested (logging in toString())</span></span><br><span class="line">            ReusableLogEventFactory.release(logEvent);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">log</span><span class="params">(<span class="keyword">final</span> LogEvent event, <span class="keyword">final</span> LoggerConfigPredicate predicate)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (!isFiltered(event)) &#123;</span><br><span class="line">            processLogEvent(event, predicate);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">isFiltered</span><span class="params">(<span class="keyword">final</span> LogEvent event)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> filter != <span class="keyword">null</span> &amp;&amp; filter.filter(event) == Filter.Result.DENY;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">processLogEvent</span><span class="params">(<span class="keyword">final</span> LogEvent event, <span class="keyword">final</span> LoggerConfigPredicate predicate)</span> </span>&#123;</span><br><span class="line">        event.setIncludeLocation(isIncludeLocation());</span><br><span class="line">        <span class="keyword">if</span> (predicate.allow(<span class="keyword">this</span>)) &#123;</span><br><span class="line">            callAppenders(event);</span><br><span class="line">        &#125;</span><br><span class="line">        logParent(event, predicate);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"> <span class="meta">@PerformanceSensitive</span>(<span class="string">"allocation"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">callAppenders</span><span class="params">(<span class="keyword">final</span> LogEvent event)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">final</span> AppenderControl[] controls = appenders.get();</span><br><span class="line">        <span class="comment">//noinspection ForLoopReplaceableByForEach</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; controls.length; i++) &#123;</span><br><span class="line">            controls[i].callAppender(event);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">--------------------------AppenderControl------------------</span><br><span class="line"> <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">callAppender</span><span class="params">(<span class="keyword">final</span> LogEvent event)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (shouldSkip(event)) &#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        callAppenderPreventRecursion(event);</span><br><span class="line">    &#125;</span><br><span class="line"> <span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">shouldSkip</span><span class="params">(<span class="keyword">final</span> LogEvent event)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> isFilteredByAppenderControl(event) || isFilteredByLevel(event) || isRecursiveCall();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"> <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">callAppenderPreventRecursion</span><span class="params">(<span class="keyword">final</span> LogEvent event)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            recursive.set(<span class="keyword">this</span>);</span><br><span class="line">            callAppender0(event);</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            recursive.set(<span class="keyword">null</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">callAppender0</span><span class="params">(<span class="keyword">final</span> LogEvent event)</span> </span>&#123;</span><br><span class="line">        ensureAppenderStarted();</span><br><span class="line">        <span class="keyword">if</span> (!isFilteredByAppender(event)) &#123;</span><br><span class="line">            tryCallAppender(event);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">isFilteredByAppender</span><span class="params">(<span class="keyword">final</span> LogEvent event)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> appender <span class="keyword">instanceof</span> Filterable &amp;&amp; ((Filterable) appender).isFiltered(event);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">tryCallAppender</span><span class="params">(<span class="keyword">final</span> LogEvent event)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            appender.append(event);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (<span class="keyword">final</span> RuntimeException ex) &#123;</span><br><span class="line">            handleAppenderError(event, ex);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (<span class="keyword">final</span> Exception ex) &#123;</span><br><span class="line">            handleAppenderError(event, <span class="keyword">new</span> AppenderLoggingException(ex));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">-----具体的appender-----</span><br><span class="line">所以实现一个appender就必须实现  append方法</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">append</span><span class="params">(<span class="keyword">final</span> LogEvent event)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            tryAppend(event);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (<span class="keyword">final</span> AppenderLoggingException ex) &#123;</span><br><span class="line">            error(<span class="string">"Unable to write to stream "</span> + manager.getName() + <span class="string">" for appender "</span> + getName(), event, ex);</span><br><span class="line">            <span class="keyword">throw</span> ex;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>





<h1 id="配置文件"><a href="#配置文件" class="headerlink" title="配置文件"></a>配置文件</h1><h3 id="ConfigurationFactory"><a href="#ConfigurationFactory" class="headerlink" title="ConfigurationFactory"></a>ConfigurationFactory</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">继承ConfigurationBuilderFactory：提供创建ConfigurationBuilders的方法。</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">用于从配置文件解析的&#123;@link Configuration&#125;对象的工厂类。</span></span><br><span class="line"><span class="comment">ConfigurationFactory允许通过以下三种方式中的一种动态选择配置实现：</span></span><br><span class="line"><span class="comment">	1名为“log4j.configurationFactory”的系统属性可以设置为要使用的configurationFactory的名称。</span></span><br><span class="line"><span class="comment">    2&#123;@linkplain#setConfigurationFactory（ConfigurationFactory）&#125;可以与要使用的ConfigurationFactory实例一起调用。必须在调用Log4j之前调用它。</span></span><br><span class="line"><span class="comment">    3.ConfigurationFactory实现可以添加到类路径中，并配置为&#123;@link#CATEGORY ConfigurationFactory&#125;类别中的插件。 &#123;@link Order&#125;注释应该用于将工厂配置为第一个被检查的工厂。 参见&#123;@linkplain org.apache.logging.log4j.core.config.xml.XmlConfigurationFactory&#125;获取示例。</span></span><br><span class="line"><span class="comment"> </span></span><br><span class="line"><span class="comment">如果添加的ConfigurationFactory在调用getConfiguration时返回null，那么作为插件找到的任何其他ConfigurationFactory都将按各自的顺序调用。如果未返回任何配置，则始终最后调用DefaultConfiguration。 </span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"> </span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line">    </span><br><span class="line">     reconfigure(); <span class="comment">//获取loggerContext时候会调用</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">reconfigure</span><span class="params">(<span class="keyword">final</span> URI configURI)</span> </span>&#123;</span><br><span class="line">        Object externalContext = externalMap.get(EXTERNAL_CONTEXT_KEY);</span><br><span class="line">        final ClassLoader cl = ClassLoader.class.isInstance(externalContext) ? (ClassLoader) externalContext : null;</span><br><span class="line">        LOGGER.debug(<span class="string">"Reconfiguration started for context[name=&#123;&#125;] at URI &#123;&#125; (&#123;&#125;) with optional ClassLoader: &#123;&#125;"</span>,</span><br><span class="line">                contextName, configURI, <span class="keyword">this</span>, cl);</span><br><span class="line">        <span class="keyword">final</span> Configuration instance = ConfigurationFactory.getInstance().getConfiguration(<span class="keyword">this</span>, contextName, configURI, cl);</span><br><span class="line">        <span class="keyword">if</span> (instance == <span class="keyword">null</span>) &#123;</span><br><span class="line">            LOGGER.error(<span class="string">"Reconfiguration failed: No configuration found for '&#123;&#125;' at '&#123;&#125;' in '&#123;&#125;'"</span>, contextName, configURI, cl);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            setConfiguration(instance);</span><br><span class="line">            <span class="comment">/*</span></span><br><span class="line"><span class="comment">             * instance.start(); Configuration old = setConfiguration(instance); updateLoggers(); if (old != null) &#123;</span></span><br><span class="line"><span class="comment">             * old.stop(); &#125;</span></span><br><span class="line"><span class="comment">             */</span></span><br><span class="line">            <span class="keyword">final</span> String location = configuration == <span class="keyword">null</span> ? <span class="string">"?"</span> : String.valueOf(configuration.getConfigurationSource());</span><br><span class="line">            LOGGER.debug(<span class="string">"Reconfiguration complete for context[name=&#123;&#125;] at URI &#123;&#125; (&#123;&#125;) with optional ClassLoader: &#123;&#125;"</span>,</span><br><span class="line">                    contextName, location, <span class="keyword">this</span>, cl);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">ConfigurationFactory.getInstance()：</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> ConfigurationFactory <span class="title">getInstance</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="comment">// volatile works in Java 1.6+, so double-checked locking also works properly</span></span><br><span class="line">        <span class="comment">//noinspection DoubleCheckedLocking</span></span><br><span class="line">        <span class="keyword">if</span> (factories == <span class="keyword">null</span>) &#123;</span><br><span class="line">            LOCK.lock();</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="keyword">if</span> (factories == <span class="keyword">null</span>) &#123;</span><br><span class="line">                    <span class="keyword">final</span> List&lt;ConfigurationFactory&gt; list = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">                    PropertiesUtil props = PropertiesUtil.getProperties();</span><br><span class="line">                    <span class="comment">//首先获取  public static final String CONFIGURATION_FACTORY_PROPERTY = "log4j.configurationFactory";指定的</span></span><br><span class="line">                    <span class="keyword">final</span> String factoryClass = props.getStringProperty(CONFIGURATION_FACTORY_PROPERTY);</span><br><span class="line">                    <span class="keyword">if</span> (factoryClass != <span class="keyword">null</span>) &#123;</span><br><span class="line">                        <span class="comment">//处理化并加入list</span></span><br><span class="line">                        addFactory(list, factoryClass);</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">final</span> PluginManager manager = <span class="keyword">new</span> PluginManager(CATEGORY);</span><br><span class="line">                    manager.collectPlugins();</span><br><span class="line">                    <span class="keyword">final</span> Map&lt;String, PluginType&lt;?&gt;&gt; plugins = manager.getPlugins();</span><br><span class="line">                    <span class="keyword">final</span> List&lt;Class&lt;? extends ConfigurationFactory&gt;&gt; ordered = <span class="keyword">new</span> ArrayList&lt;&gt;(plugins.size());</span><br><span class="line">                    <span class="keyword">for</span> (<span class="keyword">final</span> PluginType&lt;?&gt; type : plugins.values()) &#123;</span><br><span class="line">                        <span class="keyword">try</span> &#123;</span><br><span class="line">                            ordered.add(type.getPluginClass().asSubclass(ConfigurationFactory<span class="class">.<span class="keyword">class</span>))</span>;</span><br><span class="line">                        &#125; <span class="keyword">catch</span> (<span class="keyword">final</span> Exception ex) &#123;</span><br><span class="line">                            LOGGER.warn(<span class="string">"Unable to add class &#123;&#125;"</span>, type.getPluginClass(), ex);</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                    Collections.sort(ordered, OrderComparator.getInstance());</span><br><span class="line">                    <span class="keyword">for</span> (<span class="keyword">final</span> Class&lt;? extends ConfigurationFactory&gt; clazz : ordered) &#123;</span><br><span class="line">                        addFactory(list, clazz);</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="comment">// see above comments about double-checked locking</span></span><br><span class="line">                    <span class="comment">//noinspection NonThreadSafeLazyInitialization</span></span><br><span class="line">                    factories = Collections.unmodifiableList(list);</span><br><span class="line">                    authorizationProvider = authorizationProvider(props);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                LOCK.unlock();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        LOGGER.debug(<span class="string">"Using configurationFactory &#123;&#125;"</span>, configFactory);</span><br><span class="line">        <span class="keyword">return</span> configFactory;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>插件机制</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br></pre></td><td class="code"><pre><span class="line"> PluginManager</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">collectPlugins</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        collectPlugins(<span class="keyword">null</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">collectPlugins</span><span class="params">(<span class="keyword">final</span> List&lt;String&gt; packages)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">final</span> String categoryLowerCase = category.toLowerCase();</span><br><span class="line">        <span class="keyword">final</span> Map&lt;String, PluginType&lt;?&gt;&gt; newPlugins = <span class="keyword">new</span> LinkedHashMap&lt;&gt;();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 首先，迭代Log4j2插件.dat在主ClassPath中找到的文件</span></span><br><span class="line">        Map&lt;String, List&lt;PluginType&lt;?&gt;&gt;&gt; builtInPlugins = PluginRegistry.getInstance().loadFromMainClassLoader();</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">        <span class="keyword">if</span> (builtInPlugins.isEmpty()) &#123;</span><br><span class="line">            <span class="comment">// 如果我们没有在上面找到任何插件，一定是有人弄乱了log4j-core.jar. 搜索标准包，希望能找到我们的核心插件。</span></span><br><span class="line">            builtInPlugins = PluginRegistry.getInstance().loadFromPackage(LOG4J_PACKAGES);</span><br><span class="line">        &#125;</span><br><span class="line">        mergeByName(newPlugins, builtInPlugins.get(categoryLowerCase));</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 接下来，迭代任何Log4j2插件.datOSGi捆绑包中的文件</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">final</span> Map&lt;String, List&lt;PluginType&lt;?&gt;&gt;&gt; pluginsByCategory : PluginRegistry.getInstance().getPluginsByCategoryByBundleId().values()) &#123;</span><br><span class="line">            mergeByName(newPlugins, pluginsByCategory.get(categoryLowerCase));</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 接下来迭代传递给静态addPackage方法的所有包。</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">final</span> String pkg : PACKAGES) &#123;</span><br><span class="line">            mergeByName(newPlugins, PluginRegistry.getInstance().loadFromPackage(pkg).get(categoryLowerCase));</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// Finally iterate any packages provided in the configuration (note these can be changed at runtime).</span></span><br><span class="line">        <span class="keyword">if</span> (packages != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">final</span> String pkg : packages) &#123;</span><br><span class="line">                mergeByName(newPlugins, PluginRegistry.getInstance().loadFromPackage(pkg).get(categoryLowerCase));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        LOGGER.debug(<span class="string">"PluginManager '&#123;&#125;' found &#123;&#125; plugins"</span>, category, newPlugins.size());</span><br><span class="line"></span><br><span class="line">        plugins = newPlugins;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"> <span class="keyword">private</span> Map&lt;String, List&lt;PluginType&lt;?&gt;&gt;&gt; decodeCacheFiles(<span class="keyword">final</span> ClassLoader loader) &#123;</span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">long</span> startTime = System.nanoTime();</span><br><span class="line">        <span class="keyword">final</span> PluginCache cache = <span class="keyword">new</span> PluginCache();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// public static final String PLUGIN_CACHE_FILE =</span></span><br><span class="line"> <span class="comment">// "META-INF/org/apache/logging/log4j/core/config/plugins/Log4j2Plugins.dat";就是获取这个资源</span></span><br><span class="line">            <span class="keyword">final</span> Enumeration&lt;URL&gt; resources = loader.getResources(PluginProcessor.PLUGIN_CACHE_FILE);</span><br><span class="line">            <span class="keyword">if</span> (resources == <span class="keyword">null</span>) &#123;</span><br><span class="line">                LOGGER.info(<span class="string">"Plugin preloads not available from class loader &#123;&#125;"</span>, loader);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                cache.loadCacheFiles(resources);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (<span class="keyword">final</span> IOException ioe) &#123;</span><br><span class="line">            LOGGER.warn(<span class="string">"Unable to preload plugins"</span>, ioe);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">final</span> Map&lt;String, List&lt;PluginType&lt;?&gt;&gt;&gt; newPluginsByCategory = <span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line">        <span class="keyword">int</span> pluginCount = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">final</span> Map.Entry&lt;String, Map&lt;String, PluginEntry&gt;&gt; outer : cache.getAllCategories().entrySet()) &#123;</span><br><span class="line">            <span class="keyword">final</span> String categoryLowerCase = outer.getKey();</span><br><span class="line">            <span class="keyword">final</span> List&lt;PluginType&lt;?&gt;&gt; types = <span class="keyword">new</span> ArrayList&lt;&gt;(outer.getValue().size());</span><br><span class="line">            newPluginsByCategory.put(categoryLowerCase, types);</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">final</span> Map.Entry&lt;String, PluginEntry&gt; inner : outer.getValue().entrySet()) &#123;</span><br><span class="line">                <span class="keyword">final</span> PluginEntry entry = inner.getValue();</span><br><span class="line">                <span class="keyword">final</span> String className = entry.getClassName();</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    <span class="keyword">final</span> Class&lt;?&gt; clazz = loader.loadClass(className);</span><br><span class="line">                    <span class="keyword">final</span> PluginType&lt;?&gt; type = <span class="keyword">new</span> PluginType&lt;&gt;(entry, clazz, entry.getName());</span><br><span class="line">                    types.add(type);</span><br><span class="line">                    ++pluginCount;</span><br><span class="line">                &#125; <span class="keyword">catch</span> (<span class="keyword">final</span> ClassNotFoundException e) &#123;</span><br><span class="line">                    LOGGER.info(<span class="string">"Plugin [&#123;&#125;] could not be loaded due to missing classes."</span>, className, e);</span><br><span class="line">                &#125; <span class="keyword">catch</span> (<span class="keyword">final</span> LinkageError e) &#123;</span><br><span class="line">                    LOGGER.info(<span class="string">"Plugin [&#123;&#125;] could not be loaded due to linkage error."</span>, className, e);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">int</span> numPlugins = pluginCount;</span><br><span class="line">        LOGGER.debug(() -&gt; &#123;</span><br><span class="line">            <span class="keyword">final</span> <span class="keyword">long</span> endTime = System.nanoTime();</span><br><span class="line">            StringBuilder sb = <span class="keyword">new</span> StringBuilder(<span class="string">"Took "</span>);</span><br><span class="line">            <span class="keyword">final</span> DecimalFormat numFormat = <span class="keyword">new</span> DecimalFormat(<span class="string">"#0.000000"</span>);</span><br><span class="line">            sb.append(numFormat.format((endTime - startTime) * <span class="number">1e-9</span>));</span><br><span class="line">            sb.append(<span class="string">" seconds to load "</span>).append(numPlugins);</span><br><span class="line">            sb.append(<span class="string">" plugins from "</span>).append(loader);</span><br><span class="line">            <span class="keyword">return</span> sb.toString();</span><br><span class="line">        &#125;);</span><br><span class="line">        <span class="keyword">return</span> newPluginsByCategory;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> Configuration <span class="title">getConfiguration</span><span class="params">(<span class="keyword">final</span> LoggerContext loggerContext, <span class="keyword">final</span> String name, <span class="keyword">final</span> URI configLocation, <span class="keyword">final</span> ClassLoader loader)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (!isActive()) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (loader == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> getConfiguration(loggerContext, name, configLocation);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (isClassLoaderUri(configLocation)) &#123;</span><br><span class="line">            <span class="keyword">final</span> String path = extractClassLoaderUriPath(configLocation);</span><br><span class="line">            <span class="keyword">final</span> ConfigurationSource source = ConfigurationSource.fromResource(path, loader);</span><br><span class="line">            <span class="keyword">if</span> (source != <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">final</span> Configuration configuration = getConfiguration(loggerContext, source);</span><br><span class="line">                <span class="keyword">if</span> (configuration != <span class="keyword">null</span>) &#123;</span><br><span class="line">                    <span class="keyword">return</span> configuration;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> getConfiguration(loggerContext, name, configLocation);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"> <span class="function"><span class="keyword">public</span> Configuration <span class="title">getConfiguration</span><span class="params">(<span class="keyword">final</span> LoggerContext loggerContext, <span class="keyword">final</span> String name, <span class="keyword">final</span> URI configLocation)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (configLocation == <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">final</span> String configLocationStr = <span class="keyword">this</span>.substitutor.replace(PropertiesUtil.getProperties()</span><br><span class="line">                        .getStringProperty(CONFIGURATION_FILE_PROPERTY));</span><br><span class="line">                <span class="keyword">if</span> (configLocationStr != <span class="keyword">null</span>) &#123;</span><br><span class="line">                    String[] sources = parseConfigLocations(configLocationStr);</span><br><span class="line">                    <span class="keyword">if</span> (sources.length &gt; <span class="number">1</span>) &#123;</span><br><span class="line">                        <span class="keyword">final</span> List&lt;AbstractConfiguration&gt; configs = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">                        <span class="keyword">for</span> (<span class="keyword">final</span> String sourceLocation : sources) &#123;</span><br><span class="line">                            <span class="keyword">final</span> Configuration config = getConfiguration(loggerContext, sourceLocation.trim());</span><br><span class="line">                            <span class="keyword">if</span> (config != <span class="keyword">null</span> &amp;&amp; config <span class="keyword">instanceof</span> AbstractConfiguration) &#123;</span><br><span class="line">                                configs.add((AbstractConfiguration) config);</span><br><span class="line">                            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                                LOGGER.error(<span class="string">"Failed to created configuration at &#123;&#125;"</span>, sourceLocation);</span><br><span class="line">                                <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;</span><br><span class="line">                        <span class="keyword">return</span> <span class="keyword">new</span> CompositeConfiguration(configs);</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">return</span> getConfiguration(loggerContext, configLocationStr);</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="keyword">final</span> String log4j1ConfigStr = <span class="keyword">this</span>.substitutor.replace(PropertiesUtil.getProperties()</span><br><span class="line">                            .getStringProperty(LOG4J1_CONFIGURATION_FILE_PROPERTY));</span><br><span class="line">                    <span class="keyword">if</span> (log4j1ConfigStr != <span class="keyword">null</span>) &#123;</span><br><span class="line">                        System.setProperty(LOG4J1_EXPERIMENTAL, <span class="string">"true"</span>);</span><br><span class="line">                        <span class="keyword">return</span> getConfiguration(LOG4J1_VERSION, loggerContext, log4j1ConfigStr);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">for</span> (<span class="keyword">final</span> ConfigurationFactory factory : getFactories()) &#123;</span><br><span class="line">                    <span class="keyword">final</span> String[] types = factory.getSupportedTypes();</span><br><span class="line">                    <span class="keyword">if</span> (types != <span class="keyword">null</span>) &#123;</span><br><span class="line">                        <span class="keyword">for</span> (<span class="keyword">final</span> String type : types) &#123;</span><br><span class="line">                            <span class="comment">//private static final String ALL_TYPES = "*";</span></span><br><span class="line">                            <span class="comment">//XmlConfigurationFactory的 public static final String[] SUFFIXES = new String[] &#123;".xml", "*"&#125;;</span></span><br><span class="line">  </span><br><span class="line">                            <span class="keyword">if</span> (type.equals(ALL_TYPES)) &#123;</span><br><span class="line">                                <span class="keyword">final</span> Configuration config = factory.getConfiguration(loggerContext, name, configLocation);</span><br><span class="line">                                <span class="keyword">if</span> (config != <span class="keyword">null</span>) &#123;</span><br><span class="line">                                    <span class="keyword">return</span> config;</span><br><span class="line">                                &#125;</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                String[] sources = parseConfigLocations(configLocation);</span><br><span class="line">                <span class="keyword">if</span> (sources.length &gt; <span class="number">1</span>) &#123;</span><br><span class="line">                    <span class="keyword">final</span> List&lt;AbstractConfiguration&gt; configs = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">                    <span class="keyword">for</span> (<span class="keyword">final</span> String sourceLocation : sources) &#123;</span><br><span class="line">                        <span class="keyword">final</span> Configuration config = getConfiguration(loggerContext, sourceLocation.trim());</span><br><span class="line">                        <span class="keyword">if</span> (config <span class="keyword">instanceof</span> AbstractConfiguration) &#123;</span><br><span class="line">                            configs.add((AbstractConfiguration) config);</span><br><span class="line">                        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                            LOGGER.error(<span class="string">"Failed to created configuration at &#123;&#125;"</span>, sourceLocation);</span><br><span class="line">                            <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">return</span> <span class="keyword">new</span> CompositeConfiguration(configs);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">// configLocation != null</span></span><br><span class="line">                <span class="keyword">final</span> String configLocationStr = configLocation.toString();</span><br><span class="line">                <span class="keyword">for</span> (<span class="keyword">final</span> ConfigurationFactory factory : getFactories()) &#123;</span><br><span class="line">                    <span class="keyword">final</span> String[] types = factory.getSupportedTypes();</span><br><span class="line">                    <span class="keyword">if</span> (types != <span class="keyword">null</span>) &#123;</span><br><span class="line">                        <span class="keyword">for</span> (<span class="keyword">final</span> String type : types) &#123;</span><br><span class="line">                            <span class="keyword">if</span> (type.equals(ALL_TYPES) || configLocationStr.endsWith(type)) &#123;</span><br><span class="line">                                <span class="keyword">final</span> Configuration config = factory.getConfiguration(loggerContext, name, configLocation);</span><br><span class="line">                                <span class="keyword">if</span> (config != <span class="keyword">null</span>) &#123;</span><br><span class="line">                                    <span class="keyword">return</span> config;</span><br><span class="line">                                &#125;</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            Configuration config = getConfiguration(loggerContext, <span class="keyword">true</span>, name);</span><br><span class="line">            <span class="keyword">if</span> (config == <span class="keyword">null</span>) &#123;</span><br><span class="line">                config = getConfiguration(loggerContext, <span class="keyword">true</span>, <span class="keyword">null</span>);</span><br><span class="line">                <span class="keyword">if</span> (config == <span class="keyword">null</span>) &#123;</span><br><span class="line">                    config = getConfiguration(loggerContext, <span class="keyword">false</span>, name);</span><br><span class="line">                    <span class="keyword">if</span> (config == <span class="keyword">null</span>) &#123;</span><br><span class="line">                        config = getConfiguration(loggerContext, <span class="keyword">false</span>, <span class="keyword">null</span>);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (config != <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">return</span> config;</span><br><span class="line">            &#125;</span><br><span class="line">            LOGGER.warn(<span class="string">"No Log4j 2 configuration file found. "</span> +</span><br><span class="line">                    <span class="string">"Using default configuration (logging only errors to the console), "</span> +</span><br><span class="line">                    <span class="string">"or user programmatically provided configurations. "</span> +</span><br><span class="line">                    <span class="string">"Set system property 'log4j2.debug' "</span> +</span><br><span class="line">                    <span class="string">"to show Log4j 2 internal initialization logging. "</span> +</span><br><span class="line">                    <span class="string">"See https://logging.apache.org/log4j/2.x/manual/configuration.html for instructions on how to configure Log4j 2"</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> DefaultConfiguration();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"> <span class="function"><span class="keyword">public</span> Configuration <span class="title">getConfiguration</span><span class="params">(<span class="keyword">final</span> LoggerContext loggerContext, <span class="keyword">final</span> String name, <span class="keyword">final</span> URI configLocation)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (!isActive()) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (configLocation != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">final</span> ConfigurationSource source = ConfigurationSource.fromUri(configLocation);</span><br><span class="line">            <span class="keyword">if</span> (source != <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">return</span> getConfiguration(loggerContext, source);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">先按获取log4j2-test，带name</span><br><span class="line">    log4j2-test 不带name</span><br><span class="line">    log4j2 带name</span><br><span class="line">    log4j2 不带name</span><br><span class="line"><span class="function"><span class="keyword">private</span> Configuration <span class="title">getConfiguration</span><span class="params">(<span class="keyword">final</span> LoggerContext loggerContext, <span class="keyword">final</span> <span class="keyword">boolean</span> isTest, <span class="keyword">final</span> String name)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">final</span> <span class="keyword">boolean</span> named = Strings.isNotEmpty(name);</span><br><span class="line">            <span class="keyword">final</span> ClassLoader loader = LoaderUtil.getThreadContextClassLoader();</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">final</span> ConfigurationFactory factory : getFactories()) &#123;</span><br><span class="line">                String configName;</span><br><span class="line">                <span class="comment">//获取本工厂的前缀 首先后去test前缀 ，然后获取</span></span><br><span class="line">                <span class="comment">// protected static final String DEFAULT_PREFIX = "log4j2";默认的</span></span><br><span class="line">                <span class="keyword">final</span> String prefix = isTest ? factory.getTestPrefix() : factory.getDefaultPrefix();</span><br><span class="line">                <span class="keyword">final</span> String [] types = factory.getSupportedTypes();</span><br><span class="line">                <span class="keyword">if</span> (types == <span class="keyword">null</span>) &#123;</span><br><span class="line">                    <span class="keyword">continue</span>;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">for</span> (<span class="keyword">final</span> String suffix : types) &#123;</span><br><span class="line">                    <span class="keyword">if</span> (suffix.equals(ALL_TYPES)) &#123;</span><br><span class="line">                        <span class="keyword">continue</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                    configName = named ? prefix + name + suffix : prefix + suffix;</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">final</span> ConfigurationSource source = ConfigurationSource.fromResource(configName, loader);</span><br><span class="line">                    <span class="keyword">if</span> (source != <span class="keyword">null</span>) &#123;</span><br><span class="line">                        <span class="keyword">if</span> (!factory.isActive()) &#123;</span><br><span class="line">                            LOGGER.warn(<span class="string">"Found configuration file &#123;&#125; for inactive ConfigurationFactory &#123;&#125;"</span>, configName, factory.getClass().getName());</span><br><span class="line">                        &#125;</span><br><span class="line">                        <span class="keyword">return</span> factory.getConfiguration(loggerContext, source);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">能够找到就返回指定的</span><br><span class="line"> <span class="keyword">return</span> <span class="keyword">new</span> XmlConfiguration(loggerContext, source);</span><br><span class="line">  不能够就返回默认的</span><br><span class="line">       <span class="keyword">return</span> <span class="keyword">new</span> DefaultConfiguration();</span><br></pre></td></tr></table></figure>



<h3 id="Configuration-start"><a href="#Configuration-start" class="headerlink" title="Configuration.start()"></a>Configuration.start()</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">start</span><span class="params">()</span> </span>&#123;</span><br><span class="line">       <span class="comment">// Preserve the prior behavior of initializing during start if not initialized.</span></span><br><span class="line">       <span class="keyword">if</span> (getState().equals(State.INITIALIZING)) &#123;</span><br><span class="line">           initialize();</span><br><span class="line">       &#125;</span><br><span class="line">       LOGGER.debug(<span class="string">"Starting configuration &#123;&#125;"</span>, <span class="keyword">this</span>);</span><br><span class="line">       <span class="keyword">this</span>.setStarting();</span><br><span class="line">       <span class="keyword">if</span> (watchManager.getIntervalSeconds() &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">           watchManager.start();</span><br><span class="line">       &#125;</span><br><span class="line">       <span class="keyword">if</span> (hasAsyncLoggers()) &#123;</span><br><span class="line">           asyncLoggerConfigDisruptor.start();</span><br><span class="line">       &#125;</span><br><span class="line">       <span class="keyword">final</span> Set&lt;LoggerConfig&gt; alreadyStarted = <span class="keyword">new</span> HashSet&lt;&gt;();</span><br><span class="line">       <span class="keyword">for</span> (<span class="keyword">final</span> LoggerConfig logger : loggerConfigs.values()) &#123;</span><br><span class="line">           logger.start();</span><br><span class="line">           alreadyStarted.add(logger);</span><br><span class="line">       &#125;</span><br><span class="line">       <span class="keyword">for</span> (<span class="keyword">final</span> Appender appender : appenders.values()) &#123;</span><br><span class="line">           appender.start();</span><br><span class="line">       &#125;</span><br><span class="line">       <span class="keyword">if</span> (!alreadyStarted.contains(root)) &#123; <span class="comment">// LOG4J2-392</span></span><br><span class="line">           root.start(); <span class="comment">// LOG4J2-336</span></span><br><span class="line">       &#125;</span><br><span class="line">       <span class="keyword">super</span>.start();</span><br><span class="line">       LOGGER.debug(<span class="string">"Started configuration &#123;&#125; OK."</span>, <span class="keyword">this</span>);</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">initialize</span><span class="params">()</span> </span>&#123;</span><br><span class="line">       LOGGER.debug(Version.getProductString() + <span class="string">" initializing configuration &#123;&#125;"</span>, <span class="keyword">this</span>);</span><br><span class="line">       subst.setConfiguration(<span class="keyword">this</span>);</span><br><span class="line">       <span class="keyword">try</span> &#123;</span><br><span class="line">           scriptManager = <span class="keyword">new</span> ScriptManager(<span class="keyword">this</span>, watchManager);</span><br><span class="line">       &#125; <span class="keyword">catch</span> (<span class="keyword">final</span> LinkageError | Exception e) &#123;</span><br><span class="line">           <span class="comment">// LOG4J2-1920 ScriptEngineManager is not available in Android</span></span><br><span class="line">           LOGGER.info(<span class="string">"Cannot initialize scripting support because this JRE does not support it."</span>, e);</span><br><span class="line">       &#125;</span><br><span class="line">       pluginManager.collectPlugins(pluginPackages);</span><br><span class="line">       <span class="keyword">final</span> PluginManager levelPlugins = <span class="keyword">new</span> PluginManager(Level.CATEGORY);</span><br><span class="line">       levelPlugins.collectPlugins(pluginPackages);</span><br><span class="line">       <span class="keyword">final</span> Map&lt;String, PluginType&lt;?&gt;&gt; plugins = levelPlugins.getPlugins();</span><br><span class="line">       <span class="keyword">if</span> (plugins != <span class="keyword">null</span>) &#123;</span><br><span class="line">           <span class="keyword">for</span> (<span class="keyword">final</span> PluginType&lt;?&gt; type : plugins.values()) &#123;</span><br><span class="line">               <span class="keyword">try</span> &#123;</span><br><span class="line">                   <span class="comment">// Cause the class to be initialized if it isn't already.</span></span><br><span class="line">                   Loader.initializeClass(type.getPluginClass().getName(), type.getPluginClass().getClassLoader());</span><br><span class="line">               &#125; <span class="keyword">catch</span> (<span class="keyword">final</span> Exception e) &#123;</span><br><span class="line">                   LOGGER.error(<span class="string">"Unable to initialize &#123;&#125; due to &#123;&#125;"</span>, type.getPluginClass().getName(), e.getClass()</span><br><span class="line">                           .getSimpleName(), e);</span><br><span class="line">               &#125;</span><br><span class="line">           &#125;</span><br><span class="line">       &#125;</span><br><span class="line">       setup();</span><br><span class="line">       setupAdvertisement();</span><br><span class="line">       <span class="comment">//做配置</span></span><br><span class="line">       doConfigure();</span><br><span class="line">       setState(State.INITIALIZED);</span><br><span class="line">       LOGGER.debug(<span class="string">"Configuration &#123;&#125; initialized"</span>, <span class="keyword">this</span>);</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>





<h3 id="xml配置文件解析"><a href="#xml配置文件解析" class="headerlink" title="xml配置文件解析"></a>xml配置文件解析</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"></span><br><span class="line">xml的<span class="keyword">new</span>就是xml配置的初始化，此时 所有的节点都会被解析出来</span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">        private final List&lt;Status&gt; status = new ArrayList&lt;&gt;();</span></span><br><span class="line"><span class="comment">    private Element rootElement;</span></span><br><span class="line"><span class="comment">    private boolean strict;</span></span><br><span class="line"><span class="comment">    private String schemaResource;</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line"> <span class="function"><span class="keyword">public</span> <span class="title">XmlConfiguration</span><span class="params">(<span class="keyword">final</span> LoggerContext loggerContext, <span class="keyword">final</span> ConfigurationSource configSource)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>(loggerContext, configSource);</span><br><span class="line">        <span class="keyword">final</span> File configFile = configSource.getFile();</span><br><span class="line">        <span class="keyword">byte</span>[] buffer = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">final</span> InputStream configStream = configSource.getInputStream();</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                buffer = toByteArray(configStream);</span><br><span class="line">            &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                Closer.closeSilently(configStream);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">final</span> InputSource source = <span class="keyword">new</span> InputSource(<span class="keyword">new</span> ByteArrayInputStream(buffer));</span><br><span class="line">            source.setSystemId(configSource.getLocation());</span><br><span class="line">            <span class="keyword">final</span> DocumentBuilder documentBuilder = newDocumentBuilder(<span class="keyword">true</span>);</span><br><span class="line">            Document document;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="comment">//这行做事情</span></span><br><span class="line">                document = documentBuilder.parse(source);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (<span class="keyword">final</span> Exception e) &#123;</span><br><span class="line">                <span class="comment">// LOG4J2-1127</span></span><br><span class="line">                <span class="keyword">final</span> Throwable throwable = Throwables.getRootCause(e);</span><br><span class="line">                <span class="keyword">if</span> (throwable <span class="keyword">instanceof</span> UnsupportedOperationException) &#123;</span><br><span class="line">                    LOGGER.warn(</span><br><span class="line">                            <span class="string">"The DocumentBuilder &#123;&#125; does not support an operation: &#123;&#125;."</span></span><br><span class="line">                            + <span class="string">"Trying again without XInclude..."</span>,</span><br><span class="line">                            documentBuilder, e);</span><br><span class="line">                    document = newDocumentBuilder(<span class="keyword">false</span>).parse(source);</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="keyword">throw</span> e;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            rootElement = document.getDocumentElement();</span><br><span class="line">            <span class="keyword">final</span> Map&lt;String, String&gt; attrs = processAttributes(rootNode, rootElement);</span><br><span class="line">            <span class="keyword">final</span> StatusConfiguration statusConfig = <span class="keyword">new</span> StatusConfiguration().withVerboseClasses(VERBOSE_CLASSES)</span><br><span class="line">                    .withStatus(getDefaultStatus());</span><br><span class="line">            <span class="keyword">int</span> monitorIntervalSeconds = <span class="number">0</span>;</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">final</span> Map.Entry&lt;String, String&gt; entry : attrs.entrySet()) &#123;</span><br><span class="line">                <span class="keyword">final</span> String key = entry.getKey();</span><br><span class="line">                <span class="keyword">final</span> String value = getStrSubstitutor().replace(entry.getValue());</span><br><span class="line">                <span class="keyword">if</span> (<span class="string">"status"</span>.equalsIgnoreCase(key)) &#123;</span><br><span class="line">                    statusConfig.withStatus(value);</span><br><span class="line">                &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="string">"dest"</span>.equalsIgnoreCase(key)) &#123;</span><br><span class="line">                    statusConfig.withDestination(value);</span><br><span class="line">                &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="string">"shutdownHook"</span>.equalsIgnoreCase(key)) &#123;</span><br><span class="line">                    isShutdownHookEnabled = !<span class="string">"disable"</span>.equalsIgnoreCase(value);</span><br><span class="line">                &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="string">"shutdownTimeout"</span>.equalsIgnoreCase(key)) &#123;</span><br><span class="line">                    shutdownTimeoutMillis = Long.parseLong(value);</span><br><span class="line">                &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="string">"verbose"</span>.equalsIgnoreCase(key)) &#123;</span><br><span class="line">                    statusConfig.withVerbosity(value);</span><br><span class="line">                &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="string">"packages"</span>.equalsIgnoreCase(key)) &#123;</span><br><span class="line">                    pluginPackages.addAll(Arrays.asList(value.split(Patterns.COMMA_SEPARATOR)));</span><br><span class="line">                &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="string">"name"</span>.equalsIgnoreCase(key)) &#123;</span><br><span class="line">                    setName(value);</span><br><span class="line">                &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="string">"strict"</span>.equalsIgnoreCase(key)) &#123;</span><br><span class="line">                    strict = Boolean.parseBoolean(value);</span><br><span class="line">                &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="string">"schema"</span>.equalsIgnoreCase(key)) &#123;</span><br><span class="line">                    schemaResource = value;</span><br><span class="line">                &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="string">"monitorInterval"</span>.equalsIgnoreCase(key)) &#123;</span><br><span class="line">                    monitorIntervalSeconds = Integer.parseInt(value);</span><br><span class="line">                &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="string">"advertiser"</span>.equalsIgnoreCase(key)) &#123;</span><br><span class="line">                    createAdvertiser(value, configSource, buffer, <span class="string">"text/xml"</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            initializeWatchers(<span class="keyword">this</span>, configSource, monitorIntervalSeconds);</span><br><span class="line">            statusConfig.initialize();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (<span class="keyword">final</span> SAXException | IOException | ParserConfigurationException e) &#123;</span><br><span class="line">            LOGGER.error(<span class="string">"Error parsing "</span> + configSource.getLocation(), e);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (strict &amp;&amp; schemaResource != <span class="keyword">null</span> &amp;&amp; buffer != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">try</span> (InputStream is = Loader.getResourceAsStream(schemaResource, XmlConfiguration<span class="class">.<span class="keyword">class</span>.<span class="title">getClassLoader</span>())) </span>&#123;</span><br><span class="line">                <span class="keyword">if</span> (is != <span class="keyword">null</span>) &#123;</span><br><span class="line">                    <span class="keyword">final</span> javax.xml.transform.Source src = <span class="keyword">new</span> StreamSource(is, LOG4J_XSD);</span><br><span class="line">                    <span class="keyword">final</span> SchemaFactory factory = SchemaFactory.newInstance(XMLConstants.W3C_XML_SCHEMA_NS_URI);</span><br><span class="line">                    Schema schema = <span class="keyword">null</span>;</span><br><span class="line">                    <span class="keyword">try</span> &#123;</span><br><span class="line">                        schema = factory.newSchema(src);</span><br><span class="line">                    &#125; <span class="keyword">catch</span> (<span class="keyword">final</span> SAXException ex) &#123;</span><br><span class="line">                        LOGGER.error(<span class="string">"Error parsing Log4j schema"</span>, ex);</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">if</span> (schema != <span class="keyword">null</span>) &#123;</span><br><span class="line">                        <span class="keyword">final</span> Validator validator = schema.newValidator();</span><br><span class="line">                        <span class="keyword">try</span> &#123;</span><br><span class="line">                            validator.validate(<span class="keyword">new</span> StreamSource(<span class="keyword">new</span> ByteArrayInputStream(buffer)));</span><br><span class="line">                        &#125; <span class="keyword">catch</span> (<span class="keyword">final</span> IOException ioe) &#123;</span><br><span class="line">                            LOGGER.error(<span class="string">"Error reading configuration for validation"</span>, ioe);</span><br><span class="line">                        &#125; <span class="keyword">catch</span> (<span class="keyword">final</span> SAXException ex) &#123;</span><br><span class="line">                            LOGGER.error(<span class="string">"Error validating configuration"</span>, ex);</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">catch</span> (<span class="keyword">final</span> Exception ex) &#123;</span><br><span class="line">                LOGGER.error(<span class="string">"Unable to access schema &#123;&#125;"</span>, <span class="keyword">this</span>.schemaResource, ex);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (getName() == <span class="keyword">null</span>) &#123;</span><br><span class="line">            setName(configSource.getLocation());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">然后会进行初始化</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">initialize</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        LOGGER.debug(Version.getProductString() + <span class="string">" initializing configuration &#123;&#125;"</span>, <span class="keyword">this</span>);</span><br><span class="line">        subst.setConfiguration(<span class="keyword">this</span>);</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            scriptManager = <span class="keyword">new</span> ScriptManager(<span class="keyword">this</span>, watchManager);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (<span class="keyword">final</span> LinkageError | Exception e) &#123;</span><br><span class="line">            <span class="comment">// LOG4J2-1920 ScriptEngineManager is not available in Android</span></span><br><span class="line">            LOGGER.info(<span class="string">"Cannot initialize scripting support because this JRE does not support it."</span>, e);</span><br><span class="line">        &#125;</span><br><span class="line">        pluginManager.collectPlugins(pluginPackages);</span><br><span class="line">        <span class="keyword">final</span> PluginManager levelPlugins = <span class="keyword">new</span> PluginManager(Level.CATEGORY);</span><br><span class="line">        levelPlugins.collectPlugins(pluginPackages);</span><br><span class="line">        <span class="keyword">final</span> Map&lt;String, PluginType&lt;?&gt;&gt; plugins = levelPlugins.getPlugins();</span><br><span class="line">        <span class="keyword">if</span> (plugins != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">final</span> PluginType&lt;?&gt; type : plugins.values()) &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    <span class="comment">// Cause the class to be initialized if it isn't already.</span></span><br><span class="line">                    Loader.initializeClass(type.getPluginClass().getName(), type.getPluginClass().getClassLoader());</span><br><span class="line">                &#125; <span class="keyword">catch</span> (<span class="keyword">final</span> Exception e) &#123;</span><br><span class="line">                    LOGGER.error(<span class="string">"Unable to initialize &#123;&#125; due to &#123;&#125;"</span>, type.getPluginClass().getName(), e.getClass()</span><br><span class="line">                            .getSimpleName(), e);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">    </span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    </span><br><span class="line">        setup();</span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">    advertiser = clazz.newInstance();</span></span><br><span class="line"><span class="comment">                    advertisement = advertiser.advertise(advertiserNode.getAttributes());</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">        setupAdvertisement();</span><br><span class="line">        doConfigure();</span><br><span class="line">        setState(State.INITIALIZED);</span><br><span class="line">        LOGGER.debug(<span class="string">"Configuration &#123;&#125; initialized"</span>, <span class="keyword">this</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">      <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setup</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (rootElement == <span class="keyword">null</span>) &#123;</span><br><span class="line">            LOGGER.error(<span class="string">"No logging configuration"</span>);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">          <span class="comment">//层次结构化 节点</span></span><br><span class="line">        constructHierarchy(rootNode, rootElement);</span><br><span class="line">        <span class="keyword">if</span> (status.size() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">final</span> Status s : status) &#123;</span><br><span class="line">                LOGGER.error(<span class="string">"Error processing element &#123;&#125; (&#123;&#125;): &#123;&#125;"</span>, s.name, s.element, s.errorType);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        rootElement = <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">     <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">start</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="comment">// Preserve the prior behavior of initializing during start if not initialized.</span></span><br><span class="line">        <span class="keyword">if</span> (getState().equals(State.INITIALIZING)) &#123;</span><br><span class="line">            initialize();</span><br><span class="line">        &#125;</span><br><span class="line">        LOGGER.debug(<span class="string">"Starting configuration &#123;&#125;"</span>, <span class="keyword">this</span>);</span><br><span class="line">        <span class="keyword">this</span>.setStarting();</span><br><span class="line">        <span class="keyword">if</span> (watchManager.getIntervalSeconds() &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">            watchManager.start();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (hasAsyncLoggers()) &#123;</span><br><span class="line">            asyncLoggerConfigDisruptor.start();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">final</span> Set&lt;LoggerConfig&gt; alreadyStarted = <span class="keyword">new</span> HashSet&lt;&gt;();</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">final</span> LoggerConfig logger : loggerConfigs.values()) &#123;</span><br><span class="line">            logger.start();</span><br><span class="line">            alreadyStarted.add(logger);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">final</span> Appender appender : appenders.values()) &#123;</span><br><span class="line">            appender.start();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (!alreadyStarted.contains(root)) &#123; <span class="comment">// LOG4J2-392</span></span><br><span class="line">            root.start(); <span class="comment">// LOG4J2-336</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">super</span>.start();</span><br><span class="line">        LOGGER.debug(<span class="string">"Started configuration &#123;&#125; OK."</span>, <span class="keyword">this</span>);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>



<h3 id="如何解析dom"><a href="#如何解析dom" class="headerlink" title="如何解析dom"></a>如何解析dom</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">   <span class="function"><span class="keyword">static</span> DocumentBuilder <span class="title">newDocumentBuilder</span><span class="params">(<span class="keyword">final</span> <span class="keyword">boolean</span> xIncludeAware)</span> <span class="keyword">throws</span> ParserConfigurationException </span>&#123;</span><br><span class="line">        <span class="keyword">final</span> DocumentBuilderFactory factory = DocumentBuilderFactory.newInstance();</span><br><span class="line">        factory.setNamespaceAware(<span class="keyword">true</span>);</span><br><span class="line"></span><br><span class="line">        disableDtdProcessing(factory);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (xIncludeAware) &#123;</span><br><span class="line">            enableXInclude(factory);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> factory.newDocumentBuilder();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"> DocumentBuilderImpl(DocumentBuilderFactoryImpl dbf, Map&lt;String, Object&gt; dbfAttrs,</span><br><span class="line">            Map&lt;String, Boolean&gt; features, <span class="keyword">boolean</span> secureProcessing)</span><br><span class="line">        <span class="keyword">throws</span> SAXNotRecognizedException, SAXNotSupportedException</span><br><span class="line">    &#123;</span><br><span class="line">        domParser = <span class="keyword">new</span> DOMParser();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// If validating, provide a default ErrorHandler that prints</span></span><br><span class="line">        <span class="comment">// validation errors with a warning telling the user to set an</span></span><br><span class="line">        <span class="comment">// ErrorHandler</span></span><br><span class="line">        <span class="keyword">if</span> (dbf.isValidating()) &#123;</span><br><span class="line">            fInitErrorHandler = <span class="keyword">new</span> DefaultValidationErrorHandler(domParser.getXMLParserConfiguration().getLocale());</span><br><span class="line">            setErrorHandler(fInitErrorHandler);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> &#123;</span><br><span class="line">            fInitErrorHandler = domParser.getErrorHandler();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        domParser.setFeature(VALIDATION_FEATURE, dbf.isValidating());</span><br><span class="line"></span><br><span class="line">        <span class="comment">// "namespaceAware" == SAX Namespaces feature</span></span><br><span class="line">        domParser.setFeature(NAMESPACES_FEATURE, dbf.isNamespaceAware());</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Set various parameters obtained from DocumentBuilderFactory</span></span><br><span class="line">        domParser.setFeature(INCLUDE_IGNORABLE_WHITESPACE,</span><br><span class="line">                !dbf.isIgnoringElementContentWhitespace());</span><br><span class="line">        domParser.setFeature(CREATE_ENTITY_REF_NODES_FEATURE,</span><br><span class="line">                !dbf.isExpandEntityReferences());</span><br><span class="line">        domParser.setFeature(INCLUDE_COMMENTS_FEATURE,</span><br><span class="line">                !dbf.isIgnoringComments());</span><br><span class="line">        domParser.setFeature(CREATE_CDATA_NODES_FEATURE,</span><br><span class="line">                !dbf.isCoalescing());</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Avoid setting the XInclude processing feature if the value is false.</span></span><br><span class="line">        <span class="comment">// This will keep the configuration from throwing an exception if it</span></span><br><span class="line">        <span class="comment">// does not support XInclude.</span></span><br><span class="line">        <span class="keyword">if</span> (dbf.isXIncludeAware()) &#123;</span><br><span class="line">            domParser.setFeature(XINCLUDE_FEATURE, <span class="keyword">true</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        fSecurityPropertyMgr = <span class="keyword">new</span> XMLSecurityPropertyManager();</span><br><span class="line">        domParser.setProperty(XML_SECURITY_PROPERTY_MANAGER, fSecurityPropertyMgr);</span><br><span class="line"></span><br><span class="line">        fSecurityManager = <span class="keyword">new</span> XMLSecurityManager(secureProcessing);</span><br><span class="line">        domParser.setProperty(SECURITY_MANAGER, fSecurityManager);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (secureProcessing) &#123;</span><br><span class="line">            <span class="comment">/**</span></span><br><span class="line"><span class="comment">             * If secure processing is explicitly set on the factory, the</span></span><br><span class="line"><span class="comment">             * access properties will be set unless the corresponding</span></span><br><span class="line"><span class="comment">             * System Properties or jaxp.properties are set</span></span><br><span class="line"><span class="comment">             */</span></span><br><span class="line">            <span class="keyword">if</span> (features != <span class="keyword">null</span>) &#123;</span><br><span class="line">                Boolean temp = features.get(XMLConstants.FEATURE_SECURE_PROCESSING);</span><br><span class="line">                <span class="keyword">if</span> (temp != <span class="keyword">null</span>) &#123;</span><br><span class="line">                    <span class="keyword">if</span> (temp &amp;&amp; Constants.IS_JDK8_OR_ABOVE) &#123;</span><br><span class="line">                        fSecurityPropertyMgr.setValue(Property.ACCESS_EXTERNAL_DTD,</span><br><span class="line">                                State.FSP, Constants.EXTERNAL_ACCESS_DEFAULT_FSP);</span><br><span class="line">                        fSecurityPropertyMgr.setValue(Property.ACCESS_EXTERNAL_SCHEMA,</span><br><span class="line">                                State.FSP, Constants.EXTERNAL_ACCESS_DEFAULT_FSP);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">this</span>.grammar = dbf.getSchema();</span><br><span class="line">        <span class="keyword">if</span> (grammar != <span class="keyword">null</span>) &#123;</span><br><span class="line">            XMLParserConfiguration config = domParser.getXMLParserConfiguration();</span><br><span class="line">            XMLComponent validatorComponent = <span class="keyword">null</span>;</span><br><span class="line">            <span class="comment">/** For Xerces grammars, use built-in schema validator. **/</span></span><br><span class="line">            <span class="keyword">if</span> (grammar <span class="keyword">instanceof</span> XSGrammarPoolContainer) &#123;</span><br><span class="line">                validatorComponent = <span class="keyword">new</span> XMLSchemaValidator();</span><br><span class="line">                fSchemaValidationManager = <span class="keyword">new</span> ValidationManager();</span><br><span class="line">                fUnparsedEntityHandler = <span class="keyword">new</span> UnparsedEntityHandler(fSchemaValidationManager);</span><br><span class="line">                config.setDTDHandler(fUnparsedEntityHandler);</span><br><span class="line">                fUnparsedEntityHandler.setDTDHandler(domParser);</span><br><span class="line">                domParser.setDTDSource(fUnparsedEntityHandler);</span><br><span class="line">                fSchemaValidatorComponentManager = <span class="keyword">new</span> SchemaValidatorConfiguration(config,</span><br><span class="line">                        (XSGrammarPoolContainer) grammar, fSchemaValidationManager);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">/** For third party grammars, use the JAXP validator component. **/</span></span><br><span class="line">            <span class="keyword">else</span> &#123;</span><br><span class="line">                validatorComponent = <span class="keyword">new</span> JAXPValidatorComponent(grammar.newValidatorHandler());</span><br><span class="line">                fSchemaValidationManager = <span class="keyword">null</span>;</span><br><span class="line">                fUnparsedEntityHandler = <span class="keyword">null</span>;</span><br><span class="line">                fSchemaValidatorComponentManager = config;</span><br><span class="line">            &#125;</span><br><span class="line">            config.addRecognizedFeatures(validatorComponent.getRecognizedFeatures());</span><br><span class="line">            config.addRecognizedProperties(validatorComponent.getRecognizedProperties());</span><br><span class="line">            setFeatures(features);      <span class="comment">// Must set before calling setDocumentHandler()</span></span><br><span class="line">            config.setDocumentHandler((XMLDocumentHandler) validatorComponent);</span><br><span class="line">            ((XMLDocumentSource)validatorComponent).setDocumentHandler(domParser);</span><br><span class="line">            domParser.setDocumentSource((XMLDocumentSource) validatorComponent);</span><br><span class="line">            fSchemaValidator = validatorComponent;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> &#123;</span><br><span class="line">            fSchemaValidationManager = <span class="keyword">null</span>;</span><br><span class="line">            fUnparsedEntityHandler = <span class="keyword">null</span>;</span><br><span class="line">            fSchemaValidatorComponentManager = <span class="keyword">null</span>;</span><br><span class="line">            fSchemaValidator = <span class="keyword">null</span>;</span><br><span class="line">            setFeatures(features);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//setAttribute override those that may be set by other means</span></span><br><span class="line">        setDocumentBuilderFactoryAttributes(dbfAttrs);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Initial EntityResolver</span></span><br><span class="line">        fInitEntityResolver = domParser.getEntityResolver();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">最后找此类的一个实现</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * The entity handler interface defines methods to report information</span></span><br><span class="line"><span class="comment"> * about the start and end of entities.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@xerces</span>.internal</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@see</span> com.sun.org.apache.xerces.internal.impl.XMLEntityScanner</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Andy Clark, IBM</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">XMLEntityHandler</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">    <span class="comment">// XMLEntityHandler methods</span></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * This method notifies of the start of an entity. The DTD has the</span></span><br><span class="line"><span class="comment">     * pseudo-name of "[dtd]" parameter entity names start with '%'; and</span></span><br><span class="line"><span class="comment">     * general entities are just specified by their name.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> name     The name of the entity.</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> identifier The resource identifier.</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> encoding The auto-detected IANA encoding name of the entity</span></span><br><span class="line"><span class="comment">     *                 stream. This value will be null in those situations</span></span><br><span class="line"><span class="comment">     *                 where the entity encoding is not auto-detected (e.g.</span></span><br><span class="line"><span class="comment">     *                 internal entities or a document entity that is</span></span><br><span class="line"><span class="comment">     *                 parsed from a java.io.Reader).</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> augs     Additional information that may include infoset augmentations</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> XNIException Thrown by handler to signal an error.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">startEntity</span><span class="params">(String name,</span></span></span><br><span class="line"><span class="function"><span class="params">                            XMLResourceIdentifier identifier,</span></span></span><br><span class="line"><span class="function"><span class="params">                            String encoding, Augmentations augs)</span> <span class="keyword">throws</span> XNIException</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * This method notifies the end of an entity. The DTD has the pseudo-name</span></span><br><span class="line"><span class="comment">     * of "[dtd]" parameter entity names start with '%'; and general entities</span></span><br><span class="line"><span class="comment">     * are just specified by their name.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> name The name of the entity.</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> augs Additional information that may include infoset augmentations</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> IOException This exception might be thrown when there is premature end of entity</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> XNIException Thrown by handler to signal an error.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">endEntity</span><span class="params">(String name, Augmentations augs)</span> <span class="keyword">throws</span> IOException, XNIException</span>;</span><br><span class="line"></span><br><span class="line">&#125; <span class="comment">// interface XMLEntityHandler</span></span><br></pre></td></tr></table></figure>







<h3 id="真正做配置"><a href="#真正做配置" class="headerlink" title="真正做配置"></a>真正做配置</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">doConfigure</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        preConfigure(rootNode);</span><br><span class="line">        configurationScheduler.start();</span><br><span class="line">        <span class="keyword">if</span> (rootNode.hasChildren() &amp;&amp; rootNode.getChildren().get(<span class="number">0</span>).getName().equalsIgnoreCase(<span class="string">"Properties"</span>)) &#123;</span><br><span class="line">            <span class="comment">//处理Properties节点</span></span><br><span class="line">            <span class="keyword">final</span> Node first = rootNode.getChildren().get(<span class="number">0</span>);</span><br><span class="line">            createConfiguration(first, <span class="keyword">null</span>);</span><br><span class="line">            <span class="keyword">if</span> (first.getObject() != <span class="keyword">null</span>) &#123;</span><br><span class="line">                subst.setVariableResolver((StrLookup) first.getObject());</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">final</span> Map&lt;String, String&gt; map = <span class="keyword">this</span>.getComponent(CONTEXT_PROPERTIES);</span><br><span class="line">            <span class="keyword">final</span> StrLookup lookup = map == <span class="keyword">null</span> ? <span class="keyword">null</span> : <span class="keyword">new</span> MapLookup(map);</span><br><span class="line">            subst.setVariableResolver(<span class="keyword">new</span> Interpolator(lookup, pluginPackages));</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">boolean</span> setLoggers = <span class="keyword">false</span>;</span><br><span class="line">        <span class="keyword">boolean</span> setRoot = <span class="keyword">false</span>;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">final</span> Node child : rootNode.getChildren()) &#123;</span><br><span class="line">            <span class="keyword">if</span> (child.getName().equalsIgnoreCase(<span class="string">"Properties"</span>)) &#123;</span><br><span class="line">                <span class="keyword">if</span> (tempLookup == subst.getVariableResolver()) &#123;</span><br><span class="line">                    LOGGER.error(<span class="string">"Properties declaration must be the first element in the configuration"</span>);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            createConfiguration(child, <span class="keyword">null</span>);</span><br><span class="line">            <span class="keyword">if</span> (child.getObject() == <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (child.getName().equalsIgnoreCase(<span class="string">"Scripts"</span>)) &#123;</span><br><span class="line">                <span class="comment">//处理script节点</span></span><br><span class="line">                <span class="keyword">for</span> (<span class="keyword">final</span> AbstractScript script : child.getObject(AbstractScript[]<span class="class">.<span class="keyword">class</span>)) </span>&#123;</span><br><span class="line">                    <span class="keyword">if</span> (script <span class="keyword">instanceof</span> ScriptRef) &#123;</span><br><span class="line">                        LOGGER.error(<span class="string">"Script reference to &#123;&#125; not added. Scripts definition cannot contain script references"</span>,</span><br><span class="line">                                script.getName());</span><br><span class="line">                    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                        <span class="keyword">if</span> (scriptManager != <span class="keyword">null</span>) &#123;</span><br><span class="line">                            scriptManager.addScript(script);</span><br><span class="line">                        &#125;&#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (child.getName().equalsIgnoreCase(<span class="string">"Appenders"</span>)) &#123;</span><br><span class="line">                 <span class="comment">//处理Appenders节点</span></span><br><span class="line">                appenders = child.getObject();</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (child.isInstanceOf(Filter<span class="class">.<span class="keyword">class</span>)) </span>&#123;</span><br><span class="line">                 <span class="comment">//处理Filter节点</span></span><br><span class="line">                addFilter(child.getObject(Filter<span class="class">.<span class="keyword">class</span>))</span>;</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (child.getName().equalsIgnoreCase(<span class="string">"Loggers"</span>)) &#123;</span><br><span class="line">                 <span class="comment">//处理Loggers节点</span></span><br><span class="line">                <span class="keyword">final</span> Loggers l = child.getObject();</span><br><span class="line">                loggerConfigs = l.getMap();</span><br><span class="line">                setLoggers = <span class="keyword">true</span>;</span><br><span class="line">                <span class="keyword">if</span> (l.getRoot() != <span class="keyword">null</span>) &#123;</span><br><span class="line">                    root = l.getRoot();</span><br><span class="line">                    setRoot = <span class="keyword">true</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (child.getName().equalsIgnoreCase(<span class="string">"CustomLevels"</span>)) &#123;</span><br><span class="line">                <span class="comment">//处理CustomLevels</span></span><br><span class="line">                customLevels = child.getObject(CustomLevels<span class="class">.<span class="keyword">class</span>).<span class="title">getCustomLevels</span>()</span>;</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (child.isInstanceOf(CustomLevelConfig<span class="class">.<span class="keyword">class</span>)) </span>&#123;</span><br><span class="line">                </span><br><span class="line">                <span class="keyword">final</span> List&lt;CustomLevelConfig&gt; copy = <span class="keyword">new</span> ArrayList&lt;&gt;(customLevels);</span><br><span class="line">                copy.add(child.getObject(CustomLevelConfig<span class="class">.<span class="keyword">class</span>))</span>;</span><br><span class="line">                customLevels = copy;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">final</span> List&lt;String&gt; expected = Arrays.asList(<span class="string">"\"Appenders\""</span>, <span class="string">"\"Loggers\""</span>, <span class="string">"\"Properties\""</span>,</span><br><span class="line">                        <span class="string">"\"Scripts\""</span>, <span class="string">"\"CustomLevels\""</span>);</span><br><span class="line">                LOGGER.error(<span class="string">"Unknown object \"&#123;&#125;\" of type &#123;&#125; is ignored: try nesting it inside one of: &#123;&#125;."</span>,</span><br><span class="line">                        child.getName(), child.getObject().getClass().getName(), expected);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (!setLoggers) &#123;</span><br><span class="line">           <span class="comment">// Logger是否已经设置过，没有就设置一个默认的</span></span><br><span class="line">            LOGGER.warn(<span class="string">"No Loggers were configured, using default. Is the Loggers element missing?"</span>);</span><br><span class="line">            setToDefault();</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!setRoot) &#123;</span><br><span class="line">            <span class="comment">//Root是否已经设置过，没有就设置一个默认的</span></span><br><span class="line">            LOGGER.warn(<span class="string">"No Root logger was configured, creating default ERROR-level Root logger with Console appender"</span>);</span><br><span class="line">            setToDefault();</span><br><span class="line">            <span class="comment">// return; // LOG4J2-219: creating default root=ok, but don't exclude configured Loggers</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">final</span> Map.Entry&lt;String, LoggerConfig&gt; entry : loggerConfigs.entrySet()) &#123;</span><br><span class="line">            <span class="keyword">final</span> LoggerConfig loggerConfig = entry.getValue();</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">final</span> AppenderRef ref : loggerConfig.getAppenderRefs()) &#123;</span><br><span class="line">                <span class="keyword">final</span> Appender app = appenders.get(ref.getRef());</span><br><span class="line">                <span class="keyword">if</span> (app != <span class="keyword">null</span>) &#123;</span><br><span class="line">                    loggerConfig.addAppender(app, ref.getLevel(), ref.getFilter());</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    LOGGER.error(<span class="string">"Unable to locate appender \"&#123;&#125;\" for logger config \"&#123;&#125;\""</span>, ref.getRef(),</span><br><span class="line">                            loggerConfig);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        setParents();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"> <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">setParents</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">final</span> Map.Entry&lt;String, LoggerConfig&gt; entry : loggerConfigs.entrySet()) &#123;</span><br><span class="line">            <span class="keyword">final</span> LoggerConfig logger = entry.getValue();</span><br><span class="line">            String key = entry.getKey();</span><br><span class="line">            <span class="keyword">if</span> (!key.isEmpty()) &#123;</span><br><span class="line">                <span class="keyword">final</span> <span class="keyword">int</span> i = key.lastIndexOf(<span class="string">'.'</span>);</span><br><span class="line">                <span class="keyword">if</span> (i &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                    key = key.substring(<span class="number">0</span>, i);</span><br><span class="line">                    LoggerConfig parent = getLoggerConfig(key);</span><br><span class="line">                    <span class="keyword">if</span> (parent == <span class="keyword">null</span>) &#123;</span><br><span class="line">                        parent = root;</span><br><span class="line">                    &#125;</span><br><span class="line">                    logger.setParent(parent);</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    logger.setParent(root);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">主要是这个方法</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">createConfiguration</span><span class="params">(<span class="keyword">final</span> Node node, <span class="keyword">final</span> LogEvent event)</span> </span>&#123;</span><br><span class="line">    <span class="comment">//每一个节点都被当成一个PluginType对象，这里面的有该节点的类型，名字，还有其他信息</span></span><br><span class="line">        <span class="keyword">final</span> PluginType&lt;?&gt; type = node.getType();</span><br><span class="line">        <span class="keyword">if</span> (type != <span class="keyword">null</span> &amp;&amp; type.isDeferChildren()) &#123;</span><br><span class="line">            node.setObject(createPluginObject(type, node, event));</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">final</span> Node child : node.getChildren()) &#123;</span><br><span class="line">                如果还有内部子节点，继续递归</span><br><span class="line">                createConfiguration(child, event);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (type == <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">if</span> (node.getParent() != <span class="keyword">null</span>) &#123;</span><br><span class="line">                    LOGGER.error(<span class="string">"Unable to locate plugin for &#123;&#125;"</span>, node.getName());</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                node.setObject(createPluginObject(type, node, event));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">private</span> Object <span class="title">createPluginObject</span><span class="params">(<span class="keyword">final</span> PluginType&lt;?&gt; type, <span class="keyword">final</span> Node node, <span class="keyword">final</span> LogEvent event)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">final</span> Class&lt;?&gt; clazz = type.getPluginClass();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (Map<span class="class">.<span class="keyword">class</span>.<span class="title">isAssignableFrom</span>(<span class="title">clazz</span>)) </span>&#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="keyword">return</span> createPluginMap(node);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (<span class="keyword">final</span> Exception e) &#123;</span><br><span class="line">                LOGGER.warn(<span class="string">"Unable to create Map for &#123;&#125; of class &#123;&#125;"</span>, type.getElementName(), clazz, e);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (Collection<span class="class">.<span class="keyword">class</span>.<span class="title">isAssignableFrom</span>(<span class="title">clazz</span>)) </span>&#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="keyword">return</span> createPluginCollection(node);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (<span class="keyword">final</span> Exception e) &#123;</span><br><span class="line">                LOGGER.warn(<span class="string">"Unable to create List for &#123;&#125; of class &#123;&#125;"</span>, type.getElementName(), clazz, e);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">      最后通过PluginBuilder(type)来实现</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> PluginBuilder(type).withConfiguration(<span class="keyword">this</span>).withConfigurationNode(node).forLogEvent(event).build();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"> <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> Method <span class="title">findFactoryMethod</span><span class="params">(<span class="keyword">final</span> Class&lt;?&gt; clazz)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">final</span> Method method : clazz.getDeclaredMethods()) &#123;</span><br><span class="line">            <span class="keyword">if</span> (method.isAnnotationPresent(PluginFactory<span class="class">.<span class="keyword">class</span>) &amp;&amp;</span></span><br><span class="line"><span class="class">                <span class="title">Modifier</span>.<span class="title">isStatic</span>(<span class="title">method</span>.<span class="title">getModifiers</span>())) </span>&#123;</span><br><span class="line">                ReflectionUtil.makeAccessible(method);</span><br><span class="line">                <span class="keyword">return</span> method;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">"No factory method found for class "</span> + clazz.getName());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">如果你想要加一个 appender或者layout，但是不知道怎么加，点开对应的layout实现，在此类下一定有一个带 <span class="meta">@PluginFactory</span>注解的 方法，这个方法里面就告诉你应该怎么填写，这里面内置了一个 静态内部类Builder，这个builder就是创建该外部类对象的，里面的属性都是 反射获取属性进行注入，所以写标签是，属性名与builder的属性名一样就行</span><br><span class="line">    </span><br><span class="line">      <span class="meta">@PluginFactory</span></span><br><span class="line">    <span class="meta">@Deprecated</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> PatternLayout <span class="title">createLayout</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">            @PluginAttribute(value = <span class="string">"pattern"</span>, defaultString = DEFAULT_CONVERSION_PATTERN)</span> <span class="keyword">final</span> String pattern,</span></span><br><span class="line"><span class="function">            @<span class="title">PluginElement</span><span class="params">(<span class="string">"PatternSelector"</span>)</span> <span class="keyword">final</span> PatternSelector patternSelector,</span></span><br><span class="line"><span class="function">            @PluginConfiguration <span class="keyword">final</span> Configuration config,</span></span><br><span class="line"><span class="function">            @<span class="title">PluginElement</span><span class="params">(<span class="string">"Replace"</span>)</span> <span class="keyword">final</span> RegexReplacement replace,</span></span><br><span class="line"><span class="function">            <span class="comment">// LOG4J2-783 use platform default by default, so do not specify defaultString for charset</span></span></span><br><span class="line"><span class="function">            @<span class="title">PluginAttribute</span><span class="params">(value = <span class="string">"charset"</span>)</span> <span class="keyword">final</span> Charset charset,</span></span><br><span class="line"><span class="function">            @<span class="title">PluginAttribute</span><span class="params">(value = <span class="string">"alwaysWriteExceptions"</span>, defaultBoolean = <span class="keyword">true</span>)</span> <span class="keyword">final</span> <span class="keyword">boolean</span> alwaysWriteExceptions,</span></span><br><span class="line"><span class="function">            @<span class="title">PluginAttribute</span><span class="params">(value = <span class="string">"noConsoleNoAnsi"</span>)</span> <span class="keyword">final</span> <span class="keyword">boolean</span> noConsoleNoAnsi,</span></span><br><span class="line"><span class="function">            @<span class="title">PluginAttribute</span><span class="params">(<span class="string">"header"</span>)</span> <span class="keyword">final</span> String headerPattern,</span></span><br><span class="line"><span class="function">            @<span class="title">PluginAttribute</span><span class="params">(<span class="string">"footer"</span>)</span> <span class="keyword">final</span> String footerPattern) </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// public static final String PLUGIN_NAME = "Console";</span></span><br><span class="line">    <span class="meta">@Plugin</span>(name = ConsoleAppender.PLUGIN_NAME, category = Core.CATEGORY_NAME, elementType = Appender.ELEMENT_TYPE, printObject = <span class="keyword">true</span>)<span class="comment">// 里面的name就是标签的命名</span></span><br><span class="line">     <span class="meta">@PluginBuilderAttribute</span> 表示从标签 内部属性获取</span><br><span class="line">     <span class="meta">@PluginElement</span>(<span class="string">"Layout"</span>) 表示 从子标签获取，Layout一般是接口类型，子类实现提供的<span class="meta">@Plugin</span>里面的name就是标签名</span><br></pre></td></tr></table></figure>









<h1 id="使用"><a href="#使用" class="headerlink" title="使用"></a>使用</h1><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">test</span><span class="params">()</span></span>&#123;</span><br><span class="line"></span><br><span class="line">        Logger logger= LogManager.getLogger(<span class="string">"aa"</span>);</span><br><span class="line"><span class="comment">//日志级别与logback一致</span></span><br><span class="line">        logger.fatal(<span class="string">"fatal"</span>);</span><br><span class="line">        logger.error(<span class="string">"error"</span>);</span><br><span class="line">        logger.warn(<span class="string">"warn"</span>);</span><br><span class="line">        logger.info(<span class="string">"info"</span>);</span><br><span class="line">        logger.debug(<span class="string">"debug"</span>);</span><br><span class="line">        logger.trace(<span class="string">"trace"</span>);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>



<p>在类路径下创建一个log4j2.xml文件</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!--</span></span><br><span class="line"><span class="comment">status 是 log4j2 内部日志系统的记录日志级别</span></span><br><span class="line"><span class="comment">monitorInterval 自动加载配置文件的间隔时间，不低于5s</span></span><br><span class="line"><span class="comment">  --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">configuration</span> <span class="attr">status</span>=<span class="string">"warn"</span> <span class="attr">monitorInterval</span>=<span class="string">"5"</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!-- 集中配置属性进行管理</span></span><br><span class="line"><span class="comment">           使用时通过 $&#123;name&#125;</span></span><br><span class="line"><span class="comment">      --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">properties</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"logDir"</span>&gt;</span>F:/test<span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"console_pattern"</span>&gt;</span>%d&#123;yyyy-MM-dd HH:mm:ss&#125; [%-5p] [%t] %l - %m%n <span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;/<span class="name">properties</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!-- 定义appender 集合 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">Appenders</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- 控制台appender --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">Console</span> <span class="attr">name</span>=<span class="string">"console"</span> <span class="attr">target</span>=<span class="string">"SYSTEM_ERR"</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">PatternLayout</span> <span class="attr">pattern</span>=<span class="string">"$&#123;console_pattern&#125;"</span>&gt;</span><span class="tag">&lt;/<span class="name">PatternLayout</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">Console</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- file的appender --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">File</span> <span class="attr">name</span>=<span class="string">"file"</span> <span class="attr">fileName</span>=<span class="string">"$&#123;logDir&#125;/log4j2.log"</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">PatternLayout</span> <span class="attr">pattern</span>=<span class="string">"$&#123;console_pattern&#125;"</span>&gt;</span><span class="tag">&lt;/<span class="name">PatternLayout</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">File</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">&lt;!-- RandomAccessFile这个appender 使用了 随机读写流，就是那个可以skip和seek的流，提高文件读写效率  --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">RandomAccessFile</span> <span class="attr">name</span>=<span class="string">"accessFile"</span> <span class="attr">fileName</span>=<span class="string">"$&#123;logDir&#125;/randomLog4j2.log"</span> &gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">PatternLayout</span> <span class="attr">pattern</span>=<span class="string">"$&#123;console_pattern&#125;"</span>&gt;</span><span class="tag">&lt;/<span class="name">PatternLayout</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">RandomAccessFile</span>&gt;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="comment">&lt;!-- 日志拆分 ，</span></span><br><span class="line"><span class="comment">        filePattern是定义拆分规则的</span></span><br><span class="line"><span class="comment">        首先日志没找过指定文件大小前 被放在$&#123;logDir&#125;/rollingFile.log文件里</span></span><br><span class="line"><span class="comment">            没超过大小，但是超过指定的%d&#123;yyyy-MM-dd-HH&#125;时间级别 后 会生成一个 rollingFile-%d&#123;yyyy-MM-dd-HH&#125;-%i.log的文件</span></span><br><span class="line"><span class="comment">            超过大小，没超过指定时间，那么也会按照生成rollingFile-%d&#123;yyyy-MM-dd-HH&#125;-%i.log文件，后续还会生成一个时间相同，但是尾部序号不同的文件</span></span><br><span class="line"><span class="comment">          --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">RollingFile</span> <span class="attr">name</span>=<span class="string">"rollingFile"</span> <span class="attr">fileName</span>=<span class="string">"$&#123;logDir&#125;/rollingFile.log"</span></span></span><br><span class="line"><span class="tag">                        <span class="attr">filePattern</span>=<span class="string">"$&#123;logDir&#125;/$$&#123;yyyy-MM-dd&#125;/rollingFile-%d&#123;yyyy-MM-dd-HH&#125;-%i.log"</span> &gt;</span></span><br><span class="line">            <span class="comment">&lt;!-- appender的日志级别过滤器 --&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">ThresholdFilter</span> <span class="attr">level</span>=<span class="string">"debug"</span> <span class="attr">OnMatch</span>=<span class="string">"ACCEPT"</span> <span class="attr">OnMismatch</span>=<span class="string">"DENY"</span>&gt;</span><span class="tag">&lt;/<span class="name">ThresholdFilter</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">PatternLayout</span> <span class="attr">pattern</span>=<span class="string">"$&#123;console_pattern&#125;"</span>&gt;</span><span class="tag">&lt;/<span class="name">PatternLayout</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">Policies</span>&gt;</span></span><br><span class="line">                <span class="comment">&lt;!-- 系统启动时就触发 日志拆分规则，生成一个日志文件 --&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">OnStartupTriggeringPolicy</span>&gt;</span><span class="tag">&lt;/<span class="name">OnStartupTriggeringPolicy</span>&gt;</span></span><br><span class="line">                <span class="comment">&lt;!-- 每个日志文件的最大大小为10 mb --&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">SizeBasedTriggeringPolicy</span> <span class="attr">size</span>=<span class="string">"10 MB"</span>&gt;</span><span class="tag">&lt;/<span class="name">SizeBasedTriggeringPolicy</span>&gt;</span></span><br><span class="line">                <span class="comment">&lt;!-- 按给定的时间节点进行拆分  --&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">TimeBasedTriggeringPolicy</span>&gt;</span><span class="tag">&lt;/<span class="name">TimeBasedTriggeringPolicy</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">Policies</span>&gt;</span></span><br><span class="line"></span><br><span class="line">            <span class="comment">&lt;!-- 同一个目录下，文件个数不超过30个，超过会按照时间老的进行覆盖 --&gt;</span></span><br><span class="line"></span><br><span class="line">            <span class="tag">&lt;<span class="name">DefaultRolloverStrategy</span> <span class="attr">max</span>=<span class="string">"30"</span>&gt;</span><span class="tag">&lt;/<span class="name">DefaultRolloverStrategy</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">RollingFile</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;/<span class="name">Appenders</span>&gt;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!--  定义Logger --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">Loggers</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">Root</span> <span class="attr">level</span>=<span class="string">"info"</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">AppenderRef</span> <span class="attr">ref</span>=<span class="string">"console"</span>&gt;</span><span class="tag">&lt;/<span class="name">AppenderRef</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">Root</span>&gt;</span></span><br><span class="line">        </span><br><span class="line">    <span class="tag">&lt;/<span class="name">Loggers</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span><br></pre></td></tr></table></figure>







<h1 id="与slf4j日志门面整合"><a href="#与slf4j日志门面整合" class="headerlink" title="与slf4j日志门面整合"></a>与slf4j日志门面整合</h1><p>pom.xml</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">&lt;!-- log4j2的实现 --&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.logging.log4j<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>log4j-core<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.13.3<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">&lt;!-- log4j2 的适配 --&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.logging.log4j<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>log4j-slf4j-impl<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.13.3<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.slf4j<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>slf4j-api<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.7.26<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>



<p>原理：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br></pre></td><td class="code"><pre><span class="line">通过 包名加类名完全一样的一个不同的StaticLoggerBinder来获取一个日志工厂</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> StaticLoggerBinder SINGLETON = <span class="keyword">new</span> StaticLoggerBinder();</span><br><span class="line"></span><br><span class="line"> <span class="function"><span class="keyword">private</span> <span class="title">StaticLoggerBinder</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        loggerFactory = <span class="keyword">new</span> Log4jLoggerFactory();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">使用适配器</span><br><span class="line">    </span><br><span class="line">      <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> L <span class="title">getLogger</span><span class="params">(<span class="keyword">final</span> String name)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">final</span> LoggerContext context = getContext();</span><br><span class="line">        <span class="keyword">final</span> ConcurrentMap&lt;String, L&gt; loggers = getLoggersInContext(context);</span><br><span class="line">        <span class="keyword">final</span> L logger = loggers.get(name);</span><br><span class="line">        <span class="keyword">if</span> (logger != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> logger;</span><br><span class="line">        &#125;</span><br><span class="line">        loggers.putIfAbsent(name, newLogger(name, context));</span><br><span class="line">        <span class="keyword">return</span> loggers.get(name);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> LoggerContext <span class="title">getContext</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">final</span> Class&lt;?&gt; anchor = StackLocatorUtil.getCallerClass(FQCN, PACKAGE);</span><br><span class="line">        <span class="comment">//LogManager就是log4j2的操作了</span></span><br><span class="line">        <span class="keyword">return</span> anchor == <span class="keyword">null</span> ? LogManager.getContext() : getContext(StackLocatorUtil.getCallerClass(anchor));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"> <span class="function"><span class="keyword">public</span> ConcurrentMap&lt;String, L&gt; <span class="title">getLoggersInContext</span><span class="params">(<span class="keyword">final</span> LoggerContext context)</span> </span>&#123;</span><br><span class="line">        ConcurrentMap&lt;String, L&gt; loggers;</span><br><span class="line">        lock.readLock ().lock ();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            loggers = registry.get (context);</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            lock.readLock ().unlock ();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (loggers != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> loggers;</span><br><span class="line">        &#125;</span><br><span class="line">        lock.writeLock ().lock ();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            loggers = registry.get (context);</span><br><span class="line">            <span class="keyword">if</span> (loggers == <span class="keyword">null</span>) &#123;</span><br><span class="line">                loggers = <span class="keyword">new</span> ConcurrentHashMap&lt;&gt; ();</span><br><span class="line">                registry.put (context, loggers);</span><br><span class="line">                <span class="keyword">if</span> (context <span class="keyword">instanceof</span> LoggerContextShutdownEnabled) &#123;</span><br><span class="line">                    ((LoggerContextShutdownEnabled) context).addShutdownListener(<span class="keyword">this</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> loggers;</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            lock.writeLock ().unlock ();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> Logger <span class="title">newLogger</span><span class="params">(<span class="keyword">final</span> String name, <span class="keyword">final</span> LoggerContext context)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">final</span> String key = Logger.ROOT_LOGGER_NAME.equals(name) ? LogManager.ROOT_LOGGER_NAME : name;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> Log4jLogger(validateContext(context).getLogger(key), name);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Log4jLogger是一个内置log4j的logger实现的包装</span><br><span class="line">     <span class="function"><span class="keyword">public</span> <span class="title">Log4jLogger</span><span class="params">(<span class="keyword">final</span> ExtendedLogger logger, <span class="keyword">final</span> String name)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.logger = logger;</span><br><span class="line">        <span class="keyword">this</span>.eventLogger = <span class="string">"EventLogger"</span>.equals(name);</span><br><span class="line">        <span class="keyword">this</span>.name = name;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">调用</span><br><span class="line">    </span><br><span class="line">      <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">error</span><span class="params">(<span class="keyword">final</span> String format)</span> </span>&#123;</span><br><span class="line">        logger.logIfEnabled(FQCN, Level.ERROR, <span class="keyword">null</span>, format);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>







<h1 id="同步和异步"><a href="#同步和异步" class="headerlink" title="同步和异步"></a>同步和异步</h1><h3 id="同步流程"><a href="#同步流程" class="headerlink" title="同步流程"></a>同步流程</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">应用调用logger.info()---&gt; 全局过滤filter---&gt;Logger自身级别过滤----&gt;生成日志输出内容---》生成logevent---&gt;Logger配置的Filter进行level过滤-----》Appender的filter和level过滤---》是否Rollover---》layout处理----》输出</span><br></pre></td></tr></table></figure>



<h3 id="异步："><a href="#异步：" class="headerlink" title="异步："></a>异步：</h3><p>Logger.info —–&gt;Logger —logevent—&gt; 放入 ArrayBlokingQueue（能放入立即返回）</p>
<p>处理日志事件的线程 不断从队列获取 日志事件，然后调用对应的appender进行处理</p>
<p>异步处理主要提供两种 AsyncLogger和AsyncAppender</p>
<p>官网对异步logger和异步appender做了一些性能比较，发现最好的是  该日志系统全部使用异步logger，其次 有一部分是同步logger，而另一部分是异步logger，异步appender没什么性能提升</p>
<p>pom.xml</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">&lt;!-- 导入单机版最快的消息队列，因为log4j2依赖他 --&gt;</span></span><br><span class="line"></span><br><span class="line"> <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.lmax<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>disruptor<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.4.2<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>







<p>虽然异步的appender没什么提升，但还是看一下</p>
<p>异步appender是引入logback思想，无需disruptor</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!--</span></span><br><span class="line"><span class="comment">status 是 log4j2 内部日志系统的记录日志级别</span></span><br><span class="line"><span class="comment">monitorInterval 自动加载配置文件的间隔时间，不低于5s</span></span><br><span class="line"><span class="comment">  --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">configuration</span> <span class="attr">status</span>=<span class="string">"warn"</span> <span class="attr">monitorInterval</span>=<span class="string">"5"</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!-- 集中配置属性进行管理</span></span><br><span class="line"><span class="comment">           使用时通过 $&#123;name&#125;</span></span><br><span class="line"><span class="comment">      --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">properties</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"logDir"</span>&gt;</span>F:/test<span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"console_pattern"</span>&gt;</span>%d&#123;yyyy-MM-dd HH:mm:ss&#125; [%-5p] [%t] %l - %m%n <span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;/<span class="name">properties</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!-- 定义appender 集合 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">Appenders</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- 控制台appender --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">Console</span> <span class="attr">name</span>=<span class="string">"console"</span> <span class="attr">target</span>=<span class="string">"SYSTEM_ERR"</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">PatternLayout</span> <span class="attr">pattern</span>=<span class="string">"$&#123;console_pattern&#125;"</span>&gt;</span><span class="tag">&lt;/<span class="name">PatternLayout</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">Console</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">&lt;!-- 异步的appender本身不会处理，但是要直到 谁去处理，所以肯定要用用有具体的实现 --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">Async</span> <span class="attr">name</span>=<span class="string">"asyncConsole"</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">AppenderRef</span> <span class="attr">ref</span>=<span class="string">"console"</span>&gt;</span><span class="tag">&lt;/<span class="name">AppenderRef</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">Async</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">Appenders</span>&gt;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!--  定义Logger --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">Loggers</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">Root</span> <span class="attr">level</span>=<span class="string">"info"</span>&gt;</span></span><br><span class="line">            </span><br><span class="line">            <span class="comment">&lt;!-- 这里就使用异步的appender --&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">AppenderRef</span> <span class="attr">ref</span>=<span class="string">"asyncConsole"</span>&gt;</span><span class="tag">&lt;/<span class="name">AppenderRef</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">Root</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;/<span class="name">Loggers</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!--</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">  @Override</span></span><br><span class="line"><span class="comment">    public void append(final LogEvent logEvent) &#123;</span></span><br><span class="line"><span class="comment">        if (!isStarted()) &#123;</span></span><br><span class="line"><span class="comment">            throw new IllegalStateException("AsyncAppender " + getName() + " is not active");</span></span><br><span class="line"><span class="comment">        &#125;</span></span><br><span class="line"><span class="comment">        final Log4jLogEvent memento = Log4jLogEvent.createMemento(logEvent, includeLocation);</span></span><br><span class="line"><span class="comment">        InternalAsyncUtil.makeMessageImmutable(logEvent.getMessage());</span></span><br><span class="line"><span class="comment">        if (!transfer(memento)) &#123;</span></span><br><span class="line"><span class="comment">            //如果不能放入处理队列，进行其他当前线程直接调用处理</span></span><br><span class="line"><span class="comment">            if (blocking) &#123;</span></span><br><span class="line"><span class="comment">                if (AbstractLogger.getRecursionDepth() &gt; 1) &#123; // LOG4J2-1518, LOG4J2-2031</span></span><br><span class="line"><span class="comment">                    // If queue is full AND we are in a recursive call, call appender directly to prevent deadlock</span></span><br><span class="line"><span class="comment">                    AsyncQueueFullMessageUtil.logWarningToStatusLogger();</span></span><br><span class="line"><span class="comment">                    logMessageInCurrentThread(logEvent);</span></span><br><span class="line"><span class="comment">                &#125; else &#123;</span></span><br><span class="line"><span class="comment">                    // delegate to the event router (which may discard, enqueue and block, or log in current thread)</span></span><br><span class="line"><span class="comment">                    final EventRoute route = asyncQueueFullPolicy.getRoute(thread.getId(), memento.getLevel());</span></span><br><span class="line"><span class="comment">                    route.logMessage(this, memento);</span></span><br><span class="line"><span class="comment">                &#125;</span></span><br><span class="line"><span class="comment">            &#125; else &#123;</span></span><br><span class="line"><span class="comment">                error("Appender " + getName() + " is unable to write primary appenders. queue is full");</span></span><br><span class="line"><span class="comment">                logToErrorAppenderIfNecessary(false, memento);</span></span><br><span class="line"><span class="comment">            &#125;</span></span><br><span class="line"><span class="comment">        &#125;</span></span><br><span class="line"><span class="comment">    &#125;</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">就是开一个线程不断run</span></span><br><span class="line"><span class="comment">  @Override</span></span><br><span class="line"><span class="comment">        public void run() &#123;</span></span><br><span class="line"><span class="comment">            while (!shutdown) &#123;</span></span><br><span class="line"><span class="comment">                LogEvent event;</span></span><br><span class="line"><span class="comment">                try &#123;</span></span><br><span class="line"><span class="comment">                    event = queue.take();</span></span><br><span class="line"><span class="comment">                    if (event == SHUTDOWN_LOG_EVENT) &#123;</span></span><br><span class="line"><span class="comment">                        shutdown = true;</span></span><br><span class="line"><span class="comment">                        continue;</span></span><br><span class="line"><span class="comment">                    &#125;</span></span><br><span class="line"><span class="comment">                &#125; catch (final InterruptedException ex) &#123;</span></span><br><span class="line"><span class="comment">                    break; // LOG4J2-830</span></span><br><span class="line"><span class="comment">                &#125;</span></span><br><span class="line"><span class="comment">                event.setEndOfBatch(queue.isEmpty());</span></span><br><span class="line"><span class="comment">                final boolean success = callAppenders(event);</span></span><br><span class="line"><span class="comment">                if (!success &amp;&amp; errorAppender != null) &#123;</span></span><br><span class="line"><span class="comment">                    try &#123;</span></span><br><span class="line"><span class="comment">                        errorAppender.callAppender(event);</span></span><br><span class="line"><span class="comment">                    &#125; catch (final Exception ex) &#123;</span></span><br><span class="line"><span class="comment">                        // Silently accept the error.</span></span><br><span class="line"><span class="comment">                    &#125;</span></span><br><span class="line"><span class="comment">                &#125;</span></span><br><span class="line"><span class="comment">            &#125;</span></span><br><span class="line"><span class="comment">            // Process any remaining items in the queue.</span></span><br><span class="line"><span class="comment">            LOGGER.trace("AsyncAppender.AsyncThread shutting down. Processing remaining &#123;&#125; queue events.",</span></span><br><span class="line"><span class="comment">                queue.size());</span></span><br><span class="line"><span class="comment">            int count = 0;</span></span><br><span class="line"><span class="comment">            int ignored = 0;</span></span><br><span class="line"><span class="comment">            while (!queue.isEmpty()) &#123;</span></span><br><span class="line"><span class="comment">                try &#123;</span></span><br><span class="line"><span class="comment">                    final LogEvent event = queue.take();</span></span><br><span class="line"><span class="comment">                    if (event instanceof Log4jLogEvent) &#123;</span></span><br><span class="line"><span class="comment">                        final Log4jLogEvent logEvent = (Log4jLogEvent) event;</span></span><br><span class="line"><span class="comment">                        logEvent.setEndOfBatch(queue.isEmpty());</span></span><br><span class="line"><span class="comment">                        callAppenders(logEvent);</span></span><br><span class="line"><span class="comment">                        count++;</span></span><br><span class="line"><span class="comment">                    &#125; else &#123;</span></span><br><span class="line"><span class="comment">                        ignored++;</span></span><br><span class="line"><span class="comment">                        LOGGER.trace("Ignoring event of class &#123;&#125;", event.getClass().getName());</span></span><br><span class="line"><span class="comment">                    &#125;</span></span><br><span class="line"><span class="comment">                &#125; catch (final InterruptedException ex) &#123;</span></span><br><span class="line"><span class="comment">                    // May have been interrupted to shut down.</span></span><br><span class="line"><span class="comment">                    // Here we ignore interrupts and try to process all remaining events.</span></span><br><span class="line"><span class="comment">                &#125;</span></span><br><span class="line"><span class="comment">            &#125;</span></span><br><span class="line"><span class="comment">            LOGGER.trace("AsyncAppender.AsyncThread stopped. Queue has &#123;&#125; events remaining. "</span></span><br><span class="line"><span class="comment">                + "Processed &#123;&#125; and ignored &#123;&#125; events since shutdown started.", queue.size(), count, ignored);</span></span><br><span class="line"><span class="comment">        &#125;</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">--&gt;</span></span><br></pre></td></tr></table></figure>





<h5 id="异步logger"><a href="#异步logger" class="headerlink" title="异步logger"></a>异步logger</h5><p>第一种，就是通过指定asyncLoggerContextSeletor来获取AsyncLoggerContext进一步获取AsyncLogger</p>
<p>类路径下 创建</p>
<p>log4j2.component.properties </p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">log4jContextSelector</span>=<span class="string">org.apache.logging.log4j.core.async.AsyncLoggerContextSelector</span></span><br><span class="line"><span class="comment">#就不需要动了xml，xml所有的logger都是异步的</span></span><br></pre></td></tr></table></figure>



<h5 id="混合异步"><a href="#混合异步" class="headerlink" title="混合异步"></a>混合异步</h5><p>使用混合，必须把全局的先关闭</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="meta">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!--</span></span><br><span class="line"><span class="comment">status 是 log4j2 内部日志系统的记录日志级别</span></span><br><span class="line"><span class="comment">monitorInterval 自动加载配置文件的间隔时间，不低于5s</span></span><br><span class="line"><span class="comment">  --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">configuration</span> <span class="attr">status</span>=<span class="string">"debug"</span> <span class="attr">monitorInterval</span>=<span class="string">"5"</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!-- 集中配置属性进行管理</span></span><br><span class="line"><span class="comment">           使用时通过 $&#123;name&#125;</span></span><br><span class="line"><span class="comment">      --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">properties</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"logDir"</span>&gt;</span>F:/test<span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"console_pattern"</span>&gt;</span>%d&#123;yyyy-MM-dd HH:mm:ss&#125; [%-5p] [%t] %l - %m%n <span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;/<span class="name">properties</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!-- 定义appender 集合 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">Appenders</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- 控制台appender --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">Console</span> <span class="attr">name</span>=<span class="string">"console"</span> <span class="attr">target</span>=<span class="string">"SYSTEM_ERR"</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">PatternLayout</span> <span class="attr">pattern</span>=<span class="string">"$&#123;console_pattern&#125;"</span>&gt;</span><span class="tag">&lt;/<span class="name">PatternLayout</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">Console</span>&gt;</span></span><br><span class="line">        </span><br><span class="line">    <span class="tag">&lt;/<span class="name">Appenders</span>&gt;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!--  定义Logger --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">Loggers</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">&lt;!-- </span></span><br><span class="line"><span class="comment"> 				使用异步logger</span></span><br><span class="line"><span class="comment">               includeLocation:false 是关闭日志记录的行号信息（开启行号有可能使性能比同步还要慢）</span></span><br><span class="line"><span class="comment">                additivity：false 是不继承</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">如果使用异步日志，AsyncAppender,AsyncLogger,和全局异步，不要同时出现，否则性能会和AsyncAppender一样，降至最低</span></span><br><span class="line"><span class="comment">         --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">AsyncLogger</span> <span class="attr">name</span>=<span class="string">"aa"</span> <span class="attr">level</span>=<span class="string">"debug"</span> <span class="attr">includeLocation</span>=<span class="string">"false"</span> <span class="attr">additivity</span>=<span class="string">"false"</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">AppenderRef</span> <span class="attr">ref</span>=<span class="string">"console"</span>&gt;</span><span class="tag">&lt;/<span class="name">AppenderRef</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">AsyncLogger</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="tag">&lt;<span class="name">Root</span> <span class="attr">level</span>=<span class="string">"info"</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">AppenderRef</span> <span class="attr">ref</span>=<span class="string">"console"</span>&gt;</span><span class="tag">&lt;/<span class="name">AppenderRef</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">Root</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;/<span class="name">Loggers</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span><br></pre></td></tr></table></figure>







<h5 id="源码"><a href="#源码" class="headerlink" title="源码"></a>源码</h5><h6 id="AsyncLoggerDisruptor"><a href="#AsyncLoggerDisruptor" class="headerlink" title="AsyncLoggerDisruptor"></a>AsyncLoggerDisruptor</h6><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">异步记录器的助手类：AsyncLoggerDisruptor处理使用LMAX Disruptor的机制，并与其关联的AsyncLoggerContext一起工作，以使中断程序及其线程的生命周期与上下文的生命周期同步。上下文的AsyncLoggerDisruptor由该AsyncLoggerContext创建的所有AsyncLogger对象共享。</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> SLEEP_MILLIS_BETWEEN_DRAIN_ATTEMPTS = <span class="number">50</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> MAX_DRAIN_ATTEMPTS_BEFORE_SHUTDOWN = <span class="number">200</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Object queueFullEnqueueLock = <span class="keyword">new</span> Object();</span><br><span class="line"></span><br><span class="line"><span class="comment">//下面这个是老大哥</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">volatile</span> Disruptor&lt;RingBufferLogEvent&gt; disruptor;</span><br><span class="line">    <span class="keyword">private</span> String contextName;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">boolean</span> useThreadLocalTranslator = <span class="keyword">true</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">long</span> backgroundThreadId;</span><br><span class="line">    <span class="keyword">private</span> AsyncQueueFullPolicy asyncQueueFullPolicy;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> ringBufferSize;</span><br></pre></td></tr></table></figure>









<h6 id="队列初始化"><a href="#队列初始化" class="headerlink" title="队列初始化"></a>队列初始化</h6><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">start</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (disruptor != <span class="keyword">null</span>) &#123;</span><br><span class="line">            LOGGER.trace(</span><br><span class="line">                    <span class="string">"[&#123;&#125;] AsyncLoggerDisruptor not starting new disruptor for this context, using existing object."</span>,</span><br><span class="line">                    contextName);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        LOGGER.trace(<span class="string">"[&#123;&#125;] AsyncLoggerDisruptor creating new disruptor for this context."</span>, contextName);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//获取循环数组的大小ringBufferSize，没有使用默认</span></span><br><span class="line">    <span class="comment">//   private static final int RINGBUFFER_NO_GC_DEFAULT_SIZE = 4 * 1024;</span></span><br><span class="line">        ringBufferSize = DisruptorUtil.calculateRingBufferSize(<span class="string">"AsyncLogger.RingBufferSize"</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//初始化一个等待策略，没有使用默认</span></span><br><span class="line">        <span class="keyword">final</span> WaitStrategy waitStrategy = DisruptorUtil.createWaitStrategy(<span class="string">"AsyncLogger.WaitStrategy"</span>);</span><br><span class="line"></span><br><span class="line">    </span><br><span class="line">    <span class="comment">//创建一个线程工厂</span></span><br><span class="line">        <span class="keyword">final</span> ThreadFactory threadFactory = <span class="keyword">new</span> Log4jThreadFactory(<span class="string">"AsyncLogger["</span> + contextName + <span class="string">"]"</span>, <span class="keyword">true</span>, Thread.NORM_PRIORITY) &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> Thread <span class="title">newThread</span><span class="params">(<span class="keyword">final</span> Runnable r)</span> </span>&#123;</span><br><span class="line">                <span class="keyword">final</span> Thread result = <span class="keyword">super</span>.newThread(r);</span><br><span class="line">                backgroundThreadId = result.getId();</span><br><span class="line">                <span class="keyword">return</span> result;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line">    <span class="comment">//异步队列满是的政策（策略）</span></span><br><span class="line">        asyncQueueFullPolicy = AsyncQueueFullPolicyFactory.create();</span><br><span class="line"></span><br><span class="line">    <span class="comment">//初始化disruptor</span></span><br><span class="line">        disruptor = <span class="keyword">new</span> Disruptor&lt;&gt;(RingBufferLogEvent.FACTORY, ringBufferSize, threadFactory, ProducerType.MULTI,</span><br><span class="line">                waitStrategy);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">final</span> ExceptionHandler&lt;RingBufferLogEvent&gt; errorHandler = DisruptorUtil.getAsyncLoggerExceptionHandler();</span><br><span class="line">        disruptor.setDefaultExceptionHandler(errorHandler);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">final</span> RingBufferLogEventHandler[] handlers = &#123;<span class="keyword">new</span> RingBufferLogEventHandler()&#125;;</span><br><span class="line">        disruptor.handleEventsWith(handlers);</span><br><span class="line"></span><br><span class="line">        LOGGER.debug(<span class="string">"[&#123;&#125;] Starting AsyncLogger disruptor for this context with ringbufferSize=&#123;&#125;, waitStrategy=&#123;&#125;, "</span></span><br><span class="line">                + <span class="string">"exceptionHandler=&#123;&#125;..."</span>, contextName, disruptor.getRingBuffer().getBufferSize(), waitStrategy</span><br><span class="line">                .getClass().getSimpleName(), errorHandler);</span><br><span class="line">        disruptor.start();</span><br><span class="line"></span><br><span class="line">        LOGGER.trace(<span class="string">"[&#123;&#125;] AsyncLoggers use a &#123;&#125; translator"</span>, contextName, useThreadLocalTranslator ? <span class="string">"threadlocal"</span></span><br><span class="line">                : <span class="string">"vararg"</span>);</span><br><span class="line">        <span class="keyword">super</span>.start();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> Logger <span class="title">newInstance</span><span class="params">(<span class="keyword">final</span> LoggerContext ctx, <span class="keyword">final</span> String name, <span class="keyword">final</span> MessageFactory messageFactory)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> AsyncLogger(ctx, name, messageFactory, loggerDisruptor);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">AsyncLogger</span><span class="params">(<span class="keyword">final</span> LoggerContext context, <span class="keyword">final</span> String name, <span class="keyword">final</span> MessageFactory messageFactory,</span></span></span><br><span class="line"><span class="function"><span class="params">            <span class="keyword">final</span> AsyncLoggerDisruptor loggerDisruptor)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>(context, name, messageFactory);</span><br><span class="line">        <span class="keyword">this</span>.loggerDisruptor = loggerDisruptor;</span><br><span class="line">        includeLocation = privateConfig.loggerConfig.isIncludeLocation();</span><br><span class="line">        nanoClock = context.getConfiguration().getNanoClock();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">logger.info  </span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">       <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">logWithThreadLocalTranslator</span><span class="params">(<span class="keyword">final</span> String fqcn, <span class="keyword">final</span> StackTraceElement location, <span class="keyword">final</span> Level level,</span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="keyword">final</span> Marker marker, <span class="keyword">final</span> Message message, <span class="keyword">final</span> Throwable thrown)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// Implementation note: this method is tuned for performance. MODIFY WITH CARE!</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">final</span> RingBufferLogEventTranslator translator = getCachedTranslator();</span><br><span class="line">        initTranslator(translator, fqcn, location, level, marker, message, thrown);</span><br><span class="line">        initTranslatorThreadValues(translator);</span><br><span class="line">        publish(translator);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">   <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">publish</span><span class="params">(<span class="keyword">final</span> RingBufferLogEventTranslator translator)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (!loggerDisruptor.tryPublish(translator)) &#123;</span><br><span class="line">            <span class="comment">//生产过快，就使用当前线程消费</span></span><br><span class="line">            handleRingBufferFull(translator);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>





<h1 id="无垃圾模式"><a href="#无垃圾模式" class="headerlink" title="无垃圾模式"></a>无垃圾模式</h1><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">其实就是在创建消息时，使用threadlocal来保存，下次只需修改就好</span><br><span class="line">但是log4j2也是在<span class="number">2.6</span>才提供的，所以不要使用<span class="number">2.6</span>以前版本</span><br></pre></td></tr></table></figure>



<h1 id="RollingRandomAccessFileAppender"><a href="#RollingRandomAccessFileAppender" class="headerlink" title="RollingRandomAccessFileAppender"></a>RollingRandomAccessFileAppender</h1><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">RollingRandomAccessFileAppender与标准RollingFileAppender相似， 除了它总是被缓冲（无法关闭）并且在内部它使用ByteBuffer + RandomAccessFile而不是BufferedOutputStream。与RollingFileAppender相比，在我们的测量中，与RollingFileAppender相比，性能提高了<span class="number">20</span>-<span class="number">200</span>％。RollingRandomAccessFileAppender写入fileName参数中命名的File，然后根据TriggeringPolicy和RolloverPolicy将文件翻转。与RollingFileAppender相似，RollingRandomAccessFileAppender使用RollingRandomAccessFileManager实际执行文件I / O并执行翻转。虽然无法共享来自不同配置的RollingRandomAccessFileAppender，但如果可以访问Manager，则可以使用RollingRandomAccessFileManagers。例如，servlet容器中的两个Web应用程序可以具有自己的配置，并且如果Log4j位于这两个应用程序共同的ClassLoader中，则可以安全地写入同一文件。</span><br><span class="line"></span><br><span class="line">RollingRandomAccessFileAppender需要 TriggeringPolicy和 RolloverStrategy。触发策略确定是否应执行过渡，而RolloverStrategy定义应如何进行过渡。如果未配置RolloverStrategy，则RollingRandomAccessFileAppender将使用 DefaultRolloverStrategy。从log4j-<span class="number">2.5</span>开始，可以在DefaultRolloverStrategy中配置自定义删除操作以在翻转时运行。</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">只有在使用同步记录器,immediateFlush=<span class="keyword">true</span>才会每次刷新。</span><br><span class="line"> </span><br><span class="line">    如果immediateFlush设置为<span class="keyword">false</span>，异步日志记录器和追加器也会在一批事件结束时自动刷新。但这也保证了数据写入磁盘的效率。</span><br></pre></td></tr></table></figure>







<p>自己弄的一个配置</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">configuration</span> <span class="attr">status</span>=<span class="string">"warn"</span> <span class="attr">monitorInterval</span>=<span class="string">"1800"</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- 全局属性配置  --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">Properties</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">&lt;!-- info debug trace 日志级别共用属性配置 ↓ --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"simple_pattern"</span>&gt;</span>%d&#123;yyyy-MM-dd HH:mm:ss&#125; [%-5p] [%t] %c -- %m%n<span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"simple_log_dir"</span>&gt;</span>F:/test/logs/simple<span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- info debug trace 日志级别共用属性配置 ↑ --&gt;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="comment">&lt;!-- error 日志级别共用属性配置 ↓ --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"error_pattern"</span>&gt;</span>%d&#123;yyyy-MM-dd HH:mm:ss&#125; [%-5p] [%t] %l -- %m%n<span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"error_log_dir"</span>&gt;</span>F:/test/logs/error<span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- error 日志级别共用属性配置 ↑ --&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">&lt;!-- warn 日志级别共用属性配置 ↓ --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"warn_pattern"</span>&gt;</span>%d&#123;yyyy-MM-dd HH:mm:ss&#125; [%-5p] [%t] %l -- %m%n<span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"warn_log_dir"</span>&gt;</span>F:/test/logs/warn<span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- warn 日志级别共用属性配置 ↑ --&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;/<span class="name">Properties</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">Appenders</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">&lt;!-- ===================info debug trace 级别  ↓===================  --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">Console</span> <span class="attr">name</span>=<span class="string">"simple_console"</span> <span class="attr">target</span>=<span class="string">"SYSTEM_OUT"</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">PatternLayout</span> <span class="attr">pattern</span>=<span class="string">"$&#123;simple_pattern&#125;"</span>&gt;</span><span class="tag">&lt;/<span class="name">PatternLayout</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">Filters</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">ThresholdFilter</span> <span class="attr">level</span>=<span class="string">"warn"</span> <span class="attr">onMatch</span>=<span class="string">"DENY"</span> <span class="attr">onMismatch</span>=<span class="string">"NEUTRAL"</span>/&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">ThresholdFilter</span> <span class="attr">level</span>=<span class="string">"trace"</span> <span class="attr">onMatch</span>=<span class="string">"ACCEPT"</span> <span class="attr">onMismatch</span>=<span class="string">"DENY"</span>/&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">Filters</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">Console</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="tag">&lt;<span class="name">Routing</span> <span class="attr">name</span>=<span class="string">"simple_Routing"</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">Routes</span> <span class="attr">pattern</span>=<span class="string">"$$&#123;thread:threadName&#125;"</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">Route</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">RollingFile</span> <span class="attr">name</span>=<span class="string">"rollingFile-$&#123;thread:threadName&#125;"</span></span></span><br><span class="line"><span class="tag">                                 <span class="attr">fileName</span>=<span class="string">"$&#123;simple_log_dir&#125;/$&#123;thread:threadName&#125;.log"</span></span></span><br><span class="line"><span class="tag">                                 <span class="attr">filePattern</span>=<span class="string">"$&#123;simple_log_dir&#125;/$$&#123;date:yyyy-MM-dd&#125;/$&#123;thread:threadName&#125;=%d&#123;yyyy-MM-dd-HH&#125;=%i.log"</span> &gt;</span></span><br><span class="line">                        <span class="comment">&lt;!-- appender的日志级别过滤器 --&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">Filters</span>&gt;</span></span><br><span class="line">                            <span class="tag">&lt;<span class="name">ThresholdFilter</span> <span class="attr">level</span>=<span class="string">"warn"</span> <span class="attr">onMatch</span>=<span class="string">"DENY"</span> <span class="attr">onMismatch</span>=<span class="string">"NEUTRAL"</span>/&gt;</span></span><br><span class="line">                            <span class="tag">&lt;<span class="name">ThresholdFilter</span> <span class="attr">level</span>=<span class="string">"trace"</span> <span class="attr">onMatch</span>=<span class="string">"ACCEPT"</span> <span class="attr">onMismatch</span>=<span class="string">"DENY"</span>/&gt;</span></span><br><span class="line">                        <span class="tag">&lt;/<span class="name">Filters</span>&gt;</span></span><br><span class="line"></span><br><span class="line">                        <span class="tag">&lt;<span class="name">PatternLayout</span> <span class="attr">pattern</span>=<span class="string">"$&#123;simple_pattern&#125;"</span>&gt;</span><span class="tag">&lt;/<span class="name">PatternLayout</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">Policies</span>&gt;</span></span><br><span class="line">                            <span class="comment">&lt;!-- 系统启动时就触发 日志拆分规则，生成一个日志文件 --&gt;</span></span><br><span class="line"><span class="comment">&lt;!--                            &lt;OnStartupTriggeringPolicy&gt;&lt;/OnStartupTriggeringPolicy&gt;--&gt;</span></span><br><span class="line">                            <span class="comment">&lt;!-- 每个日志文件的最大大小为50 mb --&gt;</span></span><br><span class="line">                            <span class="tag">&lt;<span class="name">SizeBasedTriggeringPolicy</span> <span class="attr">size</span>=<span class="string">"50 MB"</span>&gt;</span><span class="tag">&lt;/<span class="name">SizeBasedTriggeringPolicy</span>&gt;</span></span><br><span class="line">                            <span class="comment">&lt;!-- 按给定的时间节点进行拆分  --&gt;</span></span><br><span class="line">                            <span class="tag">&lt;<span class="name">TimeBasedTriggeringPolicy</span>  <span class="attr">interval</span>=<span class="string">"12"</span>&gt;</span><span class="tag">&lt;/<span class="name">TimeBasedTriggeringPolicy</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;/<span class="name">Policies</span>&gt;</span></span><br><span class="line">                        <span class="comment">&lt;!-- 同一个目录下，文件个数不超过100个，超过会按照时间老的进行覆盖 --&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">DefaultRolloverStrategy</span> <span class="attr">max</span>=<span class="string">"100"</span>&gt;</span><span class="tag">&lt;/<span class="name">DefaultRolloverStrategy</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;/<span class="name">RollingFile</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">Route</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">Routes</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">Routing</span>&gt;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="comment">&lt;!-- ===================info debug trace 级别  ↑===================  --&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">&lt;!-- ===================== error 级别 ↓============================== --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">Console</span> <span class="attr">name</span>=<span class="string">"error_console"</span> <span class="attr">target</span>=<span class="string">"SYSTEM_ERR"</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">PatternLayout</span> <span class="attr">pattern</span>=<span class="string">"$&#123;error_pattern&#125;"</span>&gt;</span><span class="tag">&lt;/<span class="name">PatternLayout</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">ThresholdFilter</span> <span class="attr">level</span>=<span class="string">"error"</span> <span class="attr">onMatch</span>=<span class="string">"ACCEPT"</span> <span class="attr">onMismatch</span>=<span class="string">"DENY"</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">Console</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="tag">&lt;<span class="name">Routing</span> <span class="attr">name</span>=<span class="string">"error_Routing"</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">Routes</span> <span class="attr">pattern</span>=<span class="string">"$$&#123;thread:threadName&#125;"</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">Route</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">RollingFile</span> <span class="attr">name</span>=<span class="string">"rollingFile-$&#123;thread:threadName&#125;"</span></span></span><br><span class="line"><span class="tag">                                 <span class="attr">fileName</span>=<span class="string">"$&#123;error_log_dir&#125;/$&#123;thread:threadName&#125;.log"</span></span></span><br><span class="line"><span class="tag">                                 <span class="attr">filePattern</span>=<span class="string">"$&#123;error_log_dir&#125;/$$&#123;date:yyyy-MM-dd&#125;/$&#123;thread:threadName&#125;=%d&#123;yyyy-MM-dd-HH&#125;=%i.log"</span> &gt;</span></span><br><span class="line">                        <span class="comment">&lt;!-- appender的日志级别过滤器 --&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">ThresholdFilter</span> <span class="attr">level</span>=<span class="string">"error"</span> <span class="attr">onMatch</span>=<span class="string">"ACCEPT"</span> <span class="attr">onMismatch</span>=<span class="string">"DENY"</span>/&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">PatternLayout</span> <span class="attr">pattern</span>=<span class="string">"$&#123;error_pattern&#125;"</span>&gt;</span><span class="tag">&lt;/<span class="name">PatternLayout</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">Policies</span>&gt;</span></span><br><span class="line">                            <span class="comment">&lt;!-- 系统启动时就触发 日志拆分规则，生成一个日志文件,这个看需求 --&gt;</span></span><br><span class="line"><span class="comment">&lt;!--                            &lt;OnStartupTriggeringPolicy&gt;&lt;/OnStartupTriggeringPolicy&gt;--&gt;</span></span><br><span class="line">                            <span class="comment">&lt;!-- 每个日志文件的最大大小为50 mb --&gt;</span></span><br><span class="line">                            <span class="tag">&lt;<span class="name">SizeBasedTriggeringPolicy</span> <span class="attr">size</span>=<span class="string">"50 MB"</span>&gt;</span><span class="tag">&lt;/<span class="name">SizeBasedTriggeringPolicy</span>&gt;</span></span><br><span class="line">                            <span class="comment">&lt;!--</span></span><br><span class="line"><span class="comment">                            按给定的时间节点进行拆分 这里的12是根据上面的filePattern的级别来定</span></span><br><span class="line"><span class="comment">                            例如：%d&#123;yyyy-MM-dd-HH&#125; 那么这里的12就表示12个小时生成一个新文件</span></span><br><span class="line"><span class="comment">                             --&gt;</span></span><br><span class="line">                            <span class="tag">&lt;<span class="name">TimeBasedTriggeringPolicy</span> <span class="attr">interval</span>=<span class="string">"12"</span>&gt;</span><span class="tag">&lt;/<span class="name">TimeBasedTriggeringPolicy</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;/<span class="name">Policies</span>&gt;</span></span><br><span class="line"></span><br><span class="line">                        <span class="comment">&lt;!-- 同一个目录下，文件个数不超过100个，超过会按照时间老的进行覆盖 --&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">DefaultRolloverStrategy</span> <span class="attr">max</span>=<span class="string">"100"</span>&gt;</span><span class="tag">&lt;/<span class="name">DefaultRolloverStrategy</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;/<span class="name">RollingFile</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">Route</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">Routes</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">Routing</span>&gt;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="comment">&lt;!-- ===================== error 级别 ↑============================== --&gt;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="comment">&lt;!-- ===================== warn 级别 ↓============================== --&gt;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="tag">&lt;<span class="name">Console</span> <span class="attr">name</span>=<span class="string">"warn_console"</span> <span class="attr">target</span>=<span class="string">"SYSTEM_ERR"</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">PatternLayout</span> <span class="attr">pattern</span>=<span class="string">"$&#123;warn_pattern&#125;"</span>&gt;</span><span class="tag">&lt;/<span class="name">PatternLayout</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">Filters</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">ThresholdFilter</span> <span class="attr">level</span>=<span class="string">"error"</span> <span class="attr">onMatch</span>=<span class="string">"DENY"</span> <span class="attr">onMismatch</span>=<span class="string">"NEUTRAL"</span>/&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">ThresholdFilter</span> <span class="attr">level</span>=<span class="string">"warn"</span> <span class="attr">onMatch</span>=<span class="string">"ACCEPT"</span> <span class="attr">onMismatch</span>=<span class="string">"DENY"</span>/&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">Filters</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">Console</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="tag">&lt;<span class="name">Routing</span> <span class="attr">name</span>=<span class="string">"warn_Routing"</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">Routes</span> <span class="attr">pattern</span>=<span class="string">"$$&#123;thread:threadName&#125;"</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">Route</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">RollingFile</span> <span class="attr">name</span>=<span class="string">"rollingFile-$&#123;thread:threadName&#125;"</span></span></span><br><span class="line"><span class="tag">                                 <span class="attr">fileName</span>=<span class="string">"$&#123;warn_log_dir&#125;/$&#123;thread:threadName&#125;.log"</span></span></span><br><span class="line"><span class="tag">                                 <span class="attr">filePattern</span>=<span class="string">"$&#123;warn_log_dir&#125;/$$&#123;date:yyyy-MM-dd&#125;/$&#123;thread:threadName&#125;=%d&#123;yyyy-MM-dd-HH&#125;=%i.log"</span> &gt;</span></span><br><span class="line">                        <span class="comment">&lt;!-- appender的日志级别过滤器 --&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">Filters</span>&gt;</span></span><br><span class="line">                            <span class="tag">&lt;<span class="name">ThresholdFilter</span> <span class="attr">level</span>=<span class="string">"error"</span> <span class="attr">onMatch</span>=<span class="string">"DENY"</span> <span class="attr">onMismatch</span>=<span class="string">"NEUTRAL"</span>/&gt;</span></span><br><span class="line">                            <span class="tag">&lt;<span class="name">ThresholdFilter</span> <span class="attr">level</span>=<span class="string">"warn"</span> <span class="attr">onMatch</span>=<span class="string">"ACCEPT"</span> <span class="attr">onMismatch</span>=<span class="string">"DENY"</span>/&gt;</span></span><br><span class="line">                        <span class="tag">&lt;/<span class="name">Filters</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">PatternLayout</span> <span class="attr">pattern</span>=<span class="string">"$&#123;warn_pattern&#125;"</span>&gt;</span><span class="tag">&lt;/<span class="name">PatternLayout</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">Policies</span>&gt;</span></span><br><span class="line">                            <span class="comment">&lt;!-- 系统启动时就触发 日志拆分规则，生成一个日志文件 --&gt;</span></span><br><span class="line"><span class="comment">&lt;!--                            &lt;OnStartupTriggeringPolicy&gt;&lt;/OnStartupTriggeringPolicy&gt;--&gt;</span></span><br><span class="line">                            <span class="comment">&lt;!-- 每个日志文件的最大大小为50 mb --&gt;</span></span><br><span class="line">                            <span class="tag">&lt;<span class="name">SizeBasedTriggeringPolicy</span> <span class="attr">size</span>=<span class="string">"50 MB"</span>&gt;</span><span class="tag">&lt;/<span class="name">SizeBasedTriggeringPolicy</span>&gt;</span></span><br><span class="line">                            <span class="comment">&lt;!-- 按给定的时间节点进行拆分  --&gt;</span></span><br><span class="line">                            <span class="tag">&lt;<span class="name">TimeBasedTriggeringPolicy</span> <span class="attr">interval</span>=<span class="string">"12"</span>&gt;</span><span class="tag">&lt;/<span class="name">TimeBasedTriggeringPolicy</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;/<span class="name">Policies</span>&gt;</span></span><br><span class="line">                        <span class="comment">&lt;!-- 同一个目录下，文件个数不超过100个，超过会按照时间老的进行覆盖 --&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">DefaultRolloverStrategy</span> <span class="attr">max</span>=<span class="string">"100"</span>&gt;</span><span class="tag">&lt;/<span class="name">DefaultRolloverStrategy</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;/<span class="name">RollingFile</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">Route</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">Routes</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">Routing</span>&gt;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="comment">&lt;!-- ===================== warn 级别 ↑============================== --&gt;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;/<span class="name">Appenders</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">Loggers</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="tag">&lt;<span class="name">Logger</span> <span class="attr">name</span>=<span class="string">"error"</span> <span class="attr">level</span>=<span class="string">"error"</span> <span class="attr">additivity</span>=<span class="string">"false"</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">appenderRef</span> <span class="attr">ref</span>=<span class="string">"error_console"</span>&gt;</span><span class="tag">&lt;/<span class="name">appenderRef</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">appenderRef</span> <span class="attr">ref</span>=<span class="string">"error_Routing"</span>&gt;</span><span class="tag">&lt;/<span class="name">appenderRef</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">Logger</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="tag">&lt;<span class="name">Logger</span> <span class="attr">name</span>=<span class="string">"warn"</span> <span class="attr">level</span>=<span class="string">"warn"</span> <span class="attr">additivity</span>=<span class="string">"false"</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">appenderRef</span> <span class="attr">ref</span>=<span class="string">"warn_console"</span>&gt;</span><span class="tag">&lt;/<span class="name">appenderRef</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">appenderRef</span> <span class="attr">ref</span>=<span class="string">"warn_Routing"</span>&gt;</span><span class="tag">&lt;/<span class="name">appenderRef</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">Logger</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="tag">&lt;<span class="name">AsyncRoot</span> <span class="attr">level</span>=<span class="string">"trace"</span> <span class="attr">includeLocation</span>=<span class="string">"false"</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">appenderRef</span> <span class="attr">ref</span>=<span class="string">"simple_console"</span>&gt;</span><span class="tag">&lt;/<span class="name">appenderRef</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">appenderRef</span> <span class="attr">ref</span>=<span class="string">"simple_Routing"</span>&gt;</span><span class="tag">&lt;/<span class="name">appenderRef</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">AsyncRoot</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;/<span class="name">Loggers</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span><br></pre></td></tr></table></figure>



<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">TimeBasedTriggeringPolicy</span></span><br><span class="line"><span class="comment">基于时间的触发策略。该策略主要是完成周期性的log文件封存工作。有两个参数：</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">interval，integer型，指定两次封存动作之间的时间间隔。这个配置需要和filePattern结合使用，filePattern日期格式精确到哪一位，interval也精确到哪一个单位。注意filePattern中配置的文件重命名规则是%d&#123;yyyy-MM-dd HH-mm-ss&#125;-%i，最小的时间粒度是ss，即秒钟。</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">TimeBasedTriggeringPolicy默认的size是1，结合起来就是每1秒钟生成一个新文件。如果改成%d&#123;yyyy-MM-dd HH&#125;，最小粒度为小时，则每一个小时生成一个文件</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">modulate，boolean型，说明是否对封存时间进行调制。若modulate=true， 则封存时间将以0点为边界进行偏移计算。比如，modulate=true，interval=4hours， 那么假设上次封存日志的时间为03:00，则下次封存日志的时间为04:00， 之后的封存时间依次为08:00，12:00，16:00</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">简单示例：</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="meta">@Plugin</span>(name = <span class="string">"thread"</span>,category = StrLookup.CATEGORY)</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">ThreadLookup</span> <span class="keyword">implements</span> <span class="title">StrLookup</span></span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> String <span class="title">lookup</span><span class="params">(String key)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> Thread.currentThread().getName();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> String <span class="title">lookup</span><span class="params">(LogEvent event, String key)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> event.getThreadName()==<span class="keyword">null</span>?Thread.currentThread().getName():event.getThreadName();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> String <span class="title">toString</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="string">"是一个Log4j2的获取当前线程名称的插件"</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>


    

    
    <div class="page-reward">
      <a href="javascript:void(0);" class="page-reward-btn tooltip-top" target="_self">
        <div class="tooltip tooltip-east">
          <span class="tooltip-item">
            赏
          </span>
          <span class="tooltip-content">
            <span class="tooltip-text">
              <span class="tooltip-inner">
                <p class="reward-p"><i class="icon icon-quo-left"></i>谢谢你请我吃糖果<i
                    class="icon icon-quo-right"></i></p>
                <div class="reward-box">
                  
                  <div class="reward-box-item">
                    <img class="reward-img" src="/img/alipay.jpg">
                    <span class="reward-type">支付宝</span>
                  </div>
                  
                  
                  <div class="reward-box-item">
                    <img class="reward-img" src="/img/weixin.jpg">
                    <span class="reward-type">微信</span>
                  </div>
                  
                </div>
              </span>
            </span>
          </span>
        </div>
      </a>
    </div>
    

    
    <div class="declare"> 
      <ul class="post-copyright">
        <li>
          <strong>本文作者：</strong>
          忘忧症
        </li>
        <li>
          <strong>本文链接：</strong>
          <a href="https://NepenthesZGW.github.io/2020/02/20/framework/log/log4j2/" title="Log4j2日志框架" target="_blank">https://NepenthesZGW.github.io/2020/02/20/framework/log/log4j2/</a>
        </li>
        
        <li>
          <strong>版权声明： </strong>
          
          本博客所有文章除特别声明外，均采用 <a href="https://github.com/NepenthesZGW/NepenthesZGW.github.io/blob/master/LICENSE.TXT" rel="external nofollow" target="_blank">MIT</a> 许可协议。转载请注明出处！
        </li>
        
      </ul>
    </div>
    

  </div>
  <div class="article-info article-info-index">
    
    
    

    

    
    
<div class="share-btn share-icons tooltip-left">
  <div class="tooltip tooltip-east">
    <span class="tooltip-item">
      <a href="javascript:;" class="share-sns share-outer">
        <i class="icon icon-share"></i>
      </a>
    </span>
    <span class="tooltip-content">
      <div class="share-wrap">
        <div class="share-icons">
          <a class="weibo share-sns" href="javascript:;" data-type="weibo">
            <i class="icon icon-weibo"></i>
          </a>
          <!-- <a class="weixin share-sns wxFab" href="javascript:;" data-type="weixin">
            <i class="icon icon-weixin"></i>
          </a> -->
          <a class="qq share-sns" href="javascript:;" data-type="qq">
            <i class="icon icon-qq"></i>
          </a>
          <a class="douban share-sns" href="javascript:;" data-type="douban">
            <i class="icon icon-douban"></i>
          </a>
          <a class="qzone share-sns" href="javascript:;" data-type="qzone">
            <i class="icon icon-qzone"></i>
          </a>
          <a class="facebook share-sns" href="javascript:;" data-type="facebook">
            <i class="icon icon-facebook"></i>
          </a>
          <a class="twitter share-sns" href="javascript:;" data-type="twitter">
            <i class="icon icon-twitter"></i>
          </a>
          <a class="google share-sns" href="javascript:;" data-type="google">
            <i class="icon icon-google"></i>
          </a>
        </div>
      </div>
    </span>
  </div>
</div>

<div class="page-modal wx-share js-wx-box">
    <a class="close js-modal-close" href="javascript:;"><i class="icon icon-close"></i></a>
    <p>扫一扫，分享到微信</p>
    <div class="wx-qrcode">
     <!-- <img src="//pan.baidu.com/share/qrcode?url=https://nepentheszgw.github.io/2020/02/20/framework/log/log4j2/" alt="微信分享二维码"> -->
    </div>
</div>

<div class="mask js-mask"></div>

    
    <div class="clearfix"></div>
  </div>
  </div>
</article>


<nav id="article-nav">
  
    <a href="/2020/03/10/framework/log/%E6%97%A5%E5%BF%97%E9%97%A8%E9%9D%A2/" id="article-nav-newer" class="article-nav-link-wrap">
      <i class="icon-circle-left"></i>
      <div class="article-nav-title">
        
          日志门面
        
      </div>
    </a>
  
  
    <a href="/2020/01/20/framework/log/JUL/" id="article-nav-older" class="article-nav-link-wrap">
      <div class="article-nav-title">JUL日志框架</div>
      <i class="icon-circle-right"></i>
    </a>
  
</nav>


<aside class="wrap-side-operation">
    <div class="mod-side-operation">
        
        <div class="jump-container" id="js-jump-container" style="display:none;">
            <a href="javascript:void(0)" class="mod-side-operation__jump-to-top">
                <i class="icon-font icon-back"></i>
            </a>
            <div id="js-jump-plan-container" class="jump-plan-container" style="top: -11px;">
                <i class="icon-font icon-plane jump-plane"></i>
            </div>
        </div>
        
        
    </div>
</aside>














          </div>
        </div>
      </div>
      <footer id="footer">
  <div class="outer">
    <div id="footer-info">
    	<div class="footer-left">
    		&copy; 2020 <a href="https://NepenthesZGW.github.io/" target="_blank">忘忧症</a>
    	</div>
      	<div class="footer-right">
			
			
      		GitHub:<a href="https://github.com/NepenthesZGW/NepenthesZGW.github.io" target="_blank">NepenthesZGW.github.io</a> by Litten
      	</div>
    </div>
  </div>
  
  
	<script src="/lib/busuanzi.pure.js"></script>
	
  
  
	
	<span id="busuanzi_container_site_pv" style="display:none">
		本站总访问量<span id="busuanzi_value_site_pv"></span>次	
	        <span class="post-meta-divider" >|</span>
	</span>
  	<span id="busuanzi_container_site_uv" style='display:none'>
  		本站访客数<span id="busuanzi_value_site_uv"></span>人
  	</span>
  
</footer>

    </div>
    <script>
	var yiliaConfig = {
		mathjax: false,
		isHome: false,
		isPost: true,
		isArchive: false,
		isTag: false,
		isCategory: false,
		open_in_new: true,
		toc_hide_index: true,
		root: "/",
		innerArchive: true,
		showTags: true
	}
</script>

<script>!function(r){function e(t){if(i[t])return i[t].exports;var n=i[t]={exports:{},id:t,loaded:!1};return r[t].call(n.exports,n,n.exports,e),n.loaded=!0,n.exports}var i={};e.m=r,e.c=i,e.p="./",e(0)}([function(t,n,r){r(208),t.exports=r(205)},function(t,n,r){var d=r(3),y=r(46),g=r(26),b=r(27),x=r(47),m="prototype",S=function(t,n,r){var e,i,o,u,c=t&S.F,f=t&S.G,a=t&S.S,s=t&S.P,l=t&S.B,h=f?d:a?d[n]||(d[n]={}):(d[n]||{})[m],v=f?y:y[n]||(y[n]={}),p=v[m]||(v[m]={});for(e in f&&(r=n),r)o=((i=!c&&h&&void 0!==h[e])?h:r)[e],u=l&&i?x(o,d):s&&"function"==typeof o?x(Function.call,o):o,h&&b(h,e,o,t&S.U),v[e]!=o&&g(v,e,u),s&&p[e]!=o&&(p[e]=o)};d.core=y,S.F=1,S.G=2,S.S=4,S.P=8,S.B=16,S.W=32,S.U=64,S.R=128,t.exports=S},function(t,n,r){var e=r(5);t.exports=function(t){if(!e(t))throw TypeError(t+" is not an object!");return t}},function(t,n){var r=t.exports="undefined"!=typeof window&&window.Math==Math?window:"undefined"!=typeof self&&self.Math==Math?self:Function("return this")();"number"==typeof __g&&(__g=r)},function(t,n){t.exports=function(t){try{return!!t()}catch(t){return!0}}},function(t,n){t.exports=function(t){return"object"==typeof t?null!==t:"function"==typeof t}},function(t,n){var r=t.exports="undefined"!=typeof window&&window.Math==Math?window:"undefined"!=typeof self&&self.Math==Math?self:Function("return this")();"number"==typeof __g&&(__g=r)},function(t,n,r){var e=r(118)("wks"),i=r(79),o=r(3).Symbol,u="function"==typeof o;(t.exports=function(t){return e[t]||(e[t]=u&&o[t]||(u?o:i)("Symbol."+t))}).store=e},function(t,n,r){var e=r(49),i=Math.min;t.exports=function(t){return 0<t?i(e(t),9007199254740991):0}},function(t,n){var r={}.hasOwnProperty;t.exports=function(t,n){return r.call(t,n)}},function(t,n,r){t.exports=!r(4)(function(){return 7!=Object.defineProperty({},"a",{get:function(){return 7}}).a})},function(t,n,r){var e=r(2),i=r(174),o=r(53),u=Object.defineProperty;n.f=r(10)?Object.defineProperty:function(t,n,r){if(e(t),n=o(n,!0),e(r),i)try{return u(t,n,r)}catch(t){}if("get"in r||"set"in r)throw TypeError("Accessors not supported!");return"value"in r&&(t[n]=r.value),t}},function(t,n,r){t.exports=!r(20)(function(){return 7!=Object.defineProperty({},"a",{get:function(){return 7}}).a})},function(t,n,r){var e=r(14),i=r(24);t.exports=r(12)?function(t,n,r){return e.f(t,n,i(1,r))}:function(t,n,r){return t[n]=r,t}},function(t,n,r){var e=r(22),i=r(60),o=r(42),u=Object.defineProperty;n.f=r(12)?Object.defineProperty:function(t,n,r){if(e(t),n=o(n,!0),e(r),i)try{return u(t,n,r)}catch(t){}if("get"in r||"set"in r)throw TypeError("Accessors not supported!");return"value"in r&&(t[n]=r.value),t}},function(t,n,r){var e=r(96),i=r(34);t.exports=function(t){return e(i(t))}},function(t,n,r){var e=r(40)("wks"),i=r(25),o=r(6).Symbol,u="function"==typeof o;(t.exports=function(t){return e[t]||(e[t]=u&&o[t]||(u?o:i)("Symbol."+t))}).store=e},function(t,n,r){var e=r(51);t.exports=function(t){return Object(e(t))}},function(t,n){t.exports=function(t){return"object"==typeof t?null!==t:"function"==typeof t}},function(t,n){var r=t.exports={version:"2.6.9"};"number"==typeof __e&&(__e=r)},function(t,n){t.exports=function(t){try{return!!t()}catch(t){return!0}}},function(t,n){t.exports=function(t){if("function"!=typeof t)throw TypeError(t+" is not a function!");return t}},function(t,n,r){var e=r(18);t.exports=function(t){if(!e(t))throw TypeError(t+" is not an object!");return t}},function(t,n){t.exports=!0},function(t,n){t.exports=function(t,n){return{enumerable:!(1&t),configurable:!(2&t),writable:!(4&t),value:n}}},function(t,n){var r=0,e=Math.random();t.exports=function(t){return"Symbol(".concat(void 0===t?"":t,")_",(++r+e).toString(36))}},function(t,n,r){var e=r(11),i=r(75);t.exports=r(10)?function(t,n,r){return e.f(t,n,i(1,r))}:function(t,n,r){return t[n]=r,t}},function(t,n,r){var o=r(3),u=r(26),c=r(30),f=r(79)("src"),e=r(219),i="toString",a=(""+e).split(i);r(46).inspectSource=function(t){return e.call(t)},(t.exports=function(t,n,r,e){var i="function"==typeof r;i&&(c(r,"name")||u(r,"name",n)),t[n]!==r&&(i&&(c(r,f)||u(r,f,t[n]?""+t[n]:a.join(String(n)))),t===o?t[n]=r:e?t[n]?t[n]=r:u(t,n,r):(delete t[n],u(t,n,r)))})(Function.prototype,i,function(){return"function"==typeof this&&this[f]||e.call(this)})},function(t,n,r){var e=r(1),i=r(4),u=r(51),c=/"/g,o=function(t,n,r,e){var i=String(u(t)),o="<"+n;return""!==r&&(o+=" "+r+'="'+String(e).replace(c,"&quot;")+'"'),o+">"+i+"</"+n+">"};t.exports=function(n,t){var r={};r[n]=t(o),e(e.P+e.F*i(function(){var t=""[n]('"');return t!==t.toLowerCase()||3<t.split('"').length}),"String",r)}},function(t,n,r){var e=r(65),i=r(35);t.exports=Object.keys||function(t){return e(t,i)}},function(t,n){var r={}.hasOwnProperty;t.exports=function(t,n){return r.call(t,n)}},function(t,n,r){var e=r(117),i=r(75),o=r(33),u=r(53),c=r(30),f=r(174),a=Object.getOwnPropertyDescriptor;n.f=r(10)?a:function(t,n){if(t=o(t),n=u(n,!0),f)try{return a(t,n)}catch(t){}if(c(t,n))return i(!e.f.call(t,n),t[n])}},function(t,n,r){var e=r(30),i=r(17),o=r(154)("IE_PROTO"),u=Object.prototype;t.exports=Object.getPrototypeOf||function(t){return t=i(t),e(t,o)?t[o]:"function"==typeof t.constructor&&t instanceof t.constructor?t.constructor.prototype:t instanceof Object?u:null}},function(t,n,r){var e=r(116),i=r(51);t.exports=function(t){return e(i(t))}},function(t,n){t.exports=function(t){if(null==t)throw TypeError("Can't call method on  "+t);return t}},function(t,n){t.exports="constructor,hasOwnProperty,isPrototypeOf,propertyIsEnumerable,toLocaleString,toString,valueOf".split(",")},function(t,n){t.exports={}},function(t,n){n.f={}.propertyIsEnumerable},function(t,n,r){var e=r(14).f,i=r(9),o=r(16)("toStringTag");t.exports=function(t,n,r){t&&!i(t=r?t:t.prototype,o)&&e(t,o,{configurable:!0,value:n})}},function(t,n,r){var e=r(40)("keys"),i=r(25);t.exports=function(t){return e[t]||(e[t]=i(t))}},function(t,n,r){var e=r(19),i=r(6),o="__core-js_shared__",u=i[o]||(i[o]={});(t.exports=function(t,n){return u[t]||(u[t]=void 0!==n?n:{})})("versions",[]).push({version:e.version,mode:r(23)?"pure":"global",copyright:"© 2019 Denis Pushkarev (zloirock.ru)"})},function(t,n){var r=Math.ceil,e=Math.floor;t.exports=function(t){return isNaN(t=+t)?0:(0<t?e:r)(t)}},function(t,n,r){var i=r(18);t.exports=function(t,n){if(!i(t))return t;var r,e;if(n&&"function"==typeof(r=t.toString)&&!i(e=r.call(t)))return e;if("function"==typeof(r=t.valueOf)&&!i(e=r.call(t)))return e;if(!n&&"function"==typeof(r=t.toString)&&!i(e=r.call(t)))return e;throw TypeError("Can't convert object to primitive value")}},function(t,n,r){var e=r(6),i=r(19),o=r(23),u=r(44),c=r(14).f;t.exports=function(t){var n=i.Symbol||(i.Symbol=o?{}:e.Symbol||{});"_"==t.charAt(0)||t in n||c(n,t,{value:u.f(t)})}},function(t,n,r){n.f=r(16)},function(t,n){var r={}.toString;t.exports=function(t){return r.call(t).slice(8,-1)}},function(t,n){var r=t.exports={version:"2.6.9"};"number"==typeof __e&&(__e=r)},function(t,n,r){var o=r(21);t.exports=function(e,i,t){if(o(e),void 0===i)return e;switch(t){case 1:return function(t){return e.call(i,t)};case 2:return function(t,n){return e.call(i,t,n)};case 3:return function(t,n,r){return e.call(i,t,n,r)}}return function(){return e.apply(i,arguments)}}},function(t,n,r){"use strict";var e=r(4);t.exports=function(t,n){return!!t&&e(function(){n?t.call(null,function(){},1):t.call(null)})}},function(t,n){var r=Math.ceil,e=Math.floor;t.exports=function(t){return isNaN(t=+t)?0:(0<t?e:r)(t)}},function(t,n,r){var x=r(47),m=r(116),S=r(17),w=r(8),e=r(138);t.exports=function(l,t){var h=1==l,v=2==l,p=3==l,d=4==l,y=6==l,g=5==l||y,b=t||e;return function(t,n,r){for(var e,i,o=S(t),u=m(o),c=x(n,r,3),f=w(u.length),a=0,s=h?b(t,f):v?b(t,0):void 0;a<f;a++)if((g||a in u)&&(i=c(e=u[a],a,o),l))if(h)s[a]=i;else if(i)switch(l){case 3:return!0;case 5:return e;case 6:return a;case 2:s.push(e)}else if(d)return!1;return y?-1:p||d?d:s}}},function(t,n){t.exports=function(t){if(null==t)throw TypeError("Can't call method on  "+t);return t}},function(t,n,r){var i=r(1),o=r(46),u=r(4);t.exports=function(t,n){var r=(o.Object||{})[t]||Object[t],e={};e[t]=n(r),i(i.S+i.F*u(function(){r(1)}),"Object",e)}},function(t,n,r){var i=r(5);t.exports=function(t,n){if(!i(t))return t;var r,e;if(n&&"function"==typeof(r=t.toString)&&!i(e=r.call(t)))return e;if("function"==typeof(r=t.valueOf)&&!i(e=r.call(t)))return e;if(!n&&"function"==typeof(r=t.toString)&&!i(e=r.call(t)))return e;throw TypeError("Can't convert object to primitive value")}},function(t,n,r){var d=r(6),y=r(19),g=r(93),b=r(13),x=r(9),m="prototype",S=function(t,n,r){var e,i,o,u=t&S.F,c=t&S.G,f=t&S.S,a=t&S.P,s=t&S.B,l=t&S.W,h=c?y:y[n]||(y[n]={}),v=h[m],p=c?d:f?d[n]:(d[n]||{})[m];for(e in c&&(r=n),r)(i=!u&&p&&void 0!==p[e])&&x(h,e)||(o=i?p[e]:r[e],h[e]=c&&"function"!=typeof p[e]?r[e]:s&&i?g(o,d):l&&p[e]==o?function(e){var t=function(t,n,r){if(this instanceof e){switch(arguments.length){case 0:return new e;case 1:return new e(t);case 2:return new e(t,n)}return new e(t,n,r)}return e.apply(this,arguments)};return t[m]=e[m],t}(o):a&&"function"==typeof o?g(Function.call,o):o,a&&((h.virtual||(h.virtual={}))[e]=o,t&S.R&&v&&!v[e]&&b(v,e,o)))};S.F=1,S.G=2,S.S=4,S.P=8,S.B=16,S.W=32,S.U=64,S.R=128,t.exports=S},function(t,n,r){var e=r(34);t.exports=function(t){return Object(e(t))}},function(t,n,r){var o=r(196),e=r(1),i=r(118)("metadata"),u=i.store||(i.store=new(r(200))),c=function(t,n,r){var e=u.get(t);if(!e){if(!r)return;u.set(t,e=new o)}var i=e.get(n);if(!i){if(!r)return;e.set(n,i=new o)}return i};t.exports={store:u,map:c,has:function(t,n,r){var e=c(n,r,!1);return void 0!==e&&e.has(t)},get:function(t,n,r){var e=c(n,r,!1);return void 0===e?void 0:e.get(t)},set:function(t,n,r,e){c(r,e,!0).set(t,n)},keys:function(t,n){var r=c(t,n,!1),e=[];return r&&r.forEach(function(t,n){e.push(n)}),e},key:function(t){return void 0===t||"symbol"==typeof t?t:String(t)},exp:function(t){e(e.S,"Reflect",t)}}},function(t,n,r){"use strict";if(r(10)){var g=r(68),b=r(3),x=r(4),m=r(1),S=r(132),e=r(159),h=r(47),w=r(70),i=r(75),_=r(26),o=r(76),u=r(49),O=r(8),E=r(194),c=r(78),f=r(53),a=r(30),M=r(81),P=r(5),v=r(17),p=r(145),j=r(72),F=r(32),A=r(73).f,d=r(161),s=r(79),l=r(7),y=r(50),I=r(120),L=r(119),N=r(162),T=r(82),k=r(125),R=r(77),C=r(137),D=r(166),G=r(11),W=r(31),U=G.f,V=W.f,B=b.RangeError,q=b.TypeError,z=b.Uint8Array,K="ArrayBuffer",H="Shared"+K,J="BYTES_PER_ELEMENT",$="prototype",Y=Array[$],X=e.ArrayBuffer,Q=e.DataView,Z=y(0),tt=y(2),nt=y(3),rt=y(4),et=y(5),it=y(6),ot=I(!0),ut=I(!1),ct=N.values,ft=N.keys,at=N.entries,st=Y.lastIndexOf,lt=Y.reduce,ht=Y.reduceRight,vt=Y.join,pt=Y.sort,dt=Y.slice,yt=Y.toString,gt=Y.toLocaleString,bt=l("iterator"),xt=l("toStringTag"),mt=s("typed_constructor"),St=s("def_constructor"),wt=S.CONSTR,_t=S.TYPED,Ot=S.VIEW,Et="Wrong length!",Mt=y(1,function(t,n){return It(L(t,t[St]),n)}),Pt=x(function(){return 1===new z(new Uint16Array([1]).buffer)[0]}),jt=!!z&&!!z[$].set&&x(function(){new z(1).set({})}),Ft=function(t,n){var r=u(t);if(r<0||r%n)throw B("Wrong offset!");return r},At=function(t){if(P(t)&&_t in t)return t;throw q(t+" is not a typed array!")},It=function(t,n){if(!(P(t)&&mt in t))throw q("It is not a typed array constructor!");return new t(n)},Lt=function(t,n){return Nt(L(t,t[St]),n)},Nt=function(t,n){for(var r=0,e=n.length,i=It(t,e);r<e;)i[r]=n[r++];return i},Tt=function(t,n,r){U(t,n,{get:function(){return this._d[r]}})},kt=function(t){var n,r,e,i,o,u,c=v(t),f=arguments.length,a=1<f?arguments[1]:void 0,s=void 0!==a,l=d(c);if(null!=l&&!p(l)){for(u=l.call(c),e=[],n=0;!(o=u.next()).done;n++)e.push(o.value);c=e}for(s&&2<f&&(a=h(a,arguments[2],2)),n=0,r=O(c.length),i=It(this,r);n<r;n++)i[n]=s?a(c[n],n):c[n];return i},Rt=function(){for(var t=0,n=arguments.length,r=It(this,n);t<n;)r[t]=arguments[t++];return r},Ct=!!z&&x(function(){gt.call(new z(1))}),Dt=function(){return gt.apply(Ct?dt.call(At(this)):At(this),arguments)},Gt={copyWithin:function(t,n){return D.call(At(this),t,n,2<arguments.length?arguments[2]:void 0)},every:function(t){return rt(At(this),t,1<arguments.length?arguments[1]:void 0)},fill:function(t){return C.apply(At(this),arguments)},filter:function(t){return Lt(this,tt(At(this),t,1<arguments.length?arguments[1]:void 0))},find:function(t){return et(At(this),t,1<arguments.length?arguments[1]:void 0)},findIndex:function(t){return it(At(this),t,1<arguments.length?arguments[1]:void 0)},forEach:function(t){Z(At(this),t,1<arguments.length?arguments[1]:void 0)},indexOf:function(t){return ut(At(this),t,1<arguments.length?arguments[1]:void 0)},includes:function(t){return ot(At(this),t,1<arguments.length?arguments[1]:void 0)},join:function(t){return vt.apply(At(this),arguments)},lastIndexOf:function(t){return st.apply(At(this),arguments)},map:function(t){return Mt(At(this),t,1<arguments.length?arguments[1]:void 0)},reduce:function(t){return lt.apply(At(this),arguments)},reduceRight:function(t){return ht.apply(At(this),arguments)},reverse:function(){for(var t,n=this,r=At(n).length,e=Math.floor(r/2),i=0;i<e;)t=n[i],n[i++]=n[--r],n[r]=t;return n},some:function(t){return nt(At(this),t,1<arguments.length?arguments[1]:void 0)},sort:function(t){return pt.call(At(this),t)},subarray:function(t,n){var r=At(this),e=r.length,i=c(t,e);return new(L(r,r[St]))(r.buffer,r.byteOffset+i*r.BYTES_PER_ELEMENT,O((void 0===n?e:c(n,e))-i))}},Wt=function(t,n){return Lt(this,dt.call(At(this),t,n))},Ut=function(t){At(this);var n=Ft(arguments[1],1),r=this.length,e=v(t),i=O(e.length),o=0;if(r<i+n)throw B(Et);for(;o<i;)this[n+o]=e[o++]},Vt={entries:function(){return at.call(At(this))},keys:function(){return ft.call(At(this))},values:function(){return ct.call(At(this))}},Bt=function(t,n){return P(t)&&t[_t]&&"symbol"!=typeof n&&n in t&&String(+n)==String(n)},qt=function(t,n){return Bt(t,n=f(n,!0))?i(2,t[n]):V(t,n)},zt=function(t,n,r){return!(Bt(t,n=f(n,!0))&&P(r)&&a(r,"value"))||a(r,"get")||a(r,"set")||r.configurable||a(r,"writable")&&!r.writable||a(r,"enumerable")&&!r.enumerable?U(t,n,r):(t[n]=r.value,t)};wt||(W.f=qt,G.f=zt),m(m.S+m.F*!wt,"Object",{getOwnPropertyDescriptor:qt,defineProperty:zt}),x(function(){yt.call({})})&&(yt=gt=function(){return vt.call(this)});var Kt=o({},Gt);o(Kt,Vt),_(Kt,bt,Vt.values),o(Kt,{slice:Wt,set:Ut,constructor:function(){},toString:yt,toLocaleString:Dt}),Tt(Kt,"buffer","b"),Tt(Kt,"byteOffset","o"),Tt(Kt,"byteLength","l"),Tt(Kt,"length","e"),U(Kt,xt,{get:function(){return this[_t]}}),t.exports=function(t,l,n,o){var h=t+((o=!!o)?"Clamped":"")+"Array",r="get"+t,u="set"+t,v=b[h],c=v||{},e=v&&F(v),i=!v||!S.ABV,f={},a=v&&v[$],p=function(t,i){U(t,i,{get:function(){return t=i,(n=this._d).v[r](t*l+n.o,Pt);var t,n},set:function(t){return n=i,r=t,e=this._d,o&&(r=(r=Math.round(r))<0?0:255<r?255:255&r),void e.v[u](n*l+e.o,r,Pt);var n,r,e},enumerable:!0})};i?(v=n(function(t,n,r,e){w(t,v,h,"_d");var i,o,u,c,f=0,a=0;if(P(n)){if(!(n instanceof X||(c=M(n))==K||c==H))return _t in n?Nt(v,n):kt.call(v,n);i=n,a=Ft(r,l);var s=n.byteLength;if(void 0===e){if(s%l)throw B(Et);if((o=s-a)<0)throw B(Et)}else if(s<(o=O(e)*l)+a)throw B(Et);u=o/l}else u=E(n),i=new X(o=u*l);for(_(t,"_d",{b:i,o:a,l:o,e:u,v:new Q(i)});f<u;)p(t,f++)}),a=v[$]=j(Kt),_(a,"constructor",v)):x(function(){v(1)})&&x(function(){new v(-1)})&&k(function(t){new v,new v(null),new v(1.5),new v(t)},!0)||(v=n(function(t,n,r,e){var i;return w(t,v,h),P(n)?n instanceof X||(i=M(n))==K||i==H?void 0!==e?new c(n,Ft(r,l),e):void 0!==r?new c(n,Ft(r,l)):new c(n):_t in n?Nt(v,n):kt.call(v,n):new c(E(n))}),Z(e!==Function.prototype?A(c).concat(A(e)):A(c),function(t){t in v||_(v,t,c[t])}),v[$]=a,g||(a.constructor=v));var s=a[bt],d=!!s&&("values"==s.name||null==s.name),y=Vt.values;_(v,mt,!0),_(a,_t,h),_(a,Ot,!0),_(a,St,v),(o?new v(1)[xt]==h:xt in a)||U(a,xt,{get:function(){return h}}),f[h]=v,m(m.G+m.W+m.F*(v!=c),f),m(m.S,h,{BYTES_PER_ELEMENT:l}),m(m.S+m.F*x(function(){c.of.call(v,1)}),h,{from:kt,of:Rt}),J in a||_(a,J,l),m(m.P,h,Gt),R(h),m(m.P+m.F*jt,h,{set:Ut}),m(m.P+m.F*!d,h,Vt),g||a.toString==yt||(a.toString=yt),m(m.P+m.F*x(function(){new v(1).slice()}),h,{slice:Wt}),m(m.P+m.F*(x(function(){return[1,2].toLocaleString()!=new v([1,2]).toLocaleString()})||!x(function(){a.toLocaleString.call([1,2])})),h,{toLocaleString:Dt}),T[h]=d?s:y,g||d||_(a,bt,y)}}else t.exports=function(){}},function(t,n){var r={}.toString;t.exports=function(t){return r.call(t).slice(8,-1)}},function(t,n,r){var e=r(18),i=r(6).document,o=e(i)&&e(i.createElement);t.exports=function(t){return o?i.createElement(t):{}}},function(t,n,r){t.exports=!r(12)&&!r(20)(function(){return 7!=Object.defineProperty(r(59)("div"),"a",{get:function(){return 7}}).a})},function(t,n,r){"use strict";var x=r(23),m=r(54),S=r(66),w=r(13),_=r(36),O=r(98),E=r(38),M=r(104),P=r(16)("iterator"),j=!([].keys&&"next"in[].keys()),F="values",A=function(){return this};t.exports=function(t,n,r,e,i,o,u){O(r,n,e);var c,f,a,s=function(t){if(!j&&t in p)return p[t];switch(t){case"keys":case F:return function(){return new r(this,t)}}return function(){return new r(this,t)}},l=n+" Iterator",h=i==F,v=!1,p=t.prototype,d=p[P]||p["@@iterator"]||i&&p[i],y=d||s(i),g=i?h?s("entries"):y:void 0,b="Array"==n&&p.entries||d;if(b&&((a=M(b.call(new t)))!==Object.prototype&&a.next&&(E(a,l,!0),x||"function"==typeof a[P]||w(a,P,A))),h&&d&&d.name!==F&&(v=!0,y=function(){return d.call(this)}),x&&!u||!j&&!v&&p[P]||w(p,P,y),_[n]=y,_[l]=A,i)if(c={values:h?y:s(F),keys:o?y:s("keys"),entries:g},u)for(f in c)f in p||S(p,f,c[f]);else m(m.P+m.F*(j||v),n,c);return c}},function(t,n,e){var i=e(22),o=e(101),u=e(35),c=e(39)("IE_PROTO"),f=function(){},a="prototype",s=function(){var t,n=e(59)("iframe"),r=u.length;for(n.style.display="none",e(95).appendChild(n),n.src="javascript:",(t=n.contentWindow.document).open(),t.write("<script>document.F=Object<\/script>"),t.close(),s=t.F;r--;)delete s[a][u[r]];return s()};t.exports=Object.create||function(t,n){var r;return null!==t?(f[a]=i(t),r=new f,f[a]=null,r[c]=t):r=s(),void 0===n?r:o(r,n)}},function(t,n,r){var e=r(65),i=r(35).concat("length","prototype");n.f=Object.getOwnPropertyNames||function(t){return e(t,i)}},function(t,n){n.f=Object.getOwnPropertySymbols},function(t,n,r){var u=r(9),c=r(15),f=r(92)(!1),a=r(39)("IE_PROTO");t.exports=function(t,n){var r,e=c(t),i=0,o=[];for(r in e)r!=a&&u(e,r)&&o.push(r);for(;n.length>i;)u(e,r=n[i++])&&(~f(o,r)||o.push(r));return o}},function(t,n,r){t.exports=r(13)},function(t,n,r){var e=r(7)("unscopables"),i=Array.prototype;null==i[e]&&r(26)(i,e,{}),t.exports=function(t){i[e][t]=!0}},function(t,n){t.exports=!1},function(t,n,r){var e=r(79)("meta"),i=r(5),o=r(30),u=r(11).f,c=0,f=Object.isExtensible||function(){return!0},a=!r(4)(function(){return f(Object.preventExtensions({}))}),s=function(t){u(t,e,{value:{i:"O"+ ++c,w:{}}})},l=t.exports={KEY:e,NEED:!1,fastKey:function(t,n){if(!i(t))return"symbol"==typeof t?t:("string"==typeof t?"S":"P")+t;if(!o(t,e)){if(!f(t))return"F";if(!n)return"E";s(t)}return t[e].i},getWeak:function(t,n){if(!o(t,e)){if(!f(t))return!0;if(!n)return!1;s(t)}return t[e].w},onFreeze:function(t){return a&&l.NEED&&f(t)&&!o(t,e)&&s(t),t}}},function(t,n){t.exports=function(t,n,r,e){if(!(t instanceof n)||void 0!==e&&e in t)throw TypeError(r+": incorrect invocation!");return t}},function(t,n,r){var h=r(47),v=r(177),p=r(145),d=r(2),y=r(8),g=r(161),b={},x={};(n=t.exports=function(t,n,r,e,i){var o,u,c,f,a=i?function(){return t}:g(t),s=h(r,e,n?2:1),l=0;if("function"!=typeof a)throw TypeError(t+" is not iterable!");if(p(a)){for(o=y(t.length);l<o;l++)if((f=n?s(d(u=t[l])[0],u[1]):s(t[l]))===b||f===x)return f}else for(c=a.call(t);!(u=c.next()).done;)if((f=v(c,s,u.value,n))===b||f===x)return f}).BREAK=b,n.RETURN=x},function(t,n,e){var i=e(2),o=e(183),u=e(141),c=e(154)("IE_PROTO"),f=function(){},a="prototype",s=function(){var t,n=e(140)("iframe"),r=u.length;for(n.style.display="none",e(143).appendChild(n),n.src="javascript:",(t=n.contentWindow.document).open(),t.write("<script>document.F=Object<\/script>"),t.close(),s=t.F;r--;)delete s[a][u[r]];return s()};t.exports=Object.create||function(t,n){var r;return null!==t?(f[a]=i(t),r=new f,f[a]=null,r[c]=t):r=s(),void 0===n?r:o(r,n)}},function(t,n,r){var e=r(185),i=r(141).concat("length","prototype");n.f=Object.getOwnPropertyNames||function(t){return e(t,i)}},function(t,n,r){var e=r(185),i=r(141);t.exports=Object.keys||function(t){return e(t,i)}},function(t,n){t.exports=function(t,n){return{enumerable:!(1&t),configurable:!(2&t),writable:!(4&t),value:n}}},function(t,n,r){var i=r(27);t.exports=function(t,n,r){for(var e in n)i(t,e,n[e],r);return t}},function(t,n,r){"use strict";var e=r(3),i=r(11),o=r(10),u=r(7)("species");t.exports=function(t){var n=e[t];o&&n&&!n[u]&&i.f(n,u,{configurable:!0,get:function(){return this}})}},function(t,n,r){var e=r(49),i=Math.max,o=Math.min;t.exports=function(t,n){return(t=e(t))<0?i(t+n,0):o(t,n)}},function(t,n){var r=0,e=Math.random();t.exports=function(t){return"Symbol(".concat(void 0===t?"":t,")_",(++r+e).toString(36))}},function(t,n,r){var e=r(5);t.exports=function(t,n){if(!e(t)||t._t!==n)throw TypeError("Incompatible receiver, "+n+" required!");return t}},function(t,n,r){var i=r(45),o=r(7)("toStringTag"),u="Arguments"==i(function(){return arguments}());t.exports=function(t){var n,r,e;return void 0===t?"Undefined":null===t?"Null":"string"==typeof(r=function(t,n){try{return t[n]}catch(t){}}(n=Object(t),o))?r:u?i(n):"Object"==(e=i(n))&&"function"==typeof n.callee?"Arguments":e}},function(t,n){t.exports={}},function(t,n,r){var e=r(11).f,i=r(30),o=r(7)("toStringTag");t.exports=function(t,n,r){t&&!i(t=r?t:t.prototype,o)&&e(t,o,{configurable:!0,value:n})}},function(t,n,r){var u=r(1),e=r(51),c=r(4),f=r(157),i="["+f+"]",o=RegExp("^"+i+i+"*"),a=RegExp(i+i+"*$"),s=function(t,n,r){var e={},i=c(function(){return!!f[t]()||"​"!="​"[t]()}),o=e[t]=i?n(l):f[t];r&&(e[r]=o),u(u.P+u.F*i,"String",e)},l=s.trim=function(t,n){return t=String(e(t)),1&n&&(t=t.replace(o,"")),2&n&&(t=t.replace(a,"")),t};t.exports=s},function(t,n,r){t.exports={default:r(88),__esModule:!0}},function(t,n,r){t.exports={default:r(89),__esModule:!0}},function(t,n,r){"use strict";function e(t){return t&&t.__esModule?t:{default:t}}n.__esModule=!0;var i=e(r(86)),o=e(r(85)),u="function"==typeof o.default&&"symbol"==typeof i.default?function(t){return typeof t}:function(t){return t&&"function"==typeof o.default&&t.constructor===o.default&&t!==o.default.prototype?"symbol":typeof t};n.default="function"==typeof o.default&&"symbol"===u(i.default)?function(t){return void 0===t?"undefined":u(t)}:function(t){return t&&"function"==typeof o.default&&t.constructor===o.default&&t!==o.default.prototype?"symbol":void 0===t?"undefined":u(t)}},function(t,n,r){r(111),r(109),r(112),r(113),t.exports=r(19).Symbol},function(t,n,r){r(110),r(114),t.exports=r(44).f("iterator")},function(t,n){t.exports=function(t){if("function"!=typeof t)throw TypeError(t+" is not a function!");return t}},function(t,n){t.exports=function(){}},function(t,n,r){var f=r(15),a=r(107),s=r(106);t.exports=function(c){return function(t,n,r){var e,i=f(t),o=a(i.length),u=s(r,o);if(c&&n!=n){for(;u<o;)if((e=i[u++])!=e)return!0}else for(;u<o;u++)if((c||u in i)&&i[u]===n)return c||u||0;return!c&&-1}}},function(t,n,r){var o=r(90);t.exports=function(e,i,t){if(o(e),void 0===i)return e;switch(t){case 1:return function(t){return e.call(i,t)};case 2:return function(t,n){return e.call(i,t,n)};case 3:return function(t,n,r){return e.call(i,t,n,r)}}return function(){return e.apply(i,arguments)}}},function(t,n,r){var c=r(29),f=r(64),a=r(37);t.exports=function(t){var n=c(t),r=f.f;if(r)for(var e,i=r(t),o=a.f,u=0;i.length>u;)o.call(t,e=i[u++])&&n.push(e);return n}},function(t,n,r){var e=r(6).document;t.exports=e&&e.documentElement},function(t,n,r){var e=r(58);t.exports=Object("z").propertyIsEnumerable(0)?Object:function(t){return"String"==e(t)?t.split(""):Object(t)}},function(t,n,r){var e=r(58);t.exports=Array.isArray||function(t){return"Array"==e(t)}},function(t,n,r){"use strict";var e=r(62),i=r(24),o=r(38),u={};r(13)(u,r(16)("iterator"),function(){return this}),t.exports=function(t,n,r){t.prototype=e(u,{next:i(1,r)}),o(t,n+" Iterator")}},function(t,n){t.exports=function(t,n){return{value:n,done:!!t}}},function(t,n,r){var e=r(25)("meta"),i=r(18),o=r(9),u=r(14).f,c=0,f=Object.isExtensible||function(){return!0},a=!r(20)(function(){return f(Object.preventExtensions({}))}),s=function(t){u(t,e,{value:{i:"O"+ ++c,w:{}}})},l=t.exports={KEY:e,NEED:!1,fastKey:function(t,n){if(!i(t))return"symbol"==typeof t?t:("string"==typeof t?"S":"P")+t;if(!o(t,e)){if(!f(t))return"F";if(!n)return"E";s(t)}return t[e].i},getWeak:function(t,n){if(!o(t,e)){if(!f(t))return!0;if(!n)return!1;s(t)}return t[e].w},onFreeze:function(t){return a&&l.NEED&&f(t)&&!o(t,e)&&s(t),t}}},function(t,n,r){var u=r(14),c=r(22),f=r(29);t.exports=r(12)?Object.defineProperties:function(t,n){c(t);for(var r,e=f(n),i=e.length,o=0;o<i;)u.f(t,r=e[o++],n[r]);return t}},function(t,n,r){var e=r(37),i=r(24),o=r(15),u=r(42),c=r(9),f=r(60),a=Object.getOwnPropertyDescriptor;n.f=r(12)?a:function(t,n){if(t=o(t),n=u(n,!0),f)try{return a(t,n)}catch(t){}if(c(t,n))return i(!e.f.call(t,n),t[n])}},function(t,n,r){var e=r(15),i=r(63).f,o={}.toString,u="object"==typeof window&&window&&Object.getOwnPropertyNames?Object.getOwnPropertyNames(window):[];t.exports.f=function(t){return u&&"[object Window]"==o.call(t)?function(t){try{return i(t)}catch(t){return u.slice()}}(t):i(e(t))}},function(t,n,r){var e=r(9),i=r(55),o=r(39)("IE_PROTO"),u=Object.prototype;t.exports=Object.getPrototypeOf||function(t){return t=i(t),e(t,o)?t[o]:"function"==typeof t.constructor&&t instanceof t.constructor?t.constructor.prototype:t instanceof Object?u:null}},function(t,n,r){var f=r(41),a=r(34);t.exports=function(c){return function(t,n){var r,e,i=String(a(t)),o=f(n),u=i.length;return o<0||u<=o?c?"":void 0:(r=i.charCodeAt(o))<55296||56319<r||o+1===u||(e=i.charCodeAt(o+1))<56320||57343<e?c?i.charAt(o):r:c?i.slice(o,o+2):e-56320+(r-55296<<10)+65536}}},function(t,n,r){var e=r(41),i=Math.max,o=Math.min;t.exports=function(t,n){return(t=e(t))<0?i(t+n,0):o(t,n)}},function(t,n,r){var e=r(41),i=Math.min;t.exports=function(t){return 0<t?i(e(t),9007199254740991):0}},function(t,n,r){"use strict";var e=r(91),i=r(99),o=r(36),u=r(15);t.exports=r(61)(Array,"Array",function(t,n){this._t=u(t),this._i=0,this._k=n},function(){var t=this._t,n=this._k,r=this._i++;return!t||r>=t.length?(this._t=void 0,i(1)):i(0,"keys"==n?r:"values"==n?t[r]:[r,t[r]])},"values"),o.Arguments=o.Array,e("keys"),e("values"),e("entries")},function(t,n){},function(t,n,r){"use strict";var e=r(105)(!0);r(61)(String,"String",function(t){this._t=String(t),this._i=0},function(){var t,n=this._t,r=this._i;return r>=n.length?{value:void 0,done:!0}:(t=e(n,r),this._i+=t.length,{value:t,done:!1})})},function(t,n,r){"use strict";var e=r(6),u=r(9),i=r(12),o=r(54),c=r(66),f=r(100).KEY,a=r(20),s=r(40),l=r(38),h=r(25),v=r(16),p=r(44),d=r(43),y=r(94),g=r(97),b=r(22),x=r(18),m=r(55),S=r(15),w=r(42),_=r(24),O=r(62),E=r(103),M=r(102),P=r(64),j=r(14),F=r(29),A=M.f,I=j.f,L=E.f,N=e.Symbol,T=e.JSON,k=T&&T.stringify,R="prototype",C=v("_hidden"),D=v("toPrimitive"),G={}.propertyIsEnumerable,W=s("symbol-registry"),U=s("symbols"),V=s("op-symbols"),B=Object[R],q="function"==typeof N&&!!P.f,z=e.QObject,K=!z||!z[R]||!z[R].findChild,H=i&&a(function(){return 7!=O(I({},"a",{get:function(){return I(this,"a",{value:7}).a}})).a})?function(t,n,r){var e=A(B,n);e&&delete B[n],I(t,n,r),e&&t!==B&&I(B,n,e)}:I,J=function(t){var n=U[t]=O(N[R]);return n._k=t,n},$=q&&"symbol"==typeof N.iterator?function(t){return"symbol"==typeof t}:function(t){return t instanceof N},Y=function(t,n,r){return t===B&&Y(V,n,r),b(t),n=w(n,!0),b(r),u(U,n)?(r.enumerable?(u(t,C)&&t[C][n]&&(t[C][n]=!1),r=O(r,{enumerable:_(0,!1)})):(u(t,C)||I(t,C,_(1,{})),t[C][n]=!0),H(t,n,r)):I(t,n,r)},X=function(t,n){b(t);for(var r,e=y(n=S(n)),i=0,o=e.length;i<o;)Y(t,r=e[i++],n[r]);return t},Q=function(t){var n=G.call(this,t=w(t,!0));return!(this===B&&u(U,t)&&!u(V,t))&&(!(n||!u(this,t)||!u(U,t)||u(this,C)&&this[C][t])||n)},Z=function(t,n){if(t=S(t),n=w(n,!0),t!==B||!u(U,n)||u(V,n)){var r=A(t,n);return!r||!u(U,n)||u(t,C)&&t[C][n]||(r.enumerable=!0),r}},tt=function(t){for(var n,r=L(S(t)),e=[],i=0;r.length>i;)u(U,n=r[i++])||n==C||n==f||e.push(n);return e},nt=function(t){for(var n,r=t===B,e=L(r?V:S(t)),i=[],o=0;e.length>o;)!u(U,n=e[o++])||r&&!u(B,n)||i.push(U[n]);return i};q||(c((N=function(){if(this instanceof N)throw TypeError("Symbol is not a constructor!");var n=h(0<arguments.length?arguments[0]:void 0),r=function(t){this===B&&r.call(V,t),u(this,C)&&u(this[C],n)&&(this[C][n]=!1),H(this,n,_(1,t))};return i&&K&&H(B,n,{configurable:!0,set:r}),J(n)})[R],"toString",function(){return this._k}),M.f=Z,j.f=Y,r(63).f=E.f=tt,r(37).f=Q,P.f=nt,i&&!r(23)&&c(B,"propertyIsEnumerable",Q,!0),p.f=function(t){return J(v(t))}),o(o.G+o.W+o.F*!q,{Symbol:N});for(var rt="hasInstance,isConcatSpreadable,iterator,match,replace,search,species,split,toPrimitive,toStringTag,unscopables".split(","),et=0;rt.length>et;)v(rt[et++]);for(var it=F(v.store),ot=0;it.length>ot;)d(it[ot++]);o(o.S+o.F*!q,"Symbol",{for:function(t){return u(W,t+="")?W[t]:W[t]=N(t)},keyFor:function(t){if(!$(t))throw TypeError(t+" is not a symbol!");for(var n in W)if(W[n]===t)return n},useSetter:function(){K=!0},useSimple:function(){K=!1}}),o(o.S+o.F*!q,"Object",{create:function(t,n){return void 0===n?O(t):X(O(t),n)},defineProperty:Y,defineProperties:X,getOwnPropertyDescriptor:Z,getOwnPropertyNames:tt,getOwnPropertySymbols:nt});var ut=a(function(){P.f(1)});o(o.S+o.F*ut,"Object",{getOwnPropertySymbols:function(t){return P.f(m(t))}}),T&&o(o.S+o.F*(!q||a(function(){var t=N();return"[null]"!=k([t])||"{}"!=k({a:t})||"{}"!=k(Object(t))})),"JSON",{stringify:function(t){for(var n,r,e=[t],i=1;arguments.length>i;)e.push(arguments[i++]);if(r=n=e[1],(x(n)||void 0!==t)&&!$(t))return g(n)||(n=function(t,n){if("function"==typeof r&&(n=r.call(this,t,n)),!$(n))return n}),e[1]=n,k.apply(T,e)}}),N[R][D]||r(13)(N[R],D,N[R].valueOf),l(N,"Symbol"),l(Math,"Math",!0),l(e.JSON,"JSON",!0)},function(t,n,r){r(43)("asyncIterator")},function(t,n,r){r(43)("observable")},function(t,n,r){r(108);for(var e=r(6),i=r(13),o=r(36),u=r(16)("toStringTag"),c="CSSRuleList,CSSStyleDeclaration,CSSValueList,ClientRectList,DOMRectList,DOMStringList,DOMTokenList,DataTransferItemList,FileList,HTMLAllCollection,HTMLCollection,HTMLFormElement,HTMLSelectElement,MediaList,MimeTypeArray,NamedNodeMap,NodeList,PaintRequestList,Plugin,PluginArray,SVGLengthList,SVGNumberList,SVGPathSegList,SVGPointList,SVGStringList,SVGTransformList,SourceBufferList,StyleSheetList,TextTrackCueList,TextTrackList,TouchList".split(","),f=0;f<c.length;f++){var a=c[f],s=e[a],l=s&&s.prototype;l&&!l[u]&&i(l,u,a),o[a]=o.Array}},function(t,n,r){"use strict";var e=r(2);t.exports=function(){var t=e(this),n="";return t.global&&(n+="g"),t.ignoreCase&&(n+="i"),t.multiline&&(n+="m"),t.unicode&&(n+="u"),t.sticky&&(n+="y"),n}},function(t,n,r){var e=r(45);t.exports=Object("z").propertyIsEnumerable(0)?Object:function(t){return"String"==e(t)?t.split(""):Object(t)}},function(t,n){n.f={}.propertyIsEnumerable},function(t,n,r){var e=r(46),i=r(3),o="__core-js_shared__",u=i[o]||(i[o]={});(t.exports=function(t,n){return u[t]||(u[t]=void 0!==n?n:{})})("versions",[]).push({version:e.version,mode:r(68)?"pure":"global",copyright:"© 2019 Denis Pushkarev (zloirock.ru)"})},function(t,n,r){var i=r(2),o=r(21),u=r(7)("species");t.exports=function(t,n){var r,e=i(t).constructor;return void 0===e||null==(r=i(e)[u])?n:o(r)}},function(t,n,r){var f=r(33),a=r(8),s=r(78);t.exports=function(c){return function(t,n,r){var e,i=f(t),o=a(i.length),u=s(r,o);if(c&&n!=n){for(;u<o;)if((e=i[u++])!=e)return!0}else for(;u<o;u++)if((c||u in i)&&i[u]===n)return c||u||0;return!c&&-1}}},function(t,n,r){"use strict";var g=r(3),b=r(1),x=r(27),m=r(76),S=r(69),w=r(71),_=r(70),O=r(5),E=r(4),M=r(125),P=r(83),j=r(144);t.exports=function(e,t,n,r,i,o){var u=g[e],c=u,f=i?"set":"add",a=c&&c.prototype,s={},l=function(t){var r=a[t];x(a,t,"delete"==t?function(t){return!(o&&!O(t))&&r.call(this,0===t?0:t)}:"has"==t?function(t){return!(o&&!O(t))&&r.call(this,0===t?0:t)}:"get"==t?function(t){return o&&!O(t)?void 0:r.call(this,0===t?0:t)}:"add"==t?function(t){return r.call(this,0===t?0:t),this}:function(t,n){return r.call(this,0===t?0:t,n),this})};if("function"==typeof c&&(o||a.forEach&&!E(function(){(new c).entries().next()}))){var h=new c,v=h[f](o?{}:-0,1)!=h,p=E(function(){h.has(1)}),d=M(function(t){new c(t)}),y=!o&&E(function(){for(var t=new c,n=5;n--;)t[f](n,n);return!t.has(-0)});d||(((c=t(function(t,n){_(t,c,e);var r=j(new u,t,c);return null!=n&&w(n,i,r[f],r),r})).prototype=a).constructor=c),(p||y)&&(l("delete"),l("has"),i&&l("get")),(y||v)&&l(f),o&&a.clear&&delete a.clear}else c=r.getConstructor(t,e,i,f),m(c.prototype,n),S.NEED=!0;return P(c,e),s[e]=c,b(b.G+b.W+b.F*(c!=u),s),o||r.setStrong(c,e,i),c}},function(t,n,r){"use strict";r(197);var s=r(27),l=r(26),h=r(4),v=r(51),p=r(7),d=r(152),y=p("species"),g=!h(function(){var t=/./;return t.exec=function(){var t=[];return t.groups={a:"7"},t},"7"!=="".replace(t,"$<a>")}),b=function(){var t=/(?:)/,n=t.exec;t.exec=function(){return n.apply(this,arguments)};var r="ab".split(t);return 2===r.length&&"a"===r[0]&&"b"===r[1]}();t.exports=function(r,t,n){var e=p(r),o=!h(function(){var t={};return t[e]=function(){return 7},7!=""[r](t)}),i=o?!h(function(){var t=!1,n=/a/;return n.exec=function(){return t=!0,null},"split"===r&&(n.constructor={},n.constructor[y]=function(){return n}),n[e](""),!t}):void 0;if(!o||!i||"replace"===r&&!g||"split"===r&&!b){var u=/./[e],c=n(v,e,""[r],function(t,n,r,e,i){return n.exec===d?o&&!i?{done:!0,value:u.call(n,r,e)}:{done:!0,value:t.call(r,n,e)}:{done:!1}}),f=c[0],a=c[1];s(String.prototype,r,f),l(RegExp.prototype,e,2==t?function(t,n){return a.call(t,this,n)}:function(t){return a.call(t,this)})}}},function(t,n,r){var e=r(45);t.exports=Array.isArray||function(t){return"Array"==e(t)}},function(t,n,r){var e=r(5),i=r(45),o=r(7)("match");t.exports=function(t){var n;return e(t)&&(void 0!==(n=t[o])?!!n:"RegExp"==i(t))}},function(t,n,r){var o=r(7)("iterator"),u=!1;try{var e=[7][o]();e.return=function(){u=!0},Array.from(e,function(){throw 2})}catch(t){}t.exports=function(t,n){if(!n&&!u)return!1;var r=!1;try{var e=[7],i=e[o]();i.next=function(){return{done:r=!0}},e[o]=function(){return i},t(e)}catch(t){}return r}},function(t,n,r){"use strict";t.exports=r(68)||!r(4)(function(){var t=Math.random();__defineSetter__.call(null,t,function(){}),delete r(3)[t]})},function(t,n){n.f=Object.getOwnPropertySymbols},function(t,n,r){"use strict";var i=r(81),o=RegExp.prototype.exec;t.exports=function(t,n){var r=t.exec;if("function"==typeof r){var e=r.call(t,n);if("object"!=typeof e)throw new TypeError("RegExp exec method returned something other than an Object or null");return e}if("RegExp"!==i(t))throw new TypeError("RegExp#exec called on incompatible receiver");return o.call(t,n)}},function(t,n,r){"use strict";var e=r(1),u=r(21),c=r(47),f=r(71);t.exports=function(t){e(e.S,t,{from:function(t){var n,r,e,i,o=arguments[1];return u(this),(n=void 0!==o)&&u(o),null==t?new this:(r=[],n?(e=0,i=c(o,arguments[2],2),f(t,!1,function(t){r.push(i(t,e++))})):f(t,!1,r.push,r),new this(r))}})}},function(t,n,r){"use strict";var e=r(1);t.exports=function(t){e(e.S,t,{of:function(){for(var t=arguments.length,n=new Array(t);t--;)n[t]=arguments[t];return new this(n)}})}},function(t,n,r){var f=r(49),a=r(51);t.exports=function(c){return function(t,n){var r,e,i=String(a(t)),o=f(n),u=i.length;return o<0||u<=o?c?"":void 0:(r=i.charCodeAt(o))<55296||56319<r||o+1===u||(e=i.charCodeAt(o+1))<56320||57343<e?c?i.charAt(o):r:c?i.slice(o,o+2):e-56320+(r-55296<<10)+65536}}},function(t,n,r){for(var e,i=r(3),o=r(26),u=r(79),c=u("typed_array"),f=u("view"),a=!(!i.ArrayBuffer||!i.DataView),s=a,l=0,h="Int8Array,Uint8Array,Uint8ClampedArray,Int16Array,Uint16Array,Int32Array,Uint32Array,Float32Array,Float64Array".split(",");l<9;)(e=i[h[l++]])?(o(e.prototype,c,!0),o(e.prototype,f,!0)):s=!1;t.exports={ABV:a,CONSTR:s,TYPED:c,VIEW:f}},function(t,n,r){var e=r(3).navigator;t.exports=e&&e.userAgent||""},function(t,n){"use strict";var r,e={versions:(r=window.navigator.userAgent,{trident:-1<r.indexOf("Trident"),presto:-1<r.indexOf("Presto"),webKit:-1<r.indexOf("AppleWebKit"),gecko:-1<r.indexOf("Gecko")&&-1==r.indexOf("KHTML"),mobile:!!r.match(/AppleWebKit.*Mobile.*/),ios:!!r.match(/\(i[^;]+;( U;)? CPU.+Mac OS X/),android:-1<r.indexOf("Android")||-1<r.indexOf("Linux"),iPhone:-1<r.indexOf("iPhone")||-1<r.indexOf("Mac"),iPad:-1<r.indexOf("iPad"),webApp:-1==r.indexOf("Safari"),weixin:-1==r.indexOf("MicroMessenger")})};t.exports=e},function(t,n,r){"use strict";var e,i=r(87),l=(e=i)&&e.__esModule?e:{default:e},h=function(){function n(t,n,r){return n||r?String.fromCharCode(n||r):o[t]||t}function r(t){return s[t]}var e=/&quot;|&lt;|&gt;|&amp;|&nbsp;|&apos;|&#(\d+);|&#(\d+)/g,i=/['<> "&]/g,o={"&quot;":'"',"&lt;":"<","&gt;":">","&amp;":"&","&nbsp;":" "},u=/\u00a0/g,c=/<br\s*\/?>/gi,f=/\r?\n/g,a=/\s/g,s={};for(var t in o)s[o[t]]=t;return o["&apos;"]="'",s["'"]="&#39;",{encode:function(t){return t?(""+t).replace(i,r).replace(f,"<br/>").replace(a,"&nbsp;"):""},decode:function(t){return t?(""+t).replace(c,"\n").replace(e,n).replace(u," "):""},encodeBase16:function(t){if(!t)return t;for(var n=[],r=0,e=(t+="").length;r<e;r++)n.push(t.charCodeAt(r).toString(16).toUpperCase());return n.join("")},encodeBase16forJSON:function(t){if(!t)return t;for(var n=[],r=0,e=(t=t.replace(/[\u4E00-\u9FBF]/gi,function(t){return escape(t).replace("%u","\\u")})).length;r<e;r++)n.push(t.charCodeAt(r).toString(16).toUpperCase());return n.join("")},decodeBase16:function(t){if(!t)return t;for(var n=[],r=0,e=(t+="").length;r<e;r+=2)n.push(String.fromCharCode("0x"+t.slice(r,r+2)));return n.join("")},encodeObject:function(t){if(t instanceof Array)for(var n=0,r=t.length;n<r;n++)t[n]=h.encodeObject(t[n]);else if("object"==(void 0===t?"undefined":(0,l.default)(t)))for(var e in t)t[e]=h.encodeObject(t[e]);else if("string"==typeof t)return h.encode(t);return t},loadScript:function(t){var n=document.createElement("script");document.getElementsByTagName("body")[0].appendChild(n),n.setAttribute("src",t)},addLoadEvent:function(t){var n=window.onload;"function"!=typeof window.onload?window.onload=t:window.onload=function(){n(),t()}}}}();t.exports=h},function(t,n,r){"use strict";var e=r(131)(!0);t.exports=function(t,n,r){return n+(r?e(t,n).length:1)}},function(t,n,r){"use strict";var c=r(17),f=r(78),a=r(8);t.exports=function(t){for(var n=c(this),r=a(n.length),e=arguments.length,i=f(1<e?arguments[1]:void 0,r),o=2<e?arguments[2]:void 0,u=void 0===o?r:f(o,r);i<u;)n[i++]=t;return n}},function(t,n,r){var e=r(215);t.exports=function(t,n){return new(e(t))(n)}},function(t,n,r){"use strict";var e=r(11),i=r(75);t.exports=function(t,n,r){n in t?e.f(t,n,i(0,r)):t[n]=r}},function(t,n,r){var e=r(5),i=r(3).document,o=e(i)&&e(i.createElement);t.exports=function(t){return o?i.createElement(t):{}}},function(t,n){t.exports="constructor,hasOwnProperty,isPrototypeOf,propertyIsEnumerable,toLocaleString,toString,valueOf".split(",")},function(t,n,r){var e=r(7)("match");t.exports=function(n){var r=/./;try{"/./"[n](r)}catch(t){try{return r[e]=!1,!"/./"[n](r)}catch(n){}}return!0}},function(t,n,r){var e=r(3).document;t.exports=e&&e.documentElement},function(t,n,r){var o=r(5),u=r(153).set;t.exports=function(t,n,r){var e,i=n.constructor;return i!==r&&"function"==typeof i&&(e=i.prototype)!==r.prototype&&o(e)&&u&&u(t,e),t}},function(t,n,r){var e=r(82),i=r(7)("iterator"),o=Array.prototype;t.exports=function(t){return void 0!==t&&(e.Array===t||o[i]===t)}},function(t,n,r){"use strict";var e=r(72),i=r(75),o=r(83),u={};r(26)(u,r(7)("iterator"),function(){return this}),t.exports=function(t,n,r){t.prototype=e(u,{next:i(1,r)}),o(t,n+" Iterator")}},function(t,n,r){"use strict";var x=r(68),m=r(1),S=r(27),w=r(26),_=r(82),O=r(146),E=r(83),M=r(32),P=r(7)("iterator"),j=!([].keys&&"next"in[].keys()),F="values",A=function(){return this};t.exports=function(t,n,r,e,i,o,u){O(r,n,e);var c,f,a,s=function(t){if(!j&&t in p)return p[t];switch(t){case"keys":case F:return function(){return new r(this,t)}}return function(){return new r(this,t)}},l=n+" Iterator",h=i==F,v=!1,p=t.prototype,d=p[P]||p["@@iterator"]||i&&p[i],y=d||s(i),g=i?h?s("entries"):y:void 0,b="Array"==n&&p.entries||d;if(b&&((a=M(b.call(new t)))!==Object.prototype&&a.next&&(E(a,l,!0),x||"function"==typeof a[P]||w(a,P,A))),h&&d&&d.name!==F&&(v=!0,y=function(){return d.call(this)}),x&&!u||!j&&!v&&p[P]||w(p,P,y),_[n]=y,_[l]=A,i)if(c={values:h?y:s(F),keys:o?y:s("keys"),entries:g},u)for(f in c)f in p||S(p,f,c[f]);else m(m.P+m.F*(j||v),n,c);return c}},function(t,n){var r=Math.expm1;t.exports=!r||22025.465794806718<r(10)||r(10)<22025.465794806718||-2e-17!=r(-2e-17)?function(t){return 0==(t=+t)?t:-1e-6<t&&t<1e-6?t+t*t/2:Math.exp(t)-1}:r},function(t,n){t.exports=Math.sign||function(t){return 0==(t=+t)||t!=t?t:t<0?-1:1}},function(t,n,r){var c=r(3),f=r(158).set,a=c.MutationObserver||c.WebKitMutationObserver,s=c.process,l=c.Promise,h="process"==r(45)(s);t.exports=function(){var r,e,i,t=function(){var t,n;for(h&&(t=s.domain)&&t.exit();r;){n=r.fn,r=r.next;try{n()}catch(t){throw r?i():e=void 0,t}}e=void 0,t&&t.enter()};if(h)i=function(){s.nextTick(t)};else if(!a||c.navigator&&c.navigator.standalone)if(l&&l.resolve){var n=l.resolve(void 0);i=function(){n.then(t)}}else i=function(){f.call(c,t)};else{var o=!0,u=document.createTextNode("");new a(t).observe(u,{characterData:!0}),i=function(){u.data=o=!o}}return function(t){var n={fn:t,next:void 0};e&&(e.next=n),r||(r=n,i()),e=n}}},function(t,n,r){"use strict";function e(t){var r,e;this.promise=new t(function(t,n){if(void 0!==r||void 0!==e)throw TypeError("Bad Promise constructor");r=t,e=n}),this.resolve=i(r),this.reject=i(e)}var i=r(21);t.exports.f=function(t){return new e(t)}},function(t,n,r){"use strict";var e,i,u=r(115),c=RegExp.prototype.exec,f=String.prototype.replace,o=c,a="lastIndex",s=(e=/a/,i=/b*/g,c.call(e,"a"),c.call(i,"a"),0!==e[a]||0!==i[a]),l=void 0!==/()??/.exec("")[1];(s||l)&&(o=function(t){var n,r,e,i,o=this;return l&&(r=new RegExp("^"+o.source+"$(?!\\s)",u.call(o))),s&&(n=o[a]),e=c.call(o,t),s&&e&&(o[a]=o.global?e.index+e[0].length:n),l&&e&&1<e.length&&f.call(e[0],r,function(){for(i=1;i<arguments.length-2;i++)void 0===arguments[i]&&(e[i]=void 0)}),e}),t.exports=o},function(t,n,i){var r=i(5),e=i(2),o=function(t,n){if(e(t),!r(n)&&null!==n)throw TypeError(n+": can't set as prototype!")};t.exports={set:Object.setPrototypeOf||("__proto__"in{}?function(t,r,e){try{(e=i(47)(Function.call,i(31).f(Object.prototype,"__proto__").set,2))(t,[]),r=!(t instanceof Array)}catch(t){r=!0}return function(t,n){return o(t,n),r?t.__proto__=n:e(t,n),t}}({},!1):void 0),check:o}},function(t,n,r){var e=r(118)("keys"),i=r(79);t.exports=function(t){return e[t]||(e[t]=i(t))}},function(t,n,r){var e=r(124),i=r(51);t.exports=function(t,n,r){if(e(n))throw TypeError("String#"+r+" doesn't accept regex!");return String(i(t))}},function(t,n,r){"use strict";var i=r(49),o=r(51);t.exports=function(t){var n=String(o(this)),r="",e=i(t);if(e<0||e==1/0)throw RangeError("Count can't be negative");for(;0<e;(e>>>=1)&&(n+=n))1&e&&(r+=n);return r}},function(t,n){t.exports="\t\n\v\f\r   ᠎             　\u2028\u2029\ufeff"},function(t,n,r){var e,i,o,u=r(47),c=r(175),f=r(143),a=r(140),s=r(3),l=s.process,h=s.setImmediate,v=s.clearImmediate,p=s.MessageChannel,d=s.Dispatch,y=0,g={},b="onreadystatechange",x=function(){var t=+this;if(g.hasOwnProperty(t)){var n=g[t];delete g[t],n()}},m=function(t){x.call(t.data)};h&&v||(h=function(t){for(var n=[],r=1;arguments.length>r;)n.push(arguments[r++]);return g[++y]=function(){c("function"==typeof t?t:Function(t),n)},e(y),y},v=function(t){delete g[t]},"process"==r(45)(l)?e=function(t){l.nextTick(u(x,t,1))}:d&&d.now?e=function(t){d.now(u(x,t,1))}:p?(o=(i=new p).port2,i.port1.onmessage=m,e=u(o.postMessage,o,1)):s.addEventListener&&"function"==typeof postMessage&&!s.importScripts?(e=function(t){s.postMessage(t+"","*")},s.addEventListener("message",m,!1)):e=b in a("script")?function(t){f.appendChild(a("script"))[b]=function(){f.removeChild(this),x.call(t)}}:function(t){setTimeout(u(x,t,1),0)}),t.exports={set:h,clear:v}},function(t,n,r){"use strict";function e(t,n,r){var e,i,o,u=new Array(r),c=8*r-n-1,f=(1<<c)-1,a=f>>1,s=23===n?W(2,-24)-W(2,-77):0,l=0,h=t<0||0===t&&1/t<0?1:0;for((t=G(t))!=t||t===C?(i=t!=t?1:0,e=f):(e=U(V(t)/B),t*(o=W(2,-e))<1&&(e--,o*=2),2<=(t+=1<=e+a?s/o:s*W(2,1-a))*o&&(e++,o/=2),f<=e+a?(i=0,e=f):1<=e+a?(i=(t*o-1)*W(2,n),e+=a):(i=t*W(2,a-1)*W(2,n),e=0));8<=n;u[l++]=255&i,i/=256,n-=8);for(e=e<<n|i,c+=n;0<c;u[l++]=255&e,e/=256,c-=8);return u[--l]|=128*h,u}function i(t,n,r){var e,i=8*r-n-1,o=(1<<i)-1,u=o>>1,c=i-7,f=r-1,a=t[f--],s=127&a;for(a>>=7;0<c;s=256*s+t[f],f--,c-=8);for(e=s&(1<<-c)-1,s>>=-c,c+=n;0<c;e=256*e+t[f],f--,c-=8);if(0===s)s=1-u;else{if(s===o)return e?NaN:a?-C:C;e+=W(2,n),s-=u}return(a?-1:1)*e*W(2,s-n)}function o(t){return t[3]<<24|t[2]<<16|t[1]<<8|t[0]}function u(t){return[255&t]}function c(t){return[255&t,t>>8&255]}function f(t){return[255&t,t>>8&255,t>>16&255,t>>24&255]}function a(t){return e(t,52,8)}function s(t){return e(t,23,4)}function l(t,n,r){M(t[I],n,{get:function(){return this[r]}})}function h(t,n,r,e){var i=O(+r);if(i+n>t[H])throw R(L);var o=t[K]._b,u=i+t[J],c=o.slice(u,u+n);return e?c:c.reverse()}function v(t,n,r,e,i,o){var u=O(+r);if(u+n>t[H])throw R(L);for(var c=t[K]._b,f=u+t[J],a=e(+i),s=0;s<n;s++)c[f+s]=a[o?s:n-s-1]}var p=r(3),d=r(10),y=r(68),g=r(132),b=r(26),x=r(76),m=r(4),S=r(70),w=r(49),_=r(8),O=r(194),E=r(73).f,M=r(11).f,P=r(137),j=r(83),F="ArrayBuffer",A="DataView",I="prototype",L="Wrong index!",N=p[F],T=p[A],k=p.Math,R=p.RangeError,C=p.Infinity,D=N,G=k.abs,W=k.pow,U=k.floor,V=k.log,B=k.LN2,q="byteLength",z="byteOffset",K=d?"_b":"buffer",H=d?"_l":q,J=d?"_o":z;if(g.ABV){if(!m(function(){N(1)})||!m(function(){new N(-1)})||m(function(){return new N,new N(1.5),new N(NaN),N.name!=F})){for(var $,Y=(N=function(t){return S(this,N),new D(O(t))})[I]=D[I],X=E(D),Q=0;X.length>Q;)($=X[Q++])in N||b(N,$,D[$]);y||(Y.constructor=N)}var Z=new T(new N(2)),tt=T[I].setInt8;Z.setInt8(0,2147483648),Z.setInt8(1,2147483649),!Z.getInt8(0)&&Z.getInt8(1)||x(T[I],{setInt8:function(t,n){tt.call(this,t,n<<24>>24)},setUint8:function(t,n){tt.call(this,t,n<<24>>24)}},!0)}else N=function(t){S(this,N,F);var n=O(t);this._b=P.call(new Array(n),0),this[H]=n},T=function(t,n,r){S(this,T,A),S(t,N,A);var e=t[H],i=w(n);if(i<0||e<i)throw R("Wrong offset!");if(e<i+(r=void 0===r?e-i:_(r)))throw R("Wrong length!");this[K]=t,this[J]=i,this[H]=r},d&&(l(N,q,"_l"),l(T,"buffer","_b"),l(T,q,"_l"),l(T,z,"_o")),x(T[I],{getInt8:function(t){return h(this,1,t)[0]<<24>>24},getUint8:function(t){return h(this,1,t)[0]},getInt16:function(t){var n=h(this,2,t,arguments[1]);return(n[1]<<8|n[0])<<16>>16},getUint16:function(t){var n=h(this,2,t,arguments[1]);return n[1]<<8|n[0]},getInt32:function(t){return o(h(this,4,t,arguments[1]))},getUint32:function(t){return o(h(this,4,t,arguments[1]))>>>0},getFloat32:function(t){return i(h(this,4,t,arguments[1]),23,4)},getFloat64:function(t){return i(h(this,8,t,arguments[1]),52,8)},setInt8:function(t,n){v(this,1,t,u,n)},setUint8:function(t,n){v(this,1,t,u,n)},setInt16:function(t,n){v(this,2,t,c,n,arguments[2])},setUint16:function(t,n){v(this,2,t,c,n,arguments[2])},setInt32:function(t,n){v(this,4,t,f,n,arguments[2])},setUint32:function(t,n){v(this,4,t,f,n,arguments[2])},setFloat32:function(t,n){v(this,4,t,s,n,arguments[2])},setFloat64:function(t,n){v(this,8,t,a,n,arguments[2])}});j(N,F),j(T,A),b(T[I],g.VIEW,!0),n[F]=N,n[A]=T},function(t,n,r){var e=r(3),i=r(46),o=r(68),u=r(195),c=r(11).f;t.exports=function(t){var n=i.Symbol||(i.Symbol=o?{}:e.Symbol||{});"_"==t.charAt(0)||t in n||c(n,t,{value:u.f(t)})}},function(t,n,r){var e=r(81),i=r(7)("iterator"),o=r(82);t.exports=r(46).getIteratorMethod=function(t){if(null!=t)return t[i]||t["@@iterator"]||o[e(t)]}},function(t,n,r){"use strict";var e=r(67),i=r(178),o=r(82),u=r(33);t.exports=r(147)(Array,"Array",function(t,n){this._t=u(t),this._i=0,this._k=n},function(){var t=this._t,n=this._k,r=this._i++;return!t||r>=t.length?(this._t=void 0,i(1)):i(0,"keys"==n?r:"values"==n?t[r]:[r,t[r]])},"values"),o.Arguments=o.Array,e("keys"),e("values"),e("entries")},function(t,n){t.exports=function(t,n){t.classList?t.classList.add(n):t.className+=" "+n}},function(t,n){t.exports=function(t,n){if(t.classList)t.classList.remove(n);else{var r=new RegExp("(^|\\b)"+n.split(" ").join("|")+"(\\b|$)","gi");t.className=t.className.replace(r," ")}}},function(t,n,r){var e=r(45);t.exports=function(t,n){if("number"!=typeof t&&"Number"!=e(t))throw TypeError(n);return+t}},function(t,n,r){"use strict";var a=r(17),s=r(78),l=r(8);t.exports=[].copyWithin||function(t,n){var r=a(this),e=l(r.length),i=s(t,e),o=s(n,e),u=2<arguments.length?arguments[2]:void 0,c=Math.min((void 0===u?e:s(u,e))-o,e-i),f=1;for(o<i&&i<o+c&&(f=-1,o+=c-1,i+=c-1);0<c--;)o in r?r[i]=r[o]:delete r[i],i+=f,o+=f;return r}},function(t,n,r){var e=r(71);t.exports=function(t,n){var r=[];return e(t,!1,r.push,r,n),r}},function(t,n,r){var s=r(21),l=r(17),h=r(116),v=r(8);t.exports=function(t,n,r,e,i){s(n);var o=l(t),u=h(o),c=v(o.length),f=i?c-1:0,a=i?-1:1;if(r<2)for(;;){if(f in u){e=u[f],f+=a;break}if(f+=a,i?f<0:c<=f)throw TypeError("Reduce of empty array with no initial value")}for(;i?0<=f:f<c;f+=a)f in u&&(e=n(e,u[f],f,o));return e}},function(t,n,r){"use strict";var o=r(21),u=r(5),c=r(175),f=[].slice,a={};t.exports=Function.bind||function(n){var r=o(this),e=f.call(arguments,1),i=function(){var t=e.concat(f.call(arguments));return this instanceof i?function(t,n,r){if(!(n in a)){for(var e=[],i=0;i<n;i++)e[i]="a["+i+"]";a[n]=Function("F,a","return new F("+e.join(",")+")")}return a[n](t,r)}(r,t.length,t):c(r,t,n)};return u(r.prototype)&&(i.prototype=r.prototype),i}},function(t,n,r){"use strict";var u=r(11).f,c=r(72),f=r(76),a=r(47),s=r(70),l=r(71),e=r(147),i=r(178),o=r(77),h=r(10),v=r(69).fastKey,p=r(80),d=h?"_s":"size",y=function(t,n){var r,e=v(n);if("F"!==e)return t._i[e];for(r=t._f;r;r=r.n)if(r.k==n)return r};t.exports={getConstructor:function(t,o,r,e){var i=t(function(t,n){s(t,i,o,"_i"),t._t=o,t._i=c(null),t._f=void 0,t._l=void 0,t[d]=0,null!=n&&l(n,r,t[e],t)});return f(i.prototype,{clear:function(){for(var t=p(this,o),n=t._i,r=t._f;r;r=r.n)r.r=!0,r.p&&(r.p=r.p.n=void 0),delete n[r.i];t._f=t._l=void 0,t[d]=0},delete:function(t){var n=p(this,o),r=y(n,t);if(r){var e=r.n,i=r.p;delete n._i[r.i],r.r=!0,i&&(i.n=e),e&&(e.p=i),n._f==r&&(n._f=e),n._l==r&&(n._l=i),n[d]--}return!!r},forEach:function(t){p(this,o);for(var n,r=a(t,1<arguments.length?arguments[1]:void 0,3);n=n?n.n:this._f;)for(r(n.v,n.k,this);n&&n.r;)n=n.p},has:function(t){return!!y(p(this,o),t)}}),h&&u(i.prototype,"size",{get:function(){return p(this,o)[d]}}),i},def:function(t,n,r){var e,i,o=y(t,n);return o?o.v=r:(t._l=o={i:i=v(n,!0),k:n,v:r,p:e=t._l,n:void 0,r:!1},t._f||(t._f=o),e&&(e.n=o),t[d]++,"F"!==i&&(t._i[i]=o)),t},getEntry:y,setStrong:function(t,r,n){e(t,r,function(t,n){this._t=p(t,r),this._k=n,this._l=void 0},function(){for(var t=this,n=t._k,r=t._l;r&&r.r;)r=r.p;return t._t&&(t._l=r=r?r.n:t._t._f)?i(0,"keys"==n?r.k:"values"==n?r.v:[r.k,r.v]):(t._t=void 0,i(1))},n?"entries":"values",!n,!0),o(r)}}},function(t,n,r){var e=r(81),i=r(167);t.exports=function(t){return function(){if(e(this)!=t)throw TypeError(t+"#toJSON isn't generic");return i(this)}}},function(t,n,r){"use strict";var u=r(76),c=r(69).getWeak,i=r(2),f=r(5),a=r(70),s=r(71),e=r(50),l=r(30),h=r(80),o=e(5),v=e(6),p=0,d=function(t){return t._l||(t._l=new y)},y=function(){this.a=[]},g=function(t,n){return o(t.a,function(t){return t[0]===n})};y.prototype={get:function(t){var n=g(this,t);if(n)return n[1]},has:function(t){return!!g(this,t)},set:function(t,n){var r=g(this,t);r?r[1]=n:this.a.push([t,n])},delete:function(n){var t=v(this.a,function(t){return t[0]===n});return~t&&this.a.splice(t,1),!!~t}},t.exports={getConstructor:function(t,r,e,i){var o=t(function(t,n){a(t,o,r,"_i"),t._t=r,t._i=p++,t._l=void 0,null!=n&&s(n,e,t[i],t)});return u(o.prototype,{delete:function(t){if(!f(t))return!1;var n=c(t);return!0===n?d(h(this,r)).delete(t):n&&l(n,this._i)&&delete n[this._i]},has:function(t){if(!f(t))return!1;var n=c(t);return!0===n?d(h(this,r)).has(t):n&&l(n,this._i)}}),o},def:function(t,n,r){var e=c(i(n),!0);return!0===e?d(t).set(n,r):e[t._i]=r,t},ufstore:d}},function(t,n,r){"use strict";var p=r(123),d=r(5),y=r(8),g=r(47),b=r(7)("isConcatSpreadable");t.exports=function t(n,r,e,i,o,u,c,f){for(var a,s,l=o,h=0,v=!!c&&g(c,f,3);h<i;){if(h in e){if(a=v?v(e[h],h,r):e[h],s=!1,d(a)&&(s=void 0!==(s=a[b])?!!s:p(a)),s&&0<u)l=t(n,r,a,y(a.length),l,u-1)-1;else{if(9007199254740991<=l)throw TypeError();n[l]=a}l++}h++}return l}},function(t,n,r){t.exports=!r(10)&&!r(4)(function(){return 7!=Object.defineProperty(r(140)("div"),"a",{get:function(){return 7}}).a})},function(t,n){t.exports=function(t,n,r){var e=void 0===r;switch(n.length){case 0:return e?t():t.call(r);case 1:return e?t(n[0]):t.call(r,n[0]);case 2:return e?t(n[0],n[1]):t.call(r,n[0],n[1]);case 3:return e?t(n[0],n[1],n[2]):t.call(r,n[0],n[1],n[2]);case 4:return e?t(n[0],n[1],n[2],n[3]):t.call(r,n[0],n[1],n[2],n[3])}return t.apply(r,n)}},function(t,n,r){var e=r(5),i=Math.floor;t.exports=function(t){return!e(t)&&isFinite(t)&&i(t)===t}},function(t,n,r){var o=r(2);t.exports=function(t,n,r,e){try{return e?n(o(r)[0],r[1]):n(r)}catch(n){var i=t.return;throw void 0!==i&&o(i.call(t)),n}}},function(t,n){t.exports=function(t,n){return{value:n,done:!!t}}},function(t,n,r){var o=r(149),e=Math.pow,u=e(2,-52),c=e(2,-23),f=e(2,127)*(2-c),a=e(2,-126);t.exports=Math.fround||function(t){var n,r,e=Math.abs(t),i=o(t);return e<a?i*(e/a/c+1/u-1/u)*a*c:f<(r=(n=(1+c/u)*e)-(n-e))||r!=r?i*(1/0):i*r}},function(t,n){t.exports=Math.log1p||function(t){return-1e-8<(t=+t)&&t<1e-8?t-t*t/2:Math.log(1+t)}},function(t,n){t.exports=Math.scale||function(t,n,r,e,i){return 0===arguments.length||t!=t||n!=n||r!=r||e!=e||i!=i?NaN:t===1/0||t===-1/0?t:(t-n)*(i-e)/(r-n)+e}},function(t,n,r){"use strict";var h=r(10),v=r(74),p=r(127),d=r(117),y=r(17),g=r(116),i=Object.assign;t.exports=!i||r(4)(function(){var t={},n={},r=Symbol(),e="abcdefghijklmnopqrst";return t[r]=7,e.split("").forEach(function(t){n[t]=t}),7!=i({},t)[r]||Object.keys(i({},n)).join("")!=e})?function(t,n){for(var r=y(t),e=arguments.length,i=1,o=p.f,u=d.f;i<e;)for(var c,f=g(arguments[i++]),a=o?v(f).concat(o(f)):v(f),s=a.length,l=0;l<s;)c=a[l++],h&&!u.call(f,c)||(r[c]=f[c]);return r}:i},function(t,n,r){var u=r(11),c=r(2),f=r(74);t.exports=r(10)?Object.defineProperties:function(t,n){c(t);for(var r,e=f(n),i=e.length,o=0;o<i;)u.f(t,r=e[o++],n[r]);return t}},function(t,n,r){var e=r(33),i=r(73).f,o={}.toString,u="object"==typeof window&&window&&Object.getOwnPropertyNames?Object.getOwnPropertyNames(window):[];t.exports.f=function(t){return u&&"[object Window]"==o.call(t)?function(t){try{return i(t)}catch(t){return u.slice()}}(t):i(e(t))}},function(t,n,r){var u=r(30),c=r(33),f=r(120)(!1),a=r(154)("IE_PROTO");t.exports=function(t,n){var r,e=c(t),i=0,o=[];for(r in e)r!=a&&u(e,r)&&o.push(r);for(;n.length>i;)u(e,r=n[i++])&&(~f(o,r)||o.push(r));return o}},function(t,n,r){var f=r(10),a=r(74),s=r(33),l=r(117).f;t.exports=function(c){return function(t){for(var n,r=s(t),e=a(r),i=e.length,o=0,u=[];o<i;)n=e[o++],f&&!l.call(r,n)||u.push(c?[n,r[n]]:r[n]);return u}}},function(t,n,r){var e=r(73),i=r(127),o=r(2),u=r(3).Reflect;t.exports=u&&u.ownKeys||function(t){var n=e.f(o(t)),r=i.f;return r?n.concat(r(t)):n}},function(t,n,r){var e=r(3).parseFloat,i=r(84).trim;t.exports=1/e(r(157)+"-0")!=-1/0?function(t){var n=i(String(t),3),r=e(n);return 0===r&&"-"==n.charAt(0)?-0:r}:e},function(t,n,r){var e=r(3).parseInt,i=r(84).trim,o=r(157),u=/^[-+]?0[xX]/;t.exports=8!==e(o+"08")||22!==e(o+"0x16")?function(t,n){var r=i(String(t),3);return e(r,n>>>0||(u.test(r)?16:10))}:e},function(t,n){t.exports=function(t){try{return{e:!1,v:t()}}catch(t){return{e:!0,v:t}}}},function(t,n,r){var e=r(2),i=r(5),o=r(151);t.exports=function(t,n){if(e(t),i(n)&&n.constructor===t)return n;var r=o.f(t);return(0,r.resolve)(n),r.promise}},function(t,n){t.exports=Object.is||function(t,n){return t===n?0!==t||1/t==1/n:t!=t&&n!=n}},function(t,n,r){var s=r(8),l=r(156),h=r(51);t.exports=function(t,n,r,e){var i=String(h(t)),o=i.length,u=void 0===r?" ":String(r),c=s(n);if(c<=o||""==u)return i;var f=c-o,a=l.call(u,Math.ceil(f/u.length));return a.length>f&&(a=a.slice(0,f)),e?a+i:i+a}},function(t,n,r){var e=r(49),i=r(8);t.exports=function(t){if(void 0===t)return 0;var n=e(t),r=i(n);if(n!==r)throw RangeError("Wrong length!");return r}},function(t,n,r){n.f=r(7)},function(t,n,r){"use strict";var e=r(170),i=r(80);t.exports=r(121)("Map",function(t){return function(){return t(this,0<arguments.length?arguments[0]:void 0)}},{get:function(t){var n=e.getEntry(i(this,"Map"),t);return n&&n.v},set:function(t,n){return e.def(i(this,"Map"),0===t?0:t,n)}},e,!0)},function(t,n,r){"use strict";var e=r(152);r(1)({target:"RegExp",proto:!0,forced:e!==/./.exec},{exec:e})},function(t,n,r){r(10)&&"g"!=/./g.flags&&r(11).f(RegExp.prototype,"flags",{configurable:!0,get:r(115)})},function(t,n,r){"use strict";var e=r(170),i=r(80);t.exports=r(121)("Set",function(t){return function(){return t(this,0<arguments.length?arguments[0]:void 0)}},{add:function(t){return e.def(i(this,"Set"),t=0===t?0:t,t)}},e)},function(t,n,r){"use strict";var o,e=r(3),i=r(50)(0),u=r(27),c=r(69),f=r(182),a=r(172),s=r(5),l=r(80),h=r(80),v=!e.ActiveXObject&&"ActiveXObject"in e,p="WeakMap",d=c.getWeak,y=Object.isExtensible,g=a.ufstore,b=function(t){return function(){return t(this,0<arguments.length?arguments[0]:void 0)}},x={get:function(t){if(s(t)){var n=d(t);return!0===n?g(l(this,p)).get(t):n?n[this._i]:void 0}},set:function(t,n){return a.def(l(this,p),t,n)}},m=t.exports=r(121)(p,b,x,a,!0,!0);h&&v&&(f((o=a.getConstructor(b,p)).prototype,x),c.NEED=!0,i(["delete","has","get","set"],function(e){var t=m.prototype,i=t[e];u(t,e,function(t,n){if(!s(t)||y(t))return i.call(this,t,n);this._f||(this._f=new o);var r=this._f[e](t,n);return"set"==e?this:r})}))},,,,function(t,n){"use strict";t.exports={init:function(){var t=document.querySelector("#page-nav");t&&!document.querySelector("#page-nav .extend.prev")&&(t.innerHTML='<a class="extend prev disabled" rel="prev">&laquo; Prev</a>'+t.innerHTML),t&&!document.querySelector("#page-nav .extend.next")&&(t.innerHTML=t.innerHTML+'<a class="extend next disabled" rel="next">Next &raquo;</a>'),yiliaConfig&&yiliaConfig.open_in_new&&document.querySelectorAll(".article-entry a:not(.article-more-a)").forEach(function(t){var n=t.getAttribute("target");n&&""!==n||t.setAttribute("target","_blank")}),yiliaConfig&&yiliaConfig.toc_hide_index&&document.querySelectorAll(".toc-number").forEach(function(t){t.style.display="none"})}}},function(t,n,r){"use strict";function e(t){return t&&t.__esModule?t:{default:t}}function i(t,n,r,e,i){var o=function(t){for(var n=t.offsetLeft,r=t.offsetParent;null!==r;)n+=r.offsetLeft,r=r.offsetParent;return n}(t),u=function(t){for(var n=t.offsetTop,r=t.offsetParent;null!==r;)n+=r.offsetTop,r=r.offsetParent;return n}(t)-n;if(u-r<=i){var c=t.$newDom;c||(c=t.cloneNode(!0),(0,a.default)(t,c),(t.$newDom=c).style.position="fixed",c.style.top=(r||u)+"px",c.style.left=o+"px",c.style.zIndex=e||2,c.style.width="100%",c.style.color="#fff"),c.style.visibility="visible",t.style.visibility="hidden"}else{t.style.visibility="visible";var f=t.$newDom;f&&(f.style.visibility="hidden")}}function o(){var t=document.querySelector(".js-overlay"),n=document.querySelector(".js-header-menu");i(t,document.body.scrollTop,-63,2,0),i(n,document.body.scrollTop,1,3,0)}var f=e(r(163)),a=e((e(r(164)),r(414))),u=e(r(134)),c=e(r(204)),s=r(135);u.default.versions.mobile&&window.screen.width<800&&(function(){for(var t=document.querySelectorAll(".js-header-menu li a"),n=window.location.pathname,r=0,e=t.length;r<e;r++){var i=t[r];o=n,u=i.getAttribute("href"),c=/\/|index.html/g,o.replace(c,"")===u.replace(c,"")&&(0,f.default)(i,"active")}var o,u,c}(),document.querySelector("#container").addEventListener("scroll",function(t){o()}),window.addEventListener("scroll",function(t){o()}),o()),(0,s.addLoadEvent)(function(){c.default.init()}),t.exports={}},,,function(t,n,r){(function(t){"use strict";function n(t,n,r){t[n]||Object.defineProperty(t,n,{writable:!0,configurable:!0,value:r})}if(r(413),r(209),r(211),t._babelPolyfill)throw new Error("only one instance of babel-polyfill is allowed");t._babelPolyfill=!0;n(String.prototype,"padLeft","".padStart),n(String.prototype,"padRight","".padEnd),"pop,reverse,shift,keys,values,entries,indexOf,every,some,forEach,map,filter,find,findIndex,includes,join,slice,concat,push,splice,unshift,sort,lastIndexOf,reduce,reduceRight,copyWithin,fill".split(",").forEach(function(t){[][t]&&n(Array,t,Function.call.bind([][t]))})}).call(n,function(){return this}())},function(L,t){(function(t){!function(t){"use strict";function o(t,n,r,e){var o,u,c,f,i=n&&n.prototype instanceof h?n:h,a=Object.create(i.prototype),s=new p(e||[]);return a._invoke=(o=t,u=r,c=s,f=_,function(t,n){if(f===E)throw new Error("Generator is already running");if(f===M){if("throw"===t)throw n;return d()}for(c.method=t,c.arg=n;;){var r=c.delegate;if(r){var e=v(r,c);if(e){if(e===P)continue;return e}}if("next"===c.method)c.sent=c._sent=c.arg;else if("throw"===c.method){if(f===_)throw f=M,c.arg;c.dispatchException(c.arg)}else"return"===c.method&&c.abrupt("return",c.arg);f=E;var i=l(o,u,c);if("normal"===i.type){if(f=c.done?M:O,i.arg===P)continue;return{value:i.arg,done:c.done}}"throw"===i.type&&(f=M,c.method="throw",c.arg=i.arg)}}),a}function l(t,n,r){try{return{type:"normal",arg:t.call(n,r)}}catch(t){return{type:"throw",arg:t}}}function h(){}function r(){}function n(){}function e(t){["next","throw","return"].forEach(function(n){t[n]=function(t){return this._invoke(n,t)}})}function u(c){function f(t,n,r,e){var i=l(c[t],c,n);if("throw"!==i.type){var o=i.arg,u=o.value;return u&&"object"==typeof u&&y.call(u,"__await")?Promise.resolve(u.__await).then(function(t){f("next",t,r,e)},function(t){f("throw",t,r,e)}):Promise.resolve(u).then(function(t){o.value=t,r(o)},e)}e(i.arg)}var n;"object"==typeof t.process&&t.process.domain&&(f=t.process.domain.bind(f)),this._invoke=function(r,e){function t(){return new Promise(function(t,n){f(r,e,t,n)})}return n=n?n.then(t,t):t()}}function v(t,n){var r=t.iterator[n.method];if(r===a){if(n.delegate=null,"throw"===n.method){if(t.iterator.return&&(n.method="return",n.arg=a,v(t,n),"throw"===n.method))return P;n.method="throw",n.arg=new TypeError("The iterator does not provide a 'throw' method")}return P}var e=l(r,t.iterator,n.arg);if("throw"===e.type)return n.method="throw",n.arg=e.arg,n.delegate=null,P;var i=e.arg;return i?i.done?(n[t.resultName]=i.value,n.next=t.nextLoc,"return"!==n.method&&(n.method="next",n.arg=a),n.delegate=null,P):i:(n.method="throw",n.arg=new TypeError("iterator result is not an object"),n.delegate=null,P)}function i(t){var n={tryLoc:t[0]};1 in t&&(n.catchLoc=t[1]),2 in t&&(n.finallyLoc=t[2],n.afterLoc=t[3]),this.tryEntries.push(n)}function c(t){var n=t.completion||{};n.type="normal",delete n.arg,t.completion=n}function p(t){this.tryEntries=[{tryLoc:"root"}],t.forEach(i,this),this.reset(!0)}function f(n){if(n){var t=n[b];if(t)return t.call(n);if("function"==typeof n.next)return n;if(!isNaN(n.length)){var r=-1,e=function t(){for(;++r<n.length;)if(y.call(n,r))return t.value=n[r],t.done=!1,t;return t.value=a,t.done=!0,t};return e.next=e}}return{next:d}}function d(){return{value:a,done:!0}}var a,s=Object.prototype,y=s.hasOwnProperty,g="function"==typeof Symbol?Symbol:{},b=g.iterator||"@@iterator",x=g.asyncIterator||"@@asyncIterator",m=g.toStringTag||"@@toStringTag",S="object"==typeof L,w=t.regeneratorRuntime;if(w)S&&(L.exports=w);else{(w=t.regeneratorRuntime=S?L.exports:{}).wrap=o;var _="suspendedStart",O="suspendedYield",E="executing",M="completed",P={},j={};j[b]=function(){return this};var F=Object.getPrototypeOf,A=F&&F(F(f([])));A&&A!==s&&y.call(A,b)&&(j=A);var I=n.prototype=h.prototype=Object.create(j);r.prototype=I.constructor=n,n.constructor=r,n[m]=r.displayName="GeneratorFunction",w.isGeneratorFunction=function(t){var n="function"==typeof t&&t.constructor;return!!n&&(n===r||"GeneratorFunction"===(n.displayName||n.name))},w.mark=function(t){return Object.setPrototypeOf?Object.setPrototypeOf(t,n):(t.__proto__=n,m in t||(t[m]="GeneratorFunction")),t.prototype=Object.create(I),t},w.awrap=function(t){return{__await:t}},e(u.prototype),u.prototype[x]=function(){return this},w.AsyncIterator=u,w.async=function(t,n,r,e){var i=new u(o(t,n,r,e));return w.isGeneratorFunction(n)?i:i.next().then(function(t){return t.done?t.value:i.next()})},e(I),I[m]="Generator",I[b]=function(){return this},I.toString=function(){return"[object Generator]"},w.keys=function(r){var e=[];for(var t in r)e.push(t);return e.reverse(),function t(){for(;e.length;){var n=e.pop();if(n in r)return t.value=n,t.done=!1,t}return t.done=!0,t}},w.values=f,p.prototype={constructor:p,reset:function(t){if(this.prev=0,this.next=0,this.sent=this._sent=a,this.done=!1,this.delegate=null,this.method="next",this.arg=a,this.tryEntries.forEach(c),!t)for(var n in this)"t"===n.charAt(0)&&y.call(this,n)&&!isNaN(+n.slice(1))&&(this[n]=a)},stop:function(){this.done=!0;var t=this.tryEntries[0].completion;if("throw"===t.type)throw t.arg;return this.rval},dispatchException:function(r){function t(t,n){return o.type="throw",o.arg=r,e.next=t,n&&(e.method="next",e.arg=a),!!n}if(this.done)throw r;for(var e=this,n=this.tryEntries.length-1;0<=n;--n){var i=this.tryEntries[n],o=i.completion;if("root"===i.tryLoc)return t("end");if(i.tryLoc<=this.prev){var u=y.call(i,"catchLoc"),c=y.call(i,"finallyLoc");if(u&&c){if(this.prev<i.catchLoc)return t(i.catchLoc,!0);if(this.prev<i.finallyLoc)return t(i.finallyLoc)}else if(u){if(this.prev<i.catchLoc)return t(i.catchLoc,!0)}else{if(!c)throw new Error("try statement without catch or finally");if(this.prev<i.finallyLoc)return t(i.finallyLoc)}}}},abrupt:function(t,n){for(var r=this.tryEntries.length-1;0<=r;--r){var e=this.tryEntries[r];if(e.tryLoc<=this.prev&&y.call(e,"finallyLoc")&&this.prev<e.finallyLoc){var i=e;break}}i&&("break"===t||"continue"===t)&&i.tryLoc<=n&&n<=i.finallyLoc&&(i=null);var o=i?i.completion:{};return o.type=t,o.arg=n,i?(this.method="next",this.next=i.finallyLoc,P):this.complete(o)},complete:function(t,n){if("throw"===t.type)throw t.arg;return"break"===t.type||"continue"===t.type?this.next=t.arg:"return"===t.type?(this.rval=this.arg=t.arg,this.method="return",this.next="end"):"normal"===t.type&&n&&(this.next=n),P},finish:function(t){for(var n=this.tryEntries.length-1;0<=n;--n){var r=this.tryEntries[n];if(r.finallyLoc===t)return this.complete(r.completion,r.afterLoc),c(r),P}},catch:function(t){for(var n=this.tryEntries.length-1;0<=n;--n){var r=this.tryEntries[n];if(r.tryLoc===t){var e=r.completion;if("throw"===e.type){var i=e.arg;c(r)}return i}}throw new Error("illegal catch attempt")},delegateYield:function(t,n,r){return this.delegate={iterator:f(t),resultName:n,nextLoc:r},"next"===this.method&&(this.arg=a),P}}}}("object"==typeof t?t:"object"==typeof window?window:"object"==typeof self?self:this)}).call(t,function(){return this}())},,function(t,n,r){r(221),t.exports=r(46).RegExp.escape},,,,function(t,n,r){var e=r(5),i=r(123),o=r(7)("species");t.exports=function(t){var n;return i(t)&&("function"!=typeof(n=t.constructor)||n!==Array&&!i(n.prototype)||(n=void 0),e(n)&&(null===(n=n[o])&&(n=void 0))),void 0===n?Array:n}},function(t,n,r){"use strict";var e=r(4),i=Date.prototype.getTime,o=Date.prototype.toISOString,u=function(t){return 9<t?t:"0"+t};t.exports=e(function(){return"0385-07-25T07:06:39.999Z"!=o.call(new Date(-5e13-1))})||!e(function(){o.call(new Date(NaN))})?function(){if(!isFinite(i.call(this)))throw RangeError("Invalid time value");var t=this,n=t.getUTCFullYear(),r=t.getUTCMilliseconds(),e=n<0?"-":9999<n?"+":"";return e+("00000"+Math.abs(n)).slice(e?-6:-4)+"-"+u(t.getUTCMonth()+1)+"-"+u(t.getUTCDate())+"T"+u(t.getUTCHours())+":"+u(t.getUTCMinutes())+":"+u(t.getUTCSeconds())+"."+(99<r?r:"0"+u(r))+"Z"}:o},function(t,n,r){"use strict";var e=r(2),i=r(53);t.exports=function(t){if("string"!==t&&"number"!==t&&"default"!==t)throw TypeError("Incorrect hint");return i(e(this),"number"!=t)}},function(t,n,r){var c=r(74),f=r(127),a=r(117);t.exports=function(t){var n=c(t),r=f.f;if(r)for(var e,i=r(t),o=a.f,u=0;i.length>u;)o.call(t,e=i[u++])&&n.push(e);return n}},function(t,n,r){t.exports=r(118)("native-function-to-string",Function.toString)},function(t,n){t.exports=function(n,r){var e=r===Object(r)?function(t){return r[t]}:r;return function(t){return String(t).replace(n,e)}}},function(t,n,r){var e=r(1),i=r(220)(/[\\^$*+?.()|[\]{}]/g,"\\$&");e(e.S,"RegExp",{escape:function(t){return i(t)}})},function(t,n,r){var e=r(1);e(e.P,"Array",{copyWithin:r(166)}),r(67)("copyWithin")},function(t,n,r){"use strict";var e=r(1),i=r(50)(4);e(e.P+e.F*!r(48)([].every,!0),"Array",{every:function(t){return i(this,t,arguments[1])}})},function(t,n,r){var e=r(1);e(e.P,"Array",{fill:r(137)}),r(67)("fill")},function(t,n,r){"use strict";var e=r(1),i=r(50)(2);e(e.P+e.F*!r(48)([].filter,!0),"Array",{filter:function(t){return i(this,t,arguments[1])}})},function(t,n,r){"use strict";var e=r(1),i=r(50)(6),o="findIndex",u=!0;o in[]&&Array(1)[o](function(){u=!1}),e(e.P+e.F*u,"Array",{findIndex:function(t){return i(this,t,1<arguments.length?arguments[1]:void 0)}}),r(67)(o)},function(t,n,r){"use strict";var e=r(1),i=r(50)(5),o="find",u=!0;o in[]&&Array(1)[o](function(){u=!1}),e(e.P+e.F*u,"Array",{find:function(t){return i(this,t,1<arguments.length?arguments[1]:void 0)}}),r(67)(o)},function(t,n,r){"use strict";var e=r(1),i=r(50)(0),o=r(48)([].forEach,!0);e(e.P+e.F*!o,"Array",{forEach:function(t){return i(this,t,arguments[1])}})},function(t,n,r){"use strict";var h=r(47),e=r(1),v=r(17),p=r(177),d=r(145),y=r(8),g=r(139),b=r(161);e(e.S+e.F*!r(125)(function(t){Array.from(t)}),"Array",{from:function(t){var n,r,e,i,o=v(t),u="function"==typeof this?this:Array,c=arguments.length,f=1<c?arguments[1]:void 0,a=void 0!==f,s=0,l=b(o);if(a&&(f=h(f,2<c?arguments[2]:void 0,2)),null==l||u==Array&&d(l))for(r=new u(n=y(o.length));s<n;s++)g(r,s,a?f(o[s],s):o[s]);else for(i=l.call(o),r=new u;!(e=i.next()).done;s++)g(r,s,a?p(i,f,[e.value,s],!0):e.value);return r.length=s,r}})},function(t,n,r){"use strict";var e=r(1),i=r(120)(!1),o=[].indexOf,u=!!o&&1/[1].indexOf(1,-0)<0;e(e.P+e.F*(u||!r(48)(o)),"Array",{indexOf:function(t){return u?o.apply(this,arguments)||0:i(this,t,arguments[1])}})},function(t,n,r){var e=r(1);e(e.S,"Array",{isArray:r(123)})},function(t,n,r){"use strict";var e=r(1),i=r(33),o=[].join;e(e.P+e.F*(r(116)!=Object||!r(48)(o)),"Array",{join:function(t){return o.call(i(this),void 0===t?",":t)}})},function(t,n,r){"use strict";var e=r(1),i=r(33),o=r(49),u=r(8),c=[].lastIndexOf,f=!!c&&1/[1].lastIndexOf(1,-0)<0;e(e.P+e.F*(f||!r(48)(c)),"Array",{lastIndexOf:function(t){if(f)return c.apply(this,arguments)||0;var n=i(this),r=u(n.length),e=r-1;for(1<arguments.length&&(e=Math.min(e,o(arguments[1]))),e<0&&(e=r+e);0<=e;e--)if(e in n&&n[e]===t)return e||0;return-1}})},function(t,n,r){"use strict";var e=r(1),i=r(50)(1);e(e.P+e.F*!r(48)([].map,!0),"Array",{map:function(t){return i(this,t,arguments[1])}})},function(t,n,r){"use strict";var e=r(1),i=r(139);e(e.S+e.F*r(4)(function(){function t(){}return!(Array.of.call(t)instanceof t)}),"Array",{of:function(){for(var t=0,n=arguments.length,r=new("function"==typeof this?this:Array)(n);t<n;)i(r,t,arguments[t++]);return r.length=n,r}})},function(t,n,r){"use strict";var e=r(1),i=r(168);e(e.P+e.F*!r(48)([].reduceRight,!0),"Array",{reduceRight:function(t){return i(this,t,arguments.length,arguments[1],!0)}})},function(t,n,r){"use strict";var e=r(1),i=r(168);e(e.P+e.F*!r(48)([].reduce,!0),"Array",{reduce:function(t){return i(this,t,arguments.length,arguments[1],!1)}})},function(t,n,r){"use strict";var e=r(1),i=r(143),a=r(45),s=r(78),l=r(8),h=[].slice;e(e.P+e.F*r(4)(function(){i&&h.call(i)}),"Array",{slice:function(t,n){var r=l(this.length),e=a(this);if(n=void 0===n?r:n,"Array"==e)return h.call(this,t,n);for(var i=s(t,r),o=s(n,r),u=l(o-i),c=new Array(u),f=0;f<u;f++)c[f]="String"==e?this.charAt(i+f):this[i+f];return c}})},function(t,n,r){"use strict";var e=r(1),i=r(50)(3);e(e.P+e.F*!r(48)([].some,!0),"Array",{some:function(t){return i(this,t,arguments[1])}})},function(t,n,r){"use strict";var e=r(1),i=r(21),o=r(17),u=r(4),c=[].sort,f=[1,2,3];e(e.P+e.F*(u(function(){f.sort(void 0)})||!u(function(){f.sort(null)})||!r(48)(c)),"Array",{sort:function(t){return void 0===t?c.call(o(this)):c.call(o(this),i(t))}})},function(t,n,r){r(77)("Array")},function(t,n,r){var e=r(1);e(e.S,"Date",{now:function(){return(new Date).getTime()}})},function(t,n,r){var e=r(1),i=r(216);e(e.P+e.F*(Date.prototype.toISOString!==i),"Date",{toISOString:i})},function(t,n,r){"use strict";var e=r(1),i=r(17),o=r(53);e(e.P+e.F*r(4)(function(){return null!==new Date(NaN).toJSON()||1!==Date.prototype.toJSON.call({toISOString:function(){return 1}})}),"Date",{toJSON:function(t){var n=i(this),r=o(n);return"number"!=typeof r||isFinite(r)?n.toISOString():null}})},function(t,n,r){var e=r(7)("toPrimitive"),i=Date.prototype;e in i||r(26)(i,e,r(217))},function(t,n,r){var e=Date.prototype,i="Invalid Date",o="toString",u=e[o],c=e.getTime;new Date(NaN)+""!=i&&r(27)(e,o,function(){var t=c.call(this);return t==t?u.call(this):i})},function(t,n,r){var e=r(1);e(e.P,"Function",{bind:r(169)})},function(t,n,r){"use strict";var e=r(5),i=r(32),o=r(7)("hasInstance"),u=Function.prototype;o in u||r(11).f(u,o,{value:function(t){if("function"!=typeof this||!e(t))return!1;if(!e(this.prototype))return t instanceof this;for(;t=i(t);)if(this.prototype===t)return!0;return!1}})},function(t,n,r){var e=r(11).f,i=Function.prototype,o=/^\s*function ([^ (]*)/;"name"in i||r(10)&&e(i,"name",{configurable:!0,get:function(){try{return(""+this).match(o)[1]}catch(t){return""}}})},function(t,n,r){var e=r(1),i=r(180),o=Math.sqrt,u=Math.acosh;e(e.S+e.F*!(u&&710==Math.floor(u(Number.MAX_VALUE))&&u(1/0)==1/0),"Math",{acosh:function(t){return(t=+t)<1?NaN:94906265.62425156<t?Math.log(t)+Math.LN2:i(t-1+o(t-1)*o(t+1))}})},function(t,n,r){var e=r(1),i=Math.asinh;e(e.S+e.F*!(i&&0<1/i(0)),"Math",{asinh:function t(n){return isFinite(n=+n)&&0!=n?n<0?-t(-n):Math.log(n+Math.sqrt(n*n+1)):n}})},function(t,n,r){var e=r(1),i=Math.atanh;e(e.S+e.F*!(i&&1/i(-0)<0),"Math",{atanh:function(t){return 0==(t=+t)?t:Math.log((1+t)/(1-t))/2}})},function(t,n,r){var e=r(1),i=r(149);e(e.S,"Math",{cbrt:function(t){return i(t=+t)*Math.pow(Math.abs(t),1/3)}})},function(t,n,r){var e=r(1);e(e.S,"Math",{clz32:function(t){return(t>>>=0)?31-Math.floor(Math.log(t+.5)*Math.LOG2E):32}})},function(t,n,r){var e=r(1),i=Math.exp;e(e.S,"Math",{cosh:function(t){return(i(t=+t)+i(-t))/2}})},function(t,n,r){var e=r(1),i=r(148);e(e.S+e.F*(i!=Math.expm1),"Math",{expm1:i})},function(t,n,r){var e=r(1);e(e.S,"Math",{fround:r(179)})},function(t,n,r){var e=r(1),f=Math.abs;e(e.S,"Math",{hypot:function(t,n){for(var r,e,i=0,o=0,u=arguments.length,c=0;o<u;)c<(r=f(arguments[o++]))?(i=i*(e=c/r)*e+1,c=r):0<r?i+=(e=r/c)*e:i+=r;return c===1/0?1/0:c*Math.sqrt(i)}})},function(t,n,r){var e=r(1),i=Math.imul;e(e.S+e.F*r(4)(function(){return-5!=i(4294967295,5)||2!=i.length}),"Math",{imul:function(t,n){var r=65535,e=+t,i=+n,o=r&e,u=r&i;return 0|o*u+((r&e>>>16)*u+o*(r&i>>>16)<<16>>>0)}})},function(t,n,r){var e=r(1);e(e.S,"Math",{log10:function(t){return Math.log(t)*Math.LOG10E}})},function(t,n,r){var e=r(1);e(e.S,"Math",{log1p:r(180)})},function(t,n,r){var e=r(1);e(e.S,"Math",{log2:function(t){return Math.log(t)/Math.LN2}})},function(t,n,r){var e=r(1);e(e.S,"Math",{sign:r(149)})},function(t,n,r){var e=r(1),i=r(148),o=Math.exp;e(e.S+e.F*r(4)(function(){return-2e-17!=!Math.sinh(-2e-17)}),"Math",{sinh:function(t){return Math.abs(t=+t)<1?(i(t)-i(-t))/2:(o(t-1)-o(-t-1))*(Math.E/2)}})},function(t,n,r){var e=r(1),i=r(148),o=Math.exp;e(e.S,"Math",{tanh:function(t){var n=i(t=+t),r=i(-t);return n==1/0?1:r==1/0?-1:(n-r)/(o(t)+o(-t))}})},function(t,n,r){var e=r(1);e(e.S,"Math",{trunc:function(t){return(0<t?Math.floor:Math.ceil)(t)}})},function(t,n,r){"use strict";var e=r(3),i=r(30),o=r(45),u=r(144),s=r(53),c=r(4),f=r(73).f,a=r(31).f,l=r(11).f,h=r(84).trim,v="Number",p=e[v],d=p,y=p.prototype,g=o(r(72)(y))==v,b="trim"in String.prototype,x=function(t){var n=s(t,!1);if("string"==typeof n&&2<n.length){var r,e,i,o=(n=b?n.trim():h(n,3)).charCodeAt(0);if(43===o||45===o){if(88===(r=n.charCodeAt(2))||120===r)return NaN}else if(48===o){switch(n.charCodeAt(1)){case 66:case 98:e=2,i=49;break;case 79:case 111:e=8,i=55;break;default:return+n}for(var u,c=n.slice(2),f=0,a=c.length;f<a;f++)if((u=c.charCodeAt(f))<48||i<u)return NaN;return parseInt(c,e)}}return+n};if(!p(" 0o1")||!p("0b1")||p("+0x1")){p=function(t){var n=arguments.length<1?0:t,r=this;return r instanceof p&&(g?c(function(){y.valueOf.call(r)}):o(r)!=v)?u(new d(x(n)),r,p):x(n)};for(var m,S=r(10)?f(d):"MAX_VALUE,MIN_VALUE,NaN,NEGATIVE_INFINITY,POSITIVE_INFINITY,EPSILON,isFinite,isInteger,isNaN,isSafeInteger,MAX_SAFE_INTEGER,MIN_SAFE_INTEGER,parseFloat,parseInt,isInteger".split(","),w=0;S.length>w;w++)i(d,m=S[w])&&!i(p,m)&&l(p,m,a(d,m));(p.prototype=y).constructor=p,r(27)(e,v,p)}},function(t,n,r){var e=r(1);e(e.S,"Number",{EPSILON:Math.pow(2,-52)})},function(t,n,r){var e=r(1),i=r(3).isFinite;e(e.S,"Number",{isFinite:function(t){return"number"==typeof t&&i(t)}})},function(t,n,r){var e=r(1);e(e.S,"Number",{isInteger:r(176)})},function(t,n,r){var e=r(1);e(e.S,"Number",{isNaN:function(t){return t!=t}})},function(t,n,r){var e=r(1),i=r(176),o=Math.abs;e(e.S,"Number",{isSafeInteger:function(t){return i(t)&&o(t)<=9007199254740991}})},function(t,n,r){var e=r(1);e(e.S,"Number",{MAX_SAFE_INTEGER:9007199254740991})},function(t,n,r){var e=r(1);e(e.S,"Number",{MIN_SAFE_INTEGER:-9007199254740991})},function(t,n,r){var e=r(1),i=r(188);e(e.S+e.F*(Number.parseFloat!=i),"Number",{parseFloat:i})},function(t,n,r){var e=r(1),i=r(189);e(e.S+e.F*(Number.parseInt!=i),"Number",{parseInt:i})},function(t,n,r){"use strict";var e=r(1),a=r(49),s=r(165),l=r(156),i=1..toFixed,o=Math.floor,u=[0,0,0,0,0,0],h="Number.toFixed: incorrect invocation!",v=function(t,n){for(var r=-1,e=n;++r<6;)e+=t*u[r],u[r]=e%1e7,e=o(e/1e7)},p=function(t){for(var n=6,r=0;0<=--n;)r+=u[n],u[n]=o(r/t),r=r%t*1e7},d=function(){for(var t=6,n="";0<=--t;)if(""!==n||0===t||0!==u[t]){var r=String(u[t]);n=""===n?r:n+l.call("0",7-r.length)+r}return n},y=function(t,n,r){return 0===n?r:n%2==1?y(t,n-1,r*t):y(t*t,n/2,r)};e(e.P+e.F*(!!i&&("0.000"!==8e-5.toFixed(3)||"1"!==.9.toFixed(0)||"1.25"!==1.255.toFixed(2)||"1000000000000000128"!==(0xde0b6b3a7640080).toFixed(0))||!r(4)(function(){i.call({})})),"Number",{toFixed:function(t){var n,r,e,i,o=s(this,h),u=a(t),c="",f="0";if(u<0||20<u)throw RangeError(h);if(o!=o)return"NaN";if(o<=-1e21||1e21<=o)return String(o);if(o<0&&(c="-",o=-o),1e-21<o)if(r=(n=function(t){for(var n=0,r=t;4096<=r;)n+=12,r/=4096;for(;2<=r;)n+=1,r/=2;return n}(o*y(2,69,1))-69)<0?o*y(2,-n,1):o/y(2,n,1),r*=4503599627370496,0<(n=52-n)){for(v(0,r),e=u;7<=e;)v(1e7,0),e-=7;for(v(y(10,e,1),0),e=n-1;23<=e;)p(1<<23),e-=23;p(1<<e),v(1,1),p(2),f=d()}else v(0,r),v(1<<-n,0),f=d()+l.call("0",u);return f=0<u?c+((i=f.length)<=u?"0."+l.call("0",u-i)+f:f.slice(0,i-u)+"."+f.slice(i-u)):c+f}})},function(t,n,r){"use strict";var e=r(1),i=r(4),o=r(165),u=1..toPrecision;e(e.P+e.F*(i(function(){return"1"!==u.call(1,void 0)})||!i(function(){u.call({})})),"Number",{toPrecision:function(t){var n=o(this,"Number#toPrecision: incorrect invocation!");return void 0===t?u.call(n):u.call(n,t)}})},function(t,n,r){var e=r(1);e(e.S+e.F,"Object",{assign:r(182)})},function(t,n,r){var e=r(1);e(e.S,"Object",{create:r(72)})},function(t,n,r){var e=r(1);e(e.S+e.F*!r(10),"Object",{defineProperties:r(183)})},function(t,n,r){var e=r(1);e(e.S+e.F*!r(10),"Object",{defineProperty:r(11).f})},function(t,n,r){var e=r(5),i=r(69).onFreeze;r(52)("freeze",function(n){return function(t){return n&&e(t)?n(i(t)):t}})},function(t,n,r){var e=r(33),i=r(31).f;r(52)("getOwnPropertyDescriptor",function(){return function(t,n){return i(e(t),n)}})},function(t,n,r){r(52)("getOwnPropertyNames",function(){return r(184).f})},function(t,n,r){var e=r(17),i=r(32);r(52)("getPrototypeOf",function(){return function(t){return i(e(t))}})},function(t,n,r){var e=r(5);r(52)("isExtensible",function(n){return function(t){return!!e(t)&&(!n||n(t))}})},function(t,n,r){var e=r(5);r(52)("isFrozen",function(n){return function(t){return!e(t)||!!n&&n(t)}})},function(t,n,r){var e=r(5);r(52)("isSealed",function(n){return function(t){return!e(t)||!!n&&n(t)}})},function(t,n,r){var e=r(1);e(e.S,"Object",{is:r(192)})},function(t,n,r){var e=r(17),i=r(74);r(52)("keys",function(){return function(t){return i(e(t))}})},function(t,n,r){var e=r(5),i=r(69).onFreeze;r(52)("preventExtensions",function(n){return function(t){return n&&e(t)?n(i(t)):t}})},function(t,n,r){var e=r(5),i=r(69).onFreeze;r(52)("seal",function(n){return function(t){return n&&e(t)?n(i(t)):t}})},function(t,n,r){var e=r(1);e(e.S,"Object",{setPrototypeOf:r(153).set})},function(t,n,r){"use strict";var e=r(81),i={};i[r(7)("toStringTag")]="z",i+""!="[object z]"&&r(27)(Object.prototype,"toString",function(){return"[object "+e(this)+"]"},!0)},function(t,n,r){var e=r(1),i=r(188);e(e.G+e.F*(parseFloat!=i),{parseFloat:i})},function(t,n,r){var e=r(1),i=r(189);e(e.G+e.F*(parseInt!=i),{parseInt:i})},function(t,n,r){"use strict";var e,i,o,u,c=r(68),f=r(3),a=r(47),s=r(81),l=r(1),h=r(5),v=r(21),p=r(70),d=r(71),y=r(119),g=r(158).set,b=r(150)(),x=r(151),m=r(190),S=r(133),w=r(191),_="Promise",O=f.TypeError,E=f.process,M=E&&E.versions,P=M&&M.v8||"",j=f[_],F="process"==s(E),A=function(){},I=i=x.f,L=!!function(){try{var t=j.resolve(1),n=(t.constructor={})[r(7)("species")]=function(t){t(A,A)};return(F||"function"==typeof PromiseRejectionEvent)&&t.then(A)instanceof n&&0!==P.indexOf("6.6")&&-1===S.indexOf("Chrome/66")}catch(t){}}(),N=function(t){var n;return!(!h(t)||"function"!=typeof(n=t.then))&&n},T=function(s,r){if(!s._n){s._n=!0;var e=s._c;b(function(){for(var f=s._v,a=1==s._s,t=0,n=function(t){var n,r,e,i=a?t.ok:t.fail,o=t.resolve,u=t.reject,c=t.domain;try{i?(a||(2==s._h&&C(s),s._h=1),!0===i?n=f:(c&&c.enter(),n=i(f),c&&(c.exit(),e=!0)),n===t.promise?u(O("Promise-chain cycle")):(r=N(n))?r.call(n,o,u):o(n)):u(f)}catch(t){c&&!e&&c.exit(),u(t)}};e.length>t;)n(e[t++]);s._c=[],s._n=!1,r&&!s._h&&k(s)})}},k=function(o){g.call(f,function(){var t,n,r,e=o._v,i=R(o);if(i&&(t=m(function(){F?E.emit("unhandledRejection",e,o):(n=f.onunhandledrejection)?n({promise:o,reason:e}):(r=f.console)&&r.error&&r.error("Unhandled promise rejection",e)}),o._h=F||R(o)?2:1),o._a=void 0,i&&t.e)throw t.v})},R=function(t){return 1!==t._h&&0===(t._a||t._c).length},C=function(n){g.call(f,function(){var t;F?E.emit("rejectionHandled",n):(t=f.onrejectionhandled)&&t({promise:n,reason:n._v})})},D=function(t){var n=this;n._d||(n._d=!0,(n=n._w||n)._v=t,n._s=2,n._a||(n._a=n._c.slice()),T(n,!0))},G=function(t){var r,e=this;if(!e._d){e._d=!0,e=e._w||e;try{if(e===t)throw O("Promise can't be resolved itself");(r=N(t))?b(function(){var n={_w:e,_d:!1};try{r.call(t,a(G,n,1),a(D,n,1))}catch(t){D.call(n,t)}}):(e._v=t,e._s=1,T(e,!1))}catch(t){D.call({_w:e,_d:!1},t)}}};L||(j=function(t){p(this,j,_,"_h"),v(t),e.call(this);try{t(a(G,this,1),a(D,this,1))}catch(t){D.call(this,t)}},(e=function(t){this._c=[],this._a=void 0,this._s=0,this._d=!1,this._v=void 0,this._h=0,this._n=!1}).prototype=r(76)(j.prototype,{then:function(t,n){var r=I(y(this,j));return r.ok="function"!=typeof t||t,r.fail="function"==typeof n&&n,r.domain=F?E.domain:void 0,this._c.push(r),this._a&&this._a.push(r),this._s&&T(this,!1),r.promise},catch:function(t){return this.then(void 0,t)}}),o=function(){var t=new e;this.promise=t,this.resolve=a(G,t,1),this.reject=a(D,t,1)},x.f=I=function(t){return t===j||t===u?new o(t):i(t)}),l(l.G+l.W+l.F*!L,{Promise:j}),r(83)(j,_),r(77)(_),u=r(46)[_],l(l.S+l.F*!L,_,{reject:function(t){var n=I(this);return(0,n.reject)(t),n.promise}}),l(l.S+l.F*(c||!L),_,{resolve:function(t){return w(c&&this===u?j:this,t)}}),l(l.S+l.F*!(L&&r(125)(function(t){j.all(t).catch(A)})),_,{all:function(t){var u=this,n=I(u),c=n.resolve,f=n.reject,r=m(function(){var e=[],i=0,o=1;d(t,!1,function(t){var n=i++,r=!1;e.push(void 0),o++,u.resolve(t).then(function(t){r||(r=!0,e[n]=t,--o||c(e))},f)}),--o||c(e)});return r.e&&f(r.v),n.promise},race:function(t){var n=this,r=I(n),e=r.reject,i=m(function(){d(t,!1,function(t){n.resolve(t).then(r.resolve,e)})});return i.e&&e(i.v),r.promise}})},function(t,n,r){var e=r(1),o=r(21),u=r(2),c=(r(3).Reflect||{}).apply,f=Function.apply;e(e.S+e.F*!r(4)(function(){c(function(){})}),"Reflect",{apply:function(t,n,r){var e=o(t),i=u(r);return c?c(e,n,i):f.call(e,n,i)}})},function(t,n,r){var e=r(1),c=r(72),f=r(21),a=r(2),s=r(5),i=r(4),l=r(169),h=(r(3).Reflect||{}).construct,v=i(function(){function t(){}return!(h(function(){},[],t)instanceof t)}),p=!i(function(){h(function(){})});e(e.S+e.F*(v||p),"Reflect",{construct:function(t,n){f(t),a(n);var r=arguments.length<3?t:f(arguments[2]);if(p&&!v)return h(t,n,r);if(t==r){switch(n.length){case 0:return new t;case 1:return new t(n[0]);case 2:return new t(n[0],n[1]);case 3:return new t(n[0],n[1],n[2]);case 4:return new t(n[0],n[1],n[2],n[3])}var e=[null];return e.push.apply(e,n),new(l.apply(t,e))}var i=r.prototype,o=c(s(i)?i:Object.prototype),u=Function.apply.call(t,o,n);return s(u)?u:o}})},function(t,n,r){var e=r(11),i=r(1),o=r(2),u=r(53);i(i.S+i.F*r(4)(function(){Reflect.defineProperty(e.f({},1,{value:1}),1,{value:2})}),"Reflect",{defineProperty:function(t,n,r){o(t),n=u(n,!0),o(r);try{return e.f(t,n,r),!0}catch(t){return!1}}})},function(t,n,r){var e=r(1),i=r(31).f,o=r(2);e(e.S,"Reflect",{deleteProperty:function(t,n){var r=i(o(t),n);return!(r&&!r.configurable)&&delete t[n]}})},function(t,n,r){"use strict";var e=r(1),i=r(2),o=function(t){this._t=i(t),this._i=0;var n,r=this._k=[];for(n in t)r.push(n)};r(146)(o,"Object",function(){var t,n=this._k;do{if(this._i>=n.length)return{value:void 0,done:!0}}while(!((t=n[this._i++])in this._t));return{value:t,done:!1}}),e(e.S,"Reflect",{enumerate:function(t){return new o(t)}})},function(t,n,r){var e=r(31),i=r(1),o=r(2);i(i.S,"Reflect",{getOwnPropertyDescriptor:function(t,n){return e.f(o(t),n)}})},function(t,n,r){var e=r(1),i=r(32),o=r(2);e(e.S,"Reflect",{getPrototypeOf:function(t){return i(o(t))}})},function(t,n,r){var u=r(31),c=r(32),f=r(30),e=r(1),a=r(5),s=r(2);e(e.S,"Reflect",{get:function t(n,r){var e,i,o=arguments.length<3?n:arguments[2];return s(n)===o?n[r]:(e=u.f(n,r))?f(e,"value")?e.value:void 0!==e.get?e.get.call(o):void 0:a(i=c(n))?t(i,r,o):void 0}})},function(t,n,r){var e=r(1);e(e.S,"Reflect",{has:function(t,n){return n in t}})},function(t,n,r){var e=r(1),i=r(2),o=Object.isExtensible;e(e.S,"Reflect",{isExtensible:function(t){return i(t),!o||o(t)}})},function(t,n,r){var e=r(1);e(e.S,"Reflect",{ownKeys:r(187)})},function(t,n,r){var e=r(1),i=r(2),o=Object.preventExtensions;e(e.S,"Reflect",{preventExtensions:function(t){i(t);try{return o&&o(t),!0}catch(t){return!1}}})},function(t,n,r){var e=r(1),i=r(153);i&&e(e.S,"Reflect",{setPrototypeOf:function(t,n){i.check(t,n);try{return i.set(t,n),!0}catch(t){return!1}}})},function(t,n,r){var f=r(11),a=r(31),s=r(32),l=r(30),e=r(1),h=r(75),v=r(2),p=r(5);e(e.S,"Reflect",{set:function t(n,r,e){var i,o,u=arguments.length<4?n:arguments[3],c=a.f(v(n),r);if(!c){if(p(o=s(n)))return t(o,r,e,u);c=h(0)}if(l(c,"value")){if(!1===c.writable||!p(u))return!1;if(i=a.f(u,r)){if(i.get||i.set||!1===i.writable)return!1;i.value=e,f.f(u,r,i)}else f.f(u,r,h(0,e));return!0}return void 0!==c.set&&(c.set.call(u,e),!0)}})},function(t,n,r){var e=r(3),o=r(144),i=r(11).f,u=r(73).f,c=r(124),f=r(115),a=e.RegExp,s=a,l=a.prototype,h=/a/g,v=/a/g,p=new a(h)!==h;if(r(10)&&(!p||r(4)(function(){return v[r(7)("match")]=!1,a(h)!=h||a(v)==v||"/a/i"!=a(h,"i")}))){a=function(t,n){var r=this instanceof a,e=c(t),i=void 0===n;return!r&&e&&t.constructor===a&&i?t:o(p?new s(e&&!i?t.source:t,n):s((e=t instanceof a)?t.source:t,e&&i?f.call(t):n),r?this:l,a)};for(var d=function(n){n in a||i(a,n,{configurable:!0,get:function(){return s[n]},set:function(t){s[n]=t}})},y=u(s),g=0;y.length>g;)d(y[g++]);(l.constructor=a).prototype=l,r(27)(e,"RegExp",a)}r(77)("RegExp")},function(t,n,r){"use strict";var l=r(2),h=r(8),v=r(136),p=r(128);r(122)("match",1,function(e,i,a,s){return[function(t){var n=e(this),r=null==t?void 0:t[i];return void 0!==r?r.call(t,n):new RegExp(t)[i](String(n))},function(t){var n=s(a,t,this);if(n.done)return n.value;var r=l(t),e=String(this);if(!r.global)return p(r,e);for(var i,o=r.unicode,u=[],c=r.lastIndex=0;null!==(i=p(r,e));){var f=String(i[0]);""===(u[c]=f)&&(r.lastIndex=v(e,h(r.lastIndex),o)),c++}return 0===c?null:u}]})},function(t,n,r){"use strict";var O=r(2),e=r(17),E=r(8),M=r(49),P=r(136),j=r(128),F=Math.max,A=Math.min,h=Math.floor,v=/\$([$&`']|\d\d?|<[^>]*>)/g,p=/\$([$&`']|\d\d?)/g;r(122)("replace",2,function(i,o,S,w){function _(o,u,c,f,a,t){var s=c+o.length,l=f.length,n=p;return void 0!==a&&(a=e(a),n=v),S.call(t,n,function(t,n){var r;switch(n.charAt(0)){case"$":return"$";case"&":return o;case"`":return u.slice(0,c);case"'":return u.slice(s);case"<":r=a[n.slice(1,-1)];break;default:var e=+n;if(0===e)return t;if(l<e){var i=h(e/10);return 0===i?t:i<=l?void 0===f[i-1]?n.charAt(1):f[i-1]+n.charAt(1):t}r=f[e-1]}return void 0===r?"":r})}return[function(t,n){var r=i(this),e=null==t?void 0:t[o];return void 0!==e?e.call(t,r,n):S.call(String(r),t,n)},function(t,n){var r=w(S,t,this,n);if(r.done)return r.value;var e=O(t),i=String(this),o="function"==typeof n;o||(n=String(n));var u,c=e.global;if(c){var f=e.unicode;e.lastIndex=0}for(var a=[];;){var s=j(e,i);if(null===s)break;if(a.push(s),!c)break;""===String(s[0])&&(e.lastIndex=P(i,E(e.lastIndex),f))}for(var l="",h=0,v=0;v<a.length;v++){s=a[v];for(var p=String(s[0]),d=F(A(M(s.index),i.length),0),y=[],g=1;g<s.length;g++)y.push(void 0===(u=s[g])?u:String(u));var b=s.groups;if(o){var x=[p].concat(y,d,i);void 0!==b&&x.push(b);var m=String(n.apply(void 0,x))}else m=_(p,i,d,y,b,n);h<=d&&(l+=i.slice(h,d)+m,h=d+p.length)}return l+i.slice(h)}]})},function(t,n,r){"use strict";var f=r(2),a=r(192),s=r(128);r(122)("search",1,function(e,i,u,c){return[function(t){var n=e(this),r=null==t?void 0:t[i];return void 0!==r?r.call(t,n):new RegExp(t)[i](String(n))},function(t){var n=c(u,t,this);if(n.done)return n.value;var r=f(t),e=String(this),i=r.lastIndex;a(i,0)||(r.lastIndex=0);var o=s(r,e);return a(r.lastIndex,i)||(r.lastIndex=i),null===o?-1:o.index}]})},function(t,n,r){"use strict";var l=r(124),x=r(2),m=r(119),S=r(136),w=r(8),_=r(128),h=r(152),e=r(4),O=Math.min,v=[].push,u="split",p="length",d="lastIndex",E=4294967295,M=!e(function(){RegExp(E,"y")});r(122)("split",2,function(i,o,y,g){var b;return b="c"=="abbc"[u](/(b)*/)[1]||4!="test"[u](/(?:)/,-1)[p]||2!="ab"[u](/(?:ab)*/)[p]||4!="."[u](/(.?)(.?)/)[p]||1<"."[u](/()()/)[p]||""[u](/.?/)[p]?function(t,n){var r=String(this);if(void 0===t&&0===n)return[];if(!l(t))return y.call(r,t,n);for(var e,i,o,u=[],c=(t.ignoreCase?"i":"")+(t.multiline?"m":"")+(t.unicode?"u":"")+(t.sticky?"y":""),f=0,a=void 0===n?E:n>>>0,s=new RegExp(t.source,c+"g");(e=h.call(s,r))&&!(f<(i=s[d])&&(u.push(r.slice(f,e.index)),1<e[p]&&e.index<r[p]&&v.apply(u,e.slice(1)),o=e[0][p],f=i,u[p]>=a));)s[d]===e.index&&s[d]++;return f===r[p]?!o&&s.test("")||u.push(""):u.push(r.slice(f)),u[p]>a?u.slice(0,a):u}:"0"[u](void 0,0)[p]?function(t,n){return void 0===t&&0===n?[]:y.call(this,t,n)}:y,[function(t,n){var r=i(this),e=null==t?void 0:t[o];return void 0!==e?e.call(t,r,n):b.call(String(r),t,n)},function(t,n){var r=g(b,t,this,n,b!==y);if(r.done)return r.value;var e=x(t),i=String(this),o=m(e,RegExp),u=e.unicode,c=(e.ignoreCase?"i":"")+(e.multiline?"m":"")+(e.unicode?"u":"")+(M?"y":"g"),f=new o(M?e:"^(?:"+e.source+")",c),a=void 0===n?E:n>>>0;if(0===a)return[];if(0===i.length)return null===_(f,i)?[i]:[];for(var s=0,l=0,h=[];l<i.length;){f.lastIndex=M?l:0;var v,p=_(f,M?i:i.slice(l));if(null===p||(v=O(w(f.lastIndex+(M?0:l)),i.length))===s)l=S(i,l,u);else{if(h.push(i.slice(s,l)),h.length===a)return h;for(var d=1;d<=p.length-1;d++)if(h.push(p[d]),h.length===a)return h;l=s=v}}return h.push(i.slice(s)),h}]})},function(t,n,r){"use strict";r(198);var e=r(2),i=r(115),o=r(10),u="toString",c=/./[u],f=function(t){r(27)(RegExp.prototype,u,t,!0)};r(4)(function(){return"/a/b"!=c.call({source:"a",flags:"b"})})?f(function(){var t=e(this);return"/".concat(t.source,"/","flags"in t?t.flags:!o&&t instanceof RegExp?i.call(t):void 0)}):c.name!=u&&f(function(){return c.call(this)})},function(t,n,r){"use strict";r(28)("anchor",function(n){return function(t){return n(this,"a","name",t)}})},function(t,n,r){"use strict";r(28)("big",function(t){return function(){return t(this,"big","","")}})},function(t,n,r){"use strict";r(28)("blink",function(t){return function(){return t(this,"blink","","")}})},function(t,n,r){"use strict";r(28)("bold",function(t){return function(){return t(this,"b","","")}})},function(t,n,r){"use strict";var e=r(1),i=r(131)(!1);e(e.P,"String",{codePointAt:function(t){return i(this,t)}})},function(t,n,r){"use strict";var e=r(1),u=r(8),c=r(155),f="endsWith",a=""[f];e(e.P+e.F*r(142)(f),"String",{endsWith:function(t){var n=c(this,t,f),r=1<arguments.length?arguments[1]:void 0,e=u(n.length),i=void 0===r?e:Math.min(u(r),e),o=String(t);return a?a.call(n,o,i):n.slice(i-o.length,i)===o}})},function(t,n,r){"use strict";r(28)("fixed",function(t){return function(){return t(this,"tt","","")}})},function(t,n,r){"use strict";r(28)("fontcolor",function(n){return function(t){return n(this,"font","color",t)}})},function(t,n,r){"use strict";r(28)("fontsize",function(n){return function(t){return n(this,"font","size",t)}})},function(t,n,r){var e=r(1),o=r(78),u=String.fromCharCode,i=String.fromCodePoint;e(e.S+e.F*(!!i&&1!=i.length),"String",{fromCodePoint:function(t){for(var n,r=[],e=arguments.length,i=0;i<e;){if(n=+arguments[i++],o(n,1114111)!==n)throw RangeError(n+" is not a valid code point");r.push(n<65536?u(n):u(55296+((n-=65536)>>10),n%1024+56320))}return r.join("")}})},function(t,n,r){"use strict";var e=r(1),i=r(155);e(e.P+e.F*r(142)("includes"),"String",{includes:function(t){return!!~i(this,t,"includes").indexOf(t,1<arguments.length?arguments[1]:void 0)}})},function(t,n,r){"use strict";r(28)("italics",function(t){return function(){return t(this,"i","","")}})},function(t,n,r){"use strict";var e=r(131)(!0);r(147)(String,"String",function(t){this._t=String(t),this._i=0},function(){var t,n=this._t,r=this._i;return r>=n.length?{value:void 0,done:!0}:(t=e(n,r),this._i+=t.length,{value:t,done:!1})})},function(t,n,r){"use strict";r(28)("link",function(n){return function(t){return n(this,"a","href",t)}})},function(t,n,r){var e=r(1),u=r(33),c=r(8);e(e.S,"String",{raw:function(t){for(var n=u(t.raw),r=c(n.length),e=arguments.length,i=[],o=0;o<r;)i.push(String(n[o++])),o<e&&i.push(String(arguments[o]));return i.join("")}})},function(t,n,r){var e=r(1);e(e.P,"String",{repeat:r(156)})},function(t,n,r){"use strict";r(28)("small",function(t){return function(){return t(this,"small","","")}})},function(t,n,r){"use strict";var e=r(1),i=r(8),o=r(155),u="startsWith",c=""[u];e(e.P+e.F*r(142)(u),"String",{startsWith:function(t){var n=o(this,t,u),r=i(Math.min(1<arguments.length?arguments[1]:void 0,n.length)),e=String(t);return c?c.call(n,e,r):n.slice(r,r+e.length)===e}})},function(t,n,r){"use strict";r(28)("strike",function(t){return function(){return t(this,"strike","","")}})},function(t,n,r){"use strict";r(28)("sub",function(t){return function(){return t(this,"sub","","")}})},function(t,n,r){"use strict";r(28)("sup",function(t){return function(){return t(this,"sup","","")}})},function(t,n,r){"use strict";r(84)("trim",function(t){return function(){return t(this,3)}})},function(t,n,r){"use strict";var e=r(3),u=r(30),i=r(10),o=r(1),c=r(27),f=r(69).KEY,a=r(4),s=r(118),l=r(83),h=r(79),v=r(7),p=r(195),d=r(160),y=r(218),g=r(123),b=r(2),x=r(5),m=r(17),S=r(33),w=r(53),_=r(75),O=r(72),E=r(184),M=r(31),P=r(127),j=r(11),F=r(74),A=M.f,I=j.f,L=E.f,N=e.Symbol,T=e.JSON,k=T&&T.stringify,R="prototype",C=v("_hidden"),D=v("toPrimitive"),G={}.propertyIsEnumerable,W=s("symbol-registry"),U=s("symbols"),V=s("op-symbols"),B=Object[R],q="function"==typeof N&&!!P.f,z=e.QObject,K=!z||!z[R]||!z[R].findChild,H=i&&a(function(){return 7!=O(I({},"a",{get:function(){return I(this,"a",{value:7}).a}})).a})?function(t,n,r){var e=A(B,n);e&&delete B[n],I(t,n,r),e&&t!==B&&I(B,n,e)}:I,J=function(t){var n=U[t]=O(N[R]);return n._k=t,n},$=q&&"symbol"==typeof N.iterator?function(t){return"symbol"==typeof t}:function(t){return t instanceof N},Y=function(t,n,r){return t===B&&Y(V,n,r),b(t),n=w(n,!0),b(r),u(U,n)?(r.enumerable?(u(t,C)&&t[C][n]&&(t[C][n]=!1),r=O(r,{enumerable:_(0,!1)})):(u(t,C)||I(t,C,_(1,{})),t[C][n]=!0),H(t,n,r)):I(t,n,r)},X=function(t,n){b(t);for(var r,e=y(n=S(n)),i=0,o=e.length;i<o;)Y(t,r=e[i++],n[r]);return t},Q=function(t){var n=G.call(this,t=w(t,!0));return!(this===B&&u(U,t)&&!u(V,t))&&(!(n||!u(this,t)||!u(U,t)||u(this,C)&&this[C][t])||n)},Z=function(t,n){if(t=S(t),n=w(n,!0),t!==B||!u(U,n)||u(V,n)){var r=A(t,n);return!r||!u(U,n)||u(t,C)&&t[C][n]||(r.enumerable=!0),r}},tt=function(t){for(var n,r=L(S(t)),e=[],i=0;r.length>i;)u(U,n=r[i++])||n==C||n==f||e.push(n);return e},nt=function(t){for(var n,r=t===B,e=L(r?V:S(t)),i=[],o=0;e.length>o;)!u(U,n=e[o++])||r&&!u(B,n)||i.push(U[n]);return i};q||(c((N=function(){if(this instanceof N)throw TypeError("Symbol is not a constructor!");var n=h(0<arguments.length?arguments[0]:void 0),r=function(t){this===B&&r.call(V,t),u(this,C)&&u(this[C],n)&&(this[C][n]=!1),H(this,n,_(1,t))};return i&&K&&H(B,n,{configurable:!0,set:r}),J(n)})[R],"toString",function(){return this._k}),M.f=Z,j.f=Y,r(73).f=E.f=tt,r(117).f=Q,P.f=nt,i&&!r(68)&&c(B,"propertyIsEnumerable",Q,!0),p.f=function(t){return J(v(t))}),o(o.G+o.W+o.F*!q,{Symbol:N});for(var rt="hasInstance,isConcatSpreadable,iterator,match,replace,search,species,split,toPrimitive,toStringTag,unscopables".split(","),et=0;rt.length>et;)v(rt[et++]);for(var it=F(v.store),ot=0;it.length>ot;)d(it[ot++]);o(o.S+o.F*!q,"Symbol",{for:function(t){return u(W,t+="")?W[t]:W[t]=N(t)},keyFor:function(t){if(!$(t))throw TypeError(t+" is not a symbol!");for(var n in W)if(W[n]===t)return n},useSetter:function(){K=!0},useSimple:function(){K=!1}}),o(o.S+o.F*!q,"Object",{create:function(t,n){return void 0===n?O(t):X(O(t),n)},defineProperty:Y,defineProperties:X,getOwnPropertyDescriptor:Z,getOwnPropertyNames:tt,getOwnPropertySymbols:nt});var ut=a(function(){P.f(1)});o(o.S+o.F*ut,"Object",{getOwnPropertySymbols:function(t){return P.f(m(t))}}),T&&o(o.S+o.F*(!q||a(function(){var t=N();return"[null]"!=k([t])||"{}"!=k({a:t})||"{}"!=k(Object(t))})),"JSON",{stringify:function(t){for(var n,r,e=[t],i=1;arguments.length>i;)e.push(arguments[i++]);if(r=n=e[1],(x(n)||void 0!==t)&&!$(t))return g(n)||(n=function(t,n){if("function"==typeof r&&(n=r.call(this,t,n)),!$(n))return n}),e[1]=n,k.apply(T,e)}}),N[R][D]||r(26)(N[R],D,N[R].valueOf),l(N,"Symbol"),l(Math,"Math",!0),l(e.JSON,"JSON",!0)},function(t,n,r){"use strict";var e=r(1),i=r(132),o=r(159),a=r(2),s=r(78),l=r(8),u=r(5),c=r(3).ArrayBuffer,h=r(119),v=o.ArrayBuffer,p=o.DataView,f=i.ABV&&c.isView,d=v.prototype.slice,y=i.VIEW,g="ArrayBuffer";e(e.G+e.W+e.F*(c!==v),{ArrayBuffer:v}),e(e.S+e.F*!i.CONSTR,g,{isView:function(t){return f&&f(t)||u(t)&&y in t}}),e(e.P+e.U+e.F*r(4)(function(){return!new v(2).slice(1,void 0).byteLength}),g,{slice:function(t,n){if(void 0!==d&&void 0===n)return d.call(a(this),t);for(var r=a(this).byteLength,e=s(t,r),i=s(void 0===n?r:n,r),o=new(h(this,v))(l(i-e)),u=new p(this),c=new p(o),f=0;e<i;)c.setUint8(f++,u.getUint8(e++));return o}}),r(77)(g)},function(t,n,r){var e=r(1);e(e.G+e.W+e.F*!r(132).ABV,{DataView:r(159).DataView})},function(t,n,r){r(57)("Float32",4,function(e){return function(t,n,r){return e(this,t,n,r)}})},function(t,n,r){r(57)("Float64",8,function(e){return function(t,n,r){return e(this,t,n,r)}})},function(t,n,r){r(57)("Int16",2,function(e){return function(t,n,r){return e(this,t,n,r)}})},function(t,n,r){r(57)("Int32",4,function(e){return function(t,n,r){return e(this,t,n,r)}})},function(t,n,r){r(57)("Int8",1,function(e){return function(t,n,r){return e(this,t,n,r)}})},function(t,n,r){r(57)("Uint16",2,function(e){return function(t,n,r){return e(this,t,n,r)}})},function(t,n,r){r(57)("Uint32",4,function(e){return function(t,n,r){return e(this,t,n,r)}})},function(t,n,r){r(57)("Uint8",1,function(e){return function(t,n,r){return e(this,t,n,r)}})},function(t,n,r){r(57)("Uint8",1,function(e){return function(t,n,r){return e(this,t,n,r)}},!0)},function(t,n,r){"use strict";var e=r(172),i=r(80);r(121)("WeakSet",function(t){return function(){return t(this,0<arguments.length?arguments[0]:void 0)}},{add:function(t){return e.def(i(this,"WeakSet"),t,!0)}},e,!1,!0)},function(t,n,r){"use strict";var e=r(1),i=r(173),o=r(17),u=r(8),c=r(21),f=r(138);e(e.P,"Array",{flatMap:function(t){var n,r,e=o(this);return c(t),n=u(e.length),r=f(e,0),i(r,e,e,n,0,1,t,arguments[1]),r}}),r(67)("flatMap")},function(t,n,r){"use strict";var e=r(1),i=r(173),o=r(17),u=r(8),c=r(49),f=r(138);e(e.P,"Array",{flatten:function(){var t=arguments[0],n=o(this),r=u(n.length),e=f(n,0);return i(e,n,n,r,0,void 0===t?1:c(t)),e}}),r(67)("flatten")},function(t,n,r){"use strict";var e=r(1),i=r(120)(!0);e(e.P,"Array",{includes:function(t){return i(this,t,1<arguments.length?arguments[1]:void 0)}}),r(67)("includes")},function(t,n,r){var e=r(1),i=r(150)(),o=r(3).process,u="process"==r(45)(o);e(e.G,{asap:function(t){var n=u&&o.domain;i(n?n.bind(t):t)}})},function(t,n,r){var e=r(1),i=r(45);e(e.S,"Error",{isError:function(t){return"Error"===i(t)}})},function(t,n,r){var e=r(1);e(e.G,{global:r(3)})},function(t,n,r){r(129)("Map")},function(t,n,r){r(130)("Map")},function(t,n,r){var e=r(1);e(e.P+e.R,"Map",{toJSON:r(171)("Map")})},function(t,n,r){var e=r(1);e(e.S,"Math",{clamp:function(t,n,r){return Math.min(r,Math.max(n,t))}})},function(t,n,r){var e=r(1);e(e.S,"Math",{DEG_PER_RAD:Math.PI/180})},function(t,n,r){var e=r(1),i=180/Math.PI;e(e.S,"Math",{degrees:function(t){return t*i}})},function(t,n,r){var e=r(1),o=r(181),u=r(179);e(e.S,"Math",{fscale:function(t,n,r,e,i){return u(o(t,n,r,e,i))}})},function(t,n,r){var e=r(1);e(e.S,"Math",{iaddh:function(t,n,r,e){var i=t>>>0,o=r>>>0;return(n>>>0)+(e>>>0)+((i&o|(i|o)&~(i+o>>>0))>>>31)|0}})},function(t,n,r){var e=r(1);e(e.S,"Math",{imulh:function(t,n){var r=+t,e=+n,i=65535&r,o=65535&e,u=r>>16,c=e>>16,f=(u*o>>>0)+(i*o>>>16);return u*c+(f>>16)+((i*c>>>0)+(65535&f)>>16)}})},function(t,n,r){var e=r(1);e(e.S,"Math",{isubh:function(t,n,r,e){var i=t>>>0,o=r>>>0;return(n>>>0)-(e>>>0)-((~i&o|~(i^o)&i-o>>>0)>>>31)|0}})},function(t,n,r){var e=r(1);e(e.S,"Math",{RAD_PER_DEG:180/Math.PI})},function(t,n,r){var e=r(1),i=Math.PI/180;e(e.S,"Math",{radians:function(t){return t*i}})},function(t,n,r){var e=r(1);e(e.S,"Math",{scale:r(181)})},function(t,n,r){var e=r(1);e(e.S,"Math",{signbit:function(t){return(t=+t)!=t?t:0==t?1/t==1/0:0<t}})},function(t,n,r){var e=r(1);e(e.S,"Math",{umulh:function(t,n){var r=+t,e=+n,i=65535&r,o=65535&e,u=r>>>16,c=e>>>16,f=(u*o>>>0)+(i*o>>>16);return u*c+(f>>>16)+((i*c>>>0)+(65535&f)>>>16)}})},function(t,n,r){"use strict";var e=r(1),i=r(17),o=r(21),u=r(11);r(10)&&e(e.P+r(126),"Object",{__defineGetter__:function(t,n){u.f(i(this),t,{get:o(n),enumerable:!0,configurable:!0})}})},function(t,n,r){"use strict";var e=r(1),i=r(17),o=r(21),u=r(11);r(10)&&e(e.P+r(126),"Object",{__defineSetter__:function(t,n){u.f(i(this),t,{set:o(n),enumerable:!0,configurable:!0})}})},function(t,n,r){var e=r(1),i=r(186)(!0);e(e.S,"Object",{entries:function(t){return i(t)}})},function(t,n,r){var e=r(1),f=r(187),a=r(33),s=r(31),l=r(139);e(e.S,"Object",{getOwnPropertyDescriptors:function(t){for(var n,r,e=a(t),i=s.f,o=f(e),u={},c=0;o.length>c;)void 0!==(r=i(e,n=o[c++]))&&l(u,n,r);return u}})},function(t,n,r){"use strict";var e=r(1),i=r(17),o=r(53),u=r(32),c=r(31).f;r(10)&&e(e.P+r(126),"Object",{__lookupGetter__:function(t){var n,r=i(this),e=o(t,!0);do{if(n=c(r,e))return n.get}while(r=u(r))}})},function(t,n,r){"use strict";var e=r(1),i=r(17),o=r(53),u=r(32),c=r(31).f;r(10)&&e(e.P+r(126),"Object",{__lookupSetter__:function(t){var n,r=i(this),e=o(t,!0);do{if(n=c(r,e))return n.set}while(r=u(r))}})},function(t,n,r){var e=r(1),i=r(186)(!1);e(e.S,"Object",{values:function(t){return i(t)}})},function(t,n,r){"use strict";var e=r(1),o=r(3),u=r(46),i=r(150)(),c=r(7)("observable"),f=r(21),a=r(2),s=r(70),l=r(76),h=r(26),v=r(71),p=v.RETURN,d=function(t){return null==t?void 0:f(t)},y=function(t){var n=t._c;n&&(t._c=void 0,n())},g=function(t){return void 0===t._o},b=function(t){g(t)||(t._o=void 0,y(t))},x=function(t,n){a(t),this._c=void 0,this._o=t,t=new m(this);try{var r=n(t),e=r;null!=r&&("function"==typeof r.unsubscribe?r=function(){e.unsubscribe()}:f(r),this._c=r)}catch(n){return void t.error(n)}g(this)&&y(this)};x.prototype=l({},{unsubscribe:function(){b(this)}});var m=function(t){this._s=t};m.prototype=l({},{next:function(t){var n=this._s;if(!g(n)){var r=n._o;try{var e=d(r.next);if(e)return e.call(r,t)}catch(t){try{b(n)}finally{throw t}}}},error:function(t){var n=this._s;if(g(n))throw t;var r=n._o;n._o=void 0;try{var e=d(r.error);if(!e)throw t;t=e.call(r,t)}catch(t){try{y(n)}finally{throw t}}return y(n),t},complete:function(t){var n=this._s;if(!g(n)){var r=n._o;n._o=void 0;try{var e=d(r.complete);t=e?e.call(r,t):void 0}catch(t){try{y(n)}finally{throw t}}return y(n),t}}});var S=function(t){s(this,S,"Observable","_f")._f=f(t)};l(S.prototype,{subscribe:function(t){return new x(t,this._f)},forEach:function(e){var i=this;return new(u.Promise||o.Promise)(function(t,n){f(e);var r=i.subscribe({next:function(t){try{return e(t)}catch(t){n(t),r.unsubscribe()}},error:n,complete:t})})}}),l(S,{from:function(t){var n="function"==typeof this?this:S,r=d(a(t)[c]);if(r){var e=a(r.call(t));return e.constructor===n?e:new n(function(t){return e.subscribe(t)})}return new n(function(n){var r=!1;return i(function(){if(!r){try{if(v(t,!1,function(t){if(n.next(t),r)return p})===p)return}catch(t){if(r)throw t;return void n.error(t)}n.complete()}}),function(){r=!0}})},of:function(){for(var t=0,n=arguments.length,e=new Array(n);t<n;)e[t]=arguments[t++];return new("function"==typeof this?this:S)(function(n){var r=!1;return i(function(){if(!r){for(var t=0;t<e.length;++t)if(n.next(e[t]),r)return;n.complete()}}),function(){r=!0}})}}),h(S.prototype,c,function(){return this}),e(e.G,{Observable:S}),r(77)("Observable")},function(t,n,r){"use strict";var e=r(1),i=r(46),o=r(3),u=r(119),c=r(191);e(e.P+e.R,"Promise",{finally:function(n){var r=u(this,i.Promise||o.Promise),t="function"==typeof n;return this.then(t?function(t){return c(r,n()).then(function(){return t})}:n,t?function(t){return c(r,n()).then(function(){throw t})}:n)}})},function(t,n,r){"use strict";var e=r(1),i=r(151),o=r(190);e(e.S,"Promise",{try:function(t){var n=i.f(this),r=o(t);return(r.e?n.reject:n.resolve)(r.v),n.promise}})},function(t,n,r){var e=r(56),i=r(2),o=e.key,u=e.set;e.exp({defineMetadata:function(t,n,r,e){u(t,n,i(r),o(e))}})},function(t,n,r){var e=r(56),o=r(2),u=e.key,c=e.map,f=e.store;e.exp({deleteMetadata:function(t,n){var r=arguments.length<3?void 0:u(arguments[2]),e=c(o(n),r,!1);if(void 0===e||!e.delete(t))return!1;if(e.size)return!0;var i=f.get(n);return i.delete(r),!!i.size||f.delete(n)}})},function(t,n,r){var o=r(199),u=r(167),e=r(56),i=r(2),c=r(32),f=e.keys,a=e.key,s=function(t,n){var r=f(t,n),e=c(t);if(null===e)return r;var i=s(e,n);return i.length?r.length?u(new o(r.concat(i))):i:r};e.exp({getMetadataKeys:function(t){return s(i(t),arguments.length<2?void 0:a(arguments[1]))}})},function(t,n,r){var e=r(56),i=r(2),o=r(32),u=e.has,c=e.get,f=e.key,a=function(t,n,r){if(u(t,n,r))return c(t,n,r);var e=o(n);return null!==e?a(t,e,r):void 0};e.exp({getMetadata:function(t,n){return a(t,i(n),arguments.length<3?void 0:f(arguments[2]))}})},function(t,n,r){var e=r(56),i=r(2),o=e.keys,u=e.key;e.exp({getOwnMetadataKeys:function(t){return o(i(t),arguments.length<2?void 0:u(arguments[1]))}})},function(t,n,r){var e=r(56),i=r(2),o=e.get,u=e.key;e.exp({getOwnMetadata:function(t,n){return o(t,i(n),arguments.length<3?void 0:u(arguments[2]))}})},function(t,n,r){var e=r(56),i=r(2),o=r(32),u=e.has,c=e.key,f=function(t,n,r){if(u(t,n,r))return!0;var e=o(n);return null!==e&&f(t,e,r)};e.exp({hasMetadata:function(t,n){return f(t,i(n),arguments.length<3?void 0:c(arguments[2]))}})},function(t,n,r){var e=r(56),i=r(2),o=e.has,u=e.key;e.exp({hasOwnMetadata:function(t,n){return o(t,i(n),arguments.length<3?void 0:u(arguments[2]))}})},function(t,n,r){var e=r(56),i=r(2),o=r(21),u=e.key,c=e.set;e.exp({metadata:function(r,e){return function(t,n){c(r,e,(void 0!==n?i:o)(t),u(n))}}})},function(t,n,r){r(129)("Set")},function(t,n,r){r(130)("Set")},function(t,n,r){var e=r(1);e(e.P+e.R,"Set",{toJSON:r(171)("Set")})},function(t,n,r){"use strict";var e=r(1),i=r(131)(!0);e(e.P,"String",{at:function(t){return i(this,t)}})},function(t,n,r){"use strict";var e=r(1),i=r(51),o=r(8),u=r(124),c=r(115),f=RegExp.prototype,a=function(t,n){this._r=t,this._s=n};r(146)(a,"RegExp String",function(){var t=this._r.exec(this._s);return{value:t,done:null===t}}),e(e.P,"String",{matchAll:function(t){if(i(this),!u(t))throw TypeError(t+" is not a regexp!");var n=String(this),r="flags"in f?String(t.flags):c.call(t),e=new RegExp(t.source,~r.indexOf("g")?r:"g"+r);return e.lastIndex=o(t.lastIndex),new a(e,n)}})},function(t,n,r){"use strict";var e=r(1),i=r(193),o=r(133),u=/Version\/10\.\d+(\.\d+)?( Mobile\/\w+)? Safari\//.test(o);e(e.P+e.F*u,"String",{padEnd:function(t){return i(this,t,1<arguments.length?arguments[1]:void 0,!1)}})},function(t,n,r){"use strict";var e=r(1),i=r(193),o=r(133),u=/Version\/10\.\d+(\.\d+)?( Mobile\/\w+)? Safari\//.test(o);e(e.P+e.F*u,"String",{padStart:function(t){return i(this,t,1<arguments.length?arguments[1]:void 0,!0)}})},function(t,n,r){"use strict";r(84)("trimLeft",function(t){return function(){return t(this,1)}},"trimStart")},function(t,n,r){"use strict";r(84)("trimRight",function(t){return function(){return t(this,2)}},"trimEnd")},function(t,n,r){r(160)("asyncIterator")},function(t,n,r){r(160)("observable")},function(t,n,r){var e=r(1);e(e.S,"System",{global:r(3)})},function(t,n,r){r(129)("WeakMap")},function(t,n,r){r(130)("WeakMap")},function(t,n,r){r(129)("WeakSet")},function(t,n,r){r(130)("WeakSet")},function(t,n,r){for(var e=r(162),i=r(74),o=r(27),u=r(3),c=r(26),f=r(82),a=r(7),s=a("iterator"),l=a("toStringTag"),h=f.Array,v={CSSRuleList:!0,CSSStyleDeclaration:!1,CSSValueList:!1,ClientRectList:!1,DOMRectList:!1,DOMStringList:!1,DOMTokenList:!0,DataTransferItemList:!1,FileList:!1,HTMLAllCollection:!1,HTMLCollection:!1,HTMLFormElement:!1,HTMLSelectElement:!1,MediaList:!0,MimeTypeArray:!1,NamedNodeMap:!1,NodeList:!0,PaintRequestList:!1,Plugin:!1,PluginArray:!1,SVGLengthList:!1,SVGNumberList:!1,SVGPathSegList:!1,SVGPointList:!1,SVGStringList:!1,SVGTransformList:!1,SourceBufferList:!1,StyleSheetList:!0,TextTrackCueList:!1,TextTrackList:!1,TouchList:!1},p=i(v),d=0;d<p.length;d++){var y,g=p[d],b=v[g],x=u[g],m=x&&x.prototype;if(m&&(m[s]||c(m,s,h),m[l]||c(m,l,g),f[g]=h,b))for(y in e)m[y]||o(m,y,e[y],!0)}},function(t,n,r){var e=r(1),i=r(158);e(e.G+e.B,{setImmediate:i.set,clearImmediate:i.clear})},function(t,n,r){var e=r(3),i=r(1),o=r(133),u=[].slice,c=/MSIE .\./.test(o),f=function(i){return function(t,n){var r=2<arguments.length,e=!!r&&u.call(arguments,2);return i(r?function(){("function"==typeof t?t:Function(t)).apply(this,e)}:t,n)}};i(i.G+i.B+i.F*c,{setTimeout:f(e.setTimeout),setInterval:f(e.setInterval)})},function(t,n,r){r(341),r(280),r(282),r(281),r(284),r(286),r(291),r(285),r(283),r(293),r(292),r(288),r(289),r(287),r(279),r(290),r(294),r(295),r(247),r(249),r(248),r(297),r(296),r(267),r(277),r(278),r(268),r(269),r(270),r(271),r(272),r(273),r(274),r(275),r(276),r(250),r(251),r(252),r(253),r(254),r(255),r(256),r(257),r(258),r(259),r(260),r(261),r(262),r(263),r(264),r(265),r(266),r(328),r(333),r(340),r(331),r(323),r(324),r(329),r(334),r(336),r(319),r(320),r(321),r(322),r(325),r(326),r(327),r(330),r(332),r(335),r(337),r(338),r(339),r(242),r(244),r(243),r(246),r(245),r(231),r(229),r(235),r(232),r(238),r(240),r(228),r(234),r(225),r(239),r(223),r(237),r(236),r(230),r(233),r(222),r(224),r(227),r(226),r(241),r(162),r(313),r(197),r(318),r(198),r(314),r(315),r(316),r(317),r(298),r(196),r(199),r(200),r(353),r(342),r(343),r(348),r(351),r(352),r(346),r(349),r(347),r(350),r(344),r(345),r(299),r(300),r(301),r(302),r(303),r(306),r(304),r(305),r(307),r(308),r(309),r(310),r(312),r(311),r(356),r(354),r(355),r(397),r(400),r(399),r(401),r(402),r(398),r(403),r(404),r(378),r(381),r(377),r(375),r(376),r(379),r(380),r(362),r(396),r(361),r(395),r(407),r(409),r(360),r(394),r(406),r(408),r(359),r(405),r(358),r(363),r(364),r(365),r(366),r(367),r(369),r(368),r(370),r(371),r(372),r(374),r(373),r(383),r(384),r(385),r(386),r(388),r(387),r(390),r(389),r(391),r(392),r(393),r(357),r(382),r(412),r(411),r(410),t.exports=r(46)},function(t,n){t.exports=function(t,n){if("string"==typeof n)return t.insertAdjacentHTML("afterend",n);var r=t.nextSibling;return r?t.parentNode.insertBefore(n,r):t.parentNode.appendChild(n)}}])</script><script src="/./main.a5fda8.js"></script><script>!function(){var e,t;e="/slider.27463f.js",t=document.createElement("script"),document.getElementsByTagName("body")[0].appendChild(t),t.setAttribute("src",e)}()</script>



<!--  -->

<script>
  /* 标签页标题切换 */
  var originTitle = document.title;
  var titleTime;
  document.addEventListener("visibilitychange", function () {
    if (document.hidden) {
      document.title = "(つェ⊂) 我藏好了哦~ " + originTitle;
      clearTimeout(titleTime);
    } else {
      document.title = "(*´∇｀*) 被你发现啦~ " + originTitle;
      titleTime = setTimeout(function () {
        document.title = originTitle;
      }, 2000);
    }
  });
</script>


    
<div class="tools-col" q-class="show:isShow,hide:isShow|isFalse" q-on="click:stop(e)">
  <div class="tools-nav header-menu">
    
    
      
      
      
    
      
      
      
    
      
      
      
    
    

    <ul style="width: 70%">
    
    
      
      <li style="width: 33.333333333333336%" q-on="click: openSlider(e, 'innerArchive')"><a href="javascript:void(0)" q-class="active:innerArchive">所有文章</a></li>
      
        
      
      <li style="width: 33.333333333333336%" q-on="click: openSlider(e, 'friends')"><a href="javascript:void(0)" q-class="active:friends">友链</a></li>
      
        
      
      <li style="width: 33.333333333333336%" q-on="click: openSlider(e, 'aboutme')"><a href="javascript:void(0)" q-class="active:aboutme">关于我</a></li>
      
        
    </ul>
  </div>
  <div class="tools-wrap">
    
    	<section class="tools-section tools-section-all" q-show="innerArchive">
        <div class="search-wrap">
          <input class="search-ipt" q-model="search" type="text" placeholder="find something…">
          <i class="icon-search icon" q-show="search|isEmptyStr"></i>
          <i class="icon-close icon" q-show="search|isNotEmptyStr" q-on="click:clearChose(e)"></i>
        </div>
        <div class="widget tagcloud search-tag">
          <p class="search-tag-wording">tag:</p>
          <label class="search-switch">
            <input type="checkbox" q-on="click:toggleTag(e)" q-attr="checked:showTags">
          </label>
          <ul class="article-tag-list" q-show="showTags">
            
            <div class="clearfix"></div>
          </ul>
        </div>
        <ul class="search-ul">
          <p q-show="jsonFail" style="padding: 20px; font-size: 12px;">
            缺失模块。<br/>1、请确保node版本大于6.2<br/>2、在博客根目录（注意不是yilia-plus根目录）执行以下命令：<br/> npm i hexo-generator-json-content --save<br/><br/>
            3、在根目录_config.yml里添加配置：
<pre style="font-size: 12px;" q-show="jsonFail">
  jsonContent:
    meta: false
    pages: false
    posts:
      title: true
      date: true
      path: true
      text: false
      raw: false
      content: false
      slug: false
      updated: false
      comments: false
      link: false
      permalink: false
      excerpt: false
      categories: false
      tags: true
</pre>
          </p>
          <li class="search-li" q-repeat="items" q-show="isShow">
            <a q-attr="href:path|urlformat" class="search-title"><i class="icon-quo-left icon"></i><span q-text="title"></span></a>
            <p class="search-time">
              <i class="icon-calendar icon"></i>
              <span q-text="date|dateformat"></span>
            </p>
            <p class="search-tag">
              <i class="icon-price-tags icon"></i>
              <span q-repeat="tags" q-on="click:choseTag(e, name)" q-text="name|tagformat"></span>
            </p>
          </li>
        </ul>
    	</section>
    

    
    	<section class="tools-section tools-section-friends" q-show="friends">
  		
        <ul class="search-ul">
          
            <li class="search-li">
              <a href="https://github.com/NepenthesZGW" target="_blank" class="search-title" title="记录工作和学习过程中的笔记：Java、前端开发、Hexo博客、聚合支付、Linux笔记、ElasticSearch、ELK日志分析">
                
                  <img src="https://github.com/NepenthesZGW/favicon.ico">
                
                技术笔记
              </a>
            </li>
          
            <li class="search-li">
              <a href="https://github.com/NepenthesZGW" target="_blank" class="search-title" >
                
                  <i class="icon-link icon"></i>
                
                GitHub
              </a>
            </li>
          
            <li class="search-li">
              <a href="https://github.com/NepenthesZGW" target="_blank" class="search-title" >
                
                  <i class="icon-link icon"></i>
                
                码云
              </a>
            </li>
          
            <li class="search-li">
              <a href="https://github.com/NepenthesZGW" target="_blank" class="search-title" >
                
                  <i class="icon-link icon"></i>
                
                简书
              </a>
            </li>
          
            <li class="search-li">
              <a href="https://github.com/NepenthesZGW" target="_blank" class="search-title" >
                
                  <i class="icon-link icon"></i>
                
                CSDN
              </a>
            </li>
          
        </ul>
  		
    	</section>
    

    
    	<section class="tools-section tools-section-me" q-show="aboutme">
        
          
  	  		<div class="aboutme-wrap" id="aboutme">主要涉及技术：<br>Java后端开发 <br>开源爱好者、Linux<br><br>联系QQ:2960571342<br><br>很惭愧<br><br>只做了一点微小的工作<br>谢谢大家</div>
  	  	
    	</section>
    
  </div>
  
</div>
    <!-- Root element of PhotoSwipe. Must have class pswp. -->
<div class="pswp" tabindex="-1" role="dialog" aria-hidden="true">

    <!-- Background of PhotoSwipe. 
         It's a separate element as animating opacity is faster than rgba(). -->
    <div class="pswp__bg"></div>

    <!-- Slides wrapper with overflow:hidden. -->
    <div class="pswp__scroll-wrap">

        <!-- Container that holds slides. 
            PhotoSwipe keeps only 3 of them in the DOM to save memory.
            Don't modify these 3 pswp__item elements, data is added later on. -->
        <div class="pswp__container">
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
        </div>

        <!-- Default (PhotoSwipeUI_Default) interface on top of sliding area. Can be changed. -->
        <div class="pswp__ui pswp__ui--hidden">

            <div class="pswp__top-bar">

                <!--  Controls are self-explanatory. Order can be changed. -->

                <div class="pswp__counter"></div>

                <button class="pswp__button pswp__button--close" title="Close (Esc)"></button>

                <button class="pswp__button pswp__button--share" style="display:none" title="Share"></button>

                <button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>

                <button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>

                <!-- Preloader demo http://codepen.io/dimsemenov/pen/yyBWoR -->
                <!-- element will get class pswp__preloader--active when preloader is running -->
                <div class="pswp__preloader">
                    <div class="pswp__preloader__icn">
                      <div class="pswp__preloader__cut">
                        <div class="pswp__preloader__donut"></div>
                      </div>
                    </div>
                </div>
            </div>

            <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
                <div class="pswp__share-tooltip"></div> 
            </div>

            <button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
            </button>

            <button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)">
            </button>

            <div class="pswp__caption">
                <div class="pswp__caption__center"></div>
            </div>

        </div>

    </div>

</div>
  </div>

  
  
<script type="text/javascript" src="/plugins/activate-power-mode/activate-power-mode.js"></script>
<script>
  POWERMODE.colorful = true; // make power mode colorful
  POWERMODE.shake = false; // turn off shake
  document.body.addEventListener('input', POWERMODE);
</script>

  
  <!-- <script async type="text/javascript" size="90" alpha="0.2" zIndex="0" src="/plugins/ribbon.js/ribbon.min.js"></script> -->
  
  
  
  <script type="text/javascript" src="/lib/snow.js"></script>
  <script type="text/javascript" src="/lib/jquery-2.1.4.min.js"></script>
  <script>
    snow.down();
    $(window).resize(function() {
      $("canvas").css("z-index","500").remove();
      snow.down();
    });
  </script>
  
</body>

</html>
